<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI Steno - Bank of Baroda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-btn.active { background-color: #1e293b; color: white; border-left: 4px solid #3b82f6; }
        .tab-btn-mob.active { color: #3b82f6; font-weight: bold; border-bottom: 3px solid #3b82f6; }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        
        .client-updates-scroll::-webkit-scrollbar { width: 4px; }
        .client-updates-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

        /* Naya CSS - Notebook page ko real diary jaisa look dene ke liye */
        .notebook-page {
            background-image: repeating-linear-gradient(transparent, transparent 27px, #e5e7eb 27px, #e5e7eb 28px);
            line-height: 28px;
            padding-top: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-[100dvh] overflow-hidden flex flex-col">

    <div id="login-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="p-8 bg-white rounded-2xl shadow-2xl text-center max-w-sm w-full border border-gray-100">
            <h1 class="text-3xl font-extrabold mb-2 text-slate-800">My AI Steno</h1>
            <p class="text-gray-500 mb-8 text-sm">Your Smart Case Manager</p>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="pin-screen" class="hidden absolute inset-0 z-50 flex-col items-center justify-center bg-slate-900 text-white">
        <h2 class="text-2xl mb-6 font-semibold">Enter Security PIN</h2>
        <input type="password" id="pin-input" maxlength="4" class="bg-slate-800 border-2 border-slate-700 p-4 text-center text-4xl tracking-[0.5em] text-white rounded-xl mb-6 w-56 outline-none focus:border-blue-500 transition-colors" />
        <button id="verify-pin-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-3 rounded-xl shadow-lg font-medium transition-all">Unlock</button>
    </div>

    <div id="api-key-screen" class="hidden absolute inset-0 z-50 flex-col items-center justify-center bg-white px-4">
        <h2 class="text-2xl mb-2 font-bold text-slate-800">API Key Setup</h2>
        <p class="text-gray-500 mb-6 text-center max-w-sm text-sm">Please provide your OpenAI API Key securely.</p>
        <input type="password" id="api-key-input" class="border-2 border-gray-300 p-3 rounded-xl mb-4 w-full max-w-md outline-none focus:border-blue-500" placeholder="sk-proj-..." />
        <button id="save-key-btn" class="bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-xl font-medium w-full max-w-md transition-all">Save Securely</button>
    </div>

    <div id="app-layout" class="hidden flex-1 flex-col md:flex-row w-full h-full bg-white relative">
        
        <nav class="hidden md:flex flex-col w-64 bg-slate-900 text-slate-300 shadow-2xl z-20">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-2xl font-bold text-white tracking-wide">My AI Steno</h1>
            </div>
            <div class="flex-1 py-4 flex flex-col gap-1 px-3">
                <button id="tab-chat-desk" class="tab-btn active px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">üí¨ Chat</button>
                <button id="tab-notes-desk" class="tab-btn px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">üìÇ Client Cases</button>
                <button id="tab-tasks-desk" class="tab-btn px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">‚úÖ Tasks</button>
                <button id="tab-reminders-desk" class="tab-btn px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">‚è∞ Reminders</button>
                <button id="tab-notebook-desk" class="tab-btn px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">üìì Notebook</button>
            </div>
            <div class="p-4 border-t border-slate-800">
                <button id="logout-btn-desk" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-500 px-4 py-2 rounded-lg font-medium transition-colors text-sm">Log Out</button>
            </div>
        </nav>

        <main class="flex-1 relative bg-gray-50 flex flex-col h-full overflow-hidden">
            <header class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-10">
                <h1 class="text-lg font-bold">My AI Steno</h1>
                <button id="logout-btn-mob" class="text-xs bg-slate-800 px-3 py-1.5 rounded text-slate-300">Logout</button>
            </header>

            <div id="view-chat" class="absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 flex flex-col scroll-smooth"></div>
                <div class="p-3 md:p-4 bg-white border-t border-gray-200 shadow-[0_-4px_15px_rgba(0,0,0,0.02)] z-10">
                    <div class="max-w-4xl mx-auto flex gap-2 items-center">
                        <button id="mic-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-3 md:p-4 rounded-xl transition-all outline-none" title="Click to Speak">üé§</button>
                        <input type="text" id="user-input" class="flex-1 bg-gray-100 border-transparent focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-3 md:p-4 rounded-xl text-black outline-none transition-all" placeholder="Ask AI, add a task, reminder, or draft a note..." />
                        <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-medium shadow-md transition-transform active:scale-95">Send</button>
                    </div>
                </div>
            </div>

            <div id="view-notes" class="hidden absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex-col bg-gray-50 p-4 md:p-8 overflow-y-auto">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl font-bold mb-2 text-slate-800">Client Cases & Notes</h2>
                    <p class="text-gray-500 mb-8 text-sm">Organized history of all your clients and updates.</p>
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
            </div>

            <div id="view-tasks" class="hidden absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex-col bg-gray-50 p-4 md:p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full">
                    <h2 class="text-3xl font-bold mb-2 text-slate-800">My Tasks</h2>
                    <p class="text-gray-500 mb-8 text-sm">Your to-do list managed by AI.</p>
                    <div id="tasks-list" class="flex flex-col gap-3"></div>
                </div>
            </div>

            <div id="view-reminders" class="hidden absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex-col bg-gray-50 p-4 md:p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full">
                    <h2 class="text-3xl font-bold mb-2 text-slate-800">Reminders</h2>
                    <p class="text-gray-500 mb-8 text-sm">Upcoming events and alerts.</p>
                    <div id="reminders-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <div id="view-notebook" class="hidden absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex-col bg-gray-50 p-4 md:p-8 overflow-y-auto">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl font-bold mb-2 text-slate-800">My Notebook</h2>
                    <p class="text-gray-500 mb-8 text-sm">Properly drafted documents, meetings, and detailed notes.</p>
                    <div id="notebook-grid" class="grid grid-cols-1 xl:grid-cols-2 gap-8"></div>
                </div>
            </div>

        </main>

        <nav class="md:hidden absolute bottom-0 w-full bg-white border-t border-gray-200 flex items-center h-[60px] shadow-[0_-5px_10px_rgba(0,0,0,0.02)] z-20 overflow-x-auto whitespace-nowrap px-2">
            <button id="tab-chat-mob" class="tab-btn-mob active min-w-[70px] flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-[10px]">üí¨ Chat</button>
            <button id="tab-notes-mob" class="tab-btn-mob min-w-[70px] flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-[10px]">üìÇ Cases</button>
            <button id="tab-tasks-mob" class="tab-btn-mob min-w-[70px] flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-[10px]">‚úÖ Tasks</button>
            <button id="tab-reminders-mob" class="tab-btn-mob min-w-[70px] flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-[10px]">‚è∞ Reminds</button>
            <button id="tab-notebook-mob" class="tab-btn-mob min-w-[70px] flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-[10px]">üìì Notes</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithRedirect, signInWithPopup, getRedirectResult, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733",
            storageBucket: "ai-assistant-app-8e733.firebasestorage.app",
            messagingSenderId: "318215944760",
            appId: "1:318215944760:web:2a387b7bcd068da4ff44cd"
        };
        const SECRET_PIN = "5786"; 
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let chatHistory = [];
        let allSavedNotes = []; 
        let allTasks = [];
        let allReminders = [];
        let allNotebooks = [];

        let isPinVerified = false;
        let DYNAMIC_OPENAI_KEY = ""; 
        let sessionStartTime;

        const ui = {
            login: document.getElementById('login-screen'),
            pin: document.getElementById('pin-screen'),
            apiKey: document.getElementById('api-key-screen'),
            appLayout: document.getElementById('app-layout'),
            viewChat: document.getElementById('view-chat'),
            viewNotes: document.getElementById('view-notes'),
            viewTasks: document.getElementById('view-tasks'),
            viewReminders: document.getElementById('view-reminders'),
            viewNotebook: document.getElementById('view-notebook'),
            chatBox: document.getElementById('chat-box'),
            notesGrid: document.getElementById('notes-grid'),
            tasksList: document.getElementById('tasks-list'),
            remindersList: document.getElementById('reminders-list'),
            notebookGrid: document.getElementById('notebook-grid'),
            userInput: document.getElementById('user-input'),
            micBtn: document.getElementById('mic-btn')
        };

        const views = ['chat', 'notes', 'tasks', 'reminders', 'notebook'];

        function hideAllStates() {
            ui.login.classList.add('hidden'); ui.pin.classList.add('hidden');
            ui.apiKey.classList.add('hidden'); ui.appLayout.classList.add('hidden');
        }

        function switchView(targetView) {
            views.forEach(v => {
                const deskBtn = document.getElementById(`tab-${v}-desk`);
                const mobBtn = document.getElementById(`tab-${v}-mob`);
                const viewEl = document.getElementById(`view-${v}`);
                
                if(v === targetView) {
                    viewEl.classList.remove('hidden'); viewEl.classList.add('flex');
                    if(deskBtn) deskBtn.classList.add('active');
                    if(mobBtn) mobBtn.classList.add('active');
                } else {
                    viewEl.classList.add('hidden'); viewEl.classList.remove('flex');
                    if(deskBtn) deskBtn.classList.remove('active');
                    if(mobBtn) mobBtn.classList.remove('active');
                }
            });
            if(targetView === 'chat') ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
        }

        views.forEach(v => {
            document.getElementById(`tab-${v}-desk`)?.addEventListener('click', () => switchView(v));
            document.getElementById(`tab-${v}-mob`)?.addEventListener('click', () => switchView(v));
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            document.getElementById('login-btn').innerText = "Signing in...";
            try { await signInWithPopup(auth, provider); } 
            catch (error) { await signInWithRedirect(auth, provider); }
        });

        onAuthStateChanged(auth, (user) => {
            hideAllStates();
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    if (!isPinVerified) { ui.pin.classList.remove('hidden'); ui.pin.classList.add('flex'); } 
                    else { checkAndLoadApp(); }
                } else { alert("Unauthorized access!"); signOut(auth); }
            } else { ui.login.classList.remove('hidden'); }
        });

        const doLogout = () => { isPinVerified = false; DYNAMIC_OPENAI_KEY = ""; signOut(auth); };
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if (document.getElementById('pin-input').value === SECRET_PIN) {
                isPinVerified = true; checkAndLoadApp();
            } else { alert("Incorrect PIN"); document.getElementById('pin-input').value = ""; }
        });

        async function checkAndLoadApp() {
            hideAllStates();
            try {
                const keyDoc = await getDoc(doc(db, "system_settings", "api_config"));
                if (keyDoc.exists() && keyDoc.data().openai_key) {
                    DYNAMIC_OPENAI_KEY = keyDoc.data().openai_key;
                    sessionStartTime = new Date().toISOString(); 
                    ui.appLayout.classList.remove('hidden'); ui.appLayout.classList.add('flex');
                    loadAppListeners();
                } else { ui.apiKey.classList.remove('hidden'); ui.apiKey.classList.add('flex'); }
            } catch (error) { alert("Database connection failed."); }
        }

        document.getElementById('save-key-btn').addEventListener('click', async () => {
            const newKey = document.getElementById('api-key-input').value.trim();
            if (!newKey.startsWith("sk-")) return alert("Invalid API key.");
            try {
                await setDoc(doc(db, "system_settings", "api_config"), { openai_key: newKey });
                DYNAMIC_OPENAI_KEY = newKey;
                sessionStartTime = new Date().toISOString();
                ui.appLayout.classList.remove('hidden'); ui.appLayout.classList.add('flex');
                ui.apiKey.classList.add('hidden'); loadAppListeners();
            } catch (error) { alert("Failed to save key."); }
        });

        function loadAppListeners() {
            const chatQuery = query(collection(db, "chats"), where("timestamp", ">=", sessionStartTime), orderBy("timestamp", "asc"));
            onSnapshot(chatQuery, (snapshot) => {
                chatHistory = []; ui.chatBox.innerHTML = ""; 
                snapshot.forEach((docData) => {
                    const msg = docData.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            });

            onSnapshot(query(collection(db, "notes"), orderBy("timestamp", "asc")), (snapshot) => {
                ui.notesGrid.innerHTML = ""; allSavedNotes = []; let groupedNotes = {}; 
                snapshot.forEach((docData) => {
                    const note = docData.data(); allSavedNotes.push(note); 
                    const normalizedTitle = note.title.toUpperCase();
                    if(!groupedNotes[normalizedTitle]) groupedNotes[normalizedTitle] = { displayTitle: note.title, updates: [] };
                    groupedNotes[normalizedTitle].updates.push(note);
                });

                for (const key in groupedNotes) {
                    const group = groupedNotes[key];
                    const card = document.createElement('div');
                    card.className = "bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col hover:shadow-md h-64 relative";
                    let updatesHTML = group.updates.reverse().map(u => `
                        <div class="border-l-2 border-blue-400 pl-3 py-2 relative">
                            <div class="absolute w-2 h-2 bg-blue-400 rounded-full -left-[5px] top-3.5"></div>
                            <p class="text-gray-700 text-sm whitespace-pre-wrap">${u.content}</p>
                        </div>
                    `).join("");
                    card.innerHTML = `<h3 class="font-bold text-slate-800 text-lg border-b pb-3 mb-2">${group.displayTitle}</h3><div class="overflow-y-auto client-updates-scroll">${updatesHTML}</div>`;
                    ui.notesGrid.appendChild(card);
                }
            });

            onSnapshot(query(collection(db, "tasks"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.tasksList.innerHTML = ""; allTasks = [];
                snapshot.forEach((docData) => {
                    const task = docData.data(); allTasks.push(task);
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4";
                    div.innerHTML = `<input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 cursor-pointer">
                                     <span class="flex-1 text-gray-800 font-medium">${task.title}</span>
                                     <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">${task.status}</span>`;
                    ui.tasksList.appendChild(div);
                });
            });

            onSnapshot(query(collection(db, "reminders"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.remindersList.innerHTML = ""; allReminders = [];
                snapshot.forEach((docData) => {
                    const rem = docData.data(); allReminders.push(rem);
                    const div = document.createElement('div');
                    div.className = "bg-red-50 border border-red-100 p-4 rounded-xl shadow-sm flex flex-col gap-1";
                    div.innerHTML = `<span class="text-red-600 font-bold text-sm">‚è∞ ${rem.time}</span>
                                     <span class="text-gray-800 font-medium">${rem.title}</span>`;
                    ui.remindersList.appendChild(div);
                });
            });

            // UPDATED NOTEBOOK LISTENER - Beautiful Human-like Format
            onSnapshot(query(collection(db, "notebooks"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.notebookGrid.innerHTML = ""; allNotebooks = [];
                snapshot.forEach((docData) => {
                    const page = docData.data(); allNotebooks.push(page);
                    
                    // Format date nicely
                    const dateObj = new Date(page.timestamp);
                    const formattedDate = dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });

                    const card = document.createElement('div');
                    // Real Notebook Diary CSS styling
                    card.className = "bg-white p-6 md:p-8 rounded-xl shadow-sm border border-gray-200 border-l-8 border-l-yellow-400 relative";
                    
                    card.innerHTML = `
                        <div class="border-b-2 border-gray-200 pb-3 mb-4 flex justify-between items-end">
                            <h3 class="font-bold text-gray-800 text-xl tracking-wide">${page.title}</h3>
                            <span class="text-[11px] text-gray-400 font-semibold tracking-wider uppercase">${formattedDate}</span>
                        </div>
                        <div class="text-gray-700 text-[15px] notebook-page whitespace-pre-wrap">
                            ${page.content}
                        </div>
                    `;
                    ui.notebookGrid.appendChild(card);
                });
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-2xl max-w-[85%] md:max-w-[75%] text-sm md:text-base leading-relaxed ${
                role === 'user' ? 'bg-blue-600 text-white rounded-br-sm shadow-md' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-sm shadow-sm'
            }`;
            bubble.textContent = content;
            div.appendChild(bubble);
            ui.chatBox.appendChild(div);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';

            recognition.onstart = () => { isRecording = true; ui.micBtn.classList.add('recording'); ui.userInput.placeholder = "Listening..."; };
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) ui.userInput.value += event.results[i][0].transcript + ' ';
                    else interimTranscript += event.results[i][0].transcript;
                }
            };
            recognition.onend = () => { isRecording = false; ui.micBtn.classList.remove('recording'); ui.userInput.placeholder = "Ask AI, add a task, reminder, or draft a note..."; };
            ui.micBtn.addEventListener('click', () => { if (isRecording) recognition.stop(); else recognition.start(); });
        } else { ui.micBtn.style.display = 'none'; }


        async function sendMessage() {
            const text = ui.userInput.value.trim();
            if (!text || !DYNAMIC_OPENAI_KEY) return;

            ui.userInput.value = "";
            await addDoc(collection(db, "chats"), { role: "user", content: text, timestamp: new Date().toISOString() });

            const loadingId = "loading-" + Date.now();
            const loadingDiv = document.createElement('div'); loadingDiv.id = loadingId;
            loadingDiv.className = "text-blue-500 text-sm ml-2 font-medium animate-pulse";
            loadingDiv.textContent = "Checking memory and typing...";
            ui.chatBox.appendChild(loadingDiv); ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            try {
                const memoryStr = `
                CASES: ${allSavedNotes.map(n => `[Client: ${n.title} | Detail: ${n.content}]`).join(" ")}
                TASKS: ${allTasks.map(t => `[Task: ${t.title} | Status: ${t.status}]`).join(" ")}
                REMINDERS: ${allReminders.map(r => `[Reminder: ${r.title} | Time: ${r.time}]`).join(" ")}
                NOTEBOOK: ${allNotebooks.map(nb => `[Page: ${nb.title} | Content: ${nb.content}]`).join(" ")}
                `;

                // UPDATED SYSTEM PROMPT FOR HUMAN-LIKE DRAFTING
                const systemPrompt = {
                    role: "system",
                    content: `You are an expert AI Assistant and Professional Credit Case Manager for Nilesh at Bank of Baroda.
                    
                    DATABASE MEMORY:
                    ${memoryStr}
                    
                    YOUR STRICT RULES:
                    1. MEMORY SEARCH FIRST: When asked a question, SEARCH the DATABASE MEMORY above. 
                       - If found, reply based ONLY on that data.
                       - If NOT found, explicitly say: "Ye information meri memory me nahi hai." Do not guess outside your memory.
                       
                    2. SAVING DATA (CRITICAL FORMAT): To save new information, append EXACT tags at the very end of your reply. Use exactly ONE pipe '|' to separate the Title and Content.
                       - Client Note -> [CASE: Client Name | Single sentence update]
                       - Task -> [TASK: Task Name | Status]
                       - Reminder -> [REMINDER: Reminder Title | Time or Date]
                       
                       IMPORTANT - FOR NOTEBOOK:
                       - Notebook Page -> [NOTEBOOK: Page Title | Professional Draft]
                       - When saving to NOTEBOOK, act like a professional human secretary. Draft the content properly using bullet points, paragraphs, and structured format. Expand on the user's raw input to make it read like a clear, formal meeting note or memo. Use markdown-style bullet points (-) if needed.
                       
                    EXAMPLES OF SAVING DATA:
                    Correct Case: [CASE: Kunal Patidar | Mobile: 9302467283, Loan: 487000. SMAX complain: beneficiary issue.]
                    Correct Task: [TASK: Disburse Kunal Patidar loan via Tejas | Pending]
                    
                    Correct Notebook: [NOTEBOOK: Kunal Patidar Loan Draft | 
                    Client overview and pending tasks drafted for record:
                    - **Client Details**: Mr. Kunal Patidar.
                    - **Contact Info**: Mobile Number 9302467283.
                    - **Loan Amount**: ‚Çπ4,87,000 to be disbursed on Monday.
                    - **Action Items**: 
                      1. Check SMAX complaint status (Beneficiary issue). 
                      2. Download loan documents from Tejas portal. 
                      3. Open account using RMenu in Finacle.]
                    
                    3. Always reply in friendly Hinglish.`
                };

                const recentHistory = chatHistory.slice(-15);
                const apiMessages = [systemPrompt, ...recentHistory, { role: "user", content: text }];

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${DYNAMIC_OPENAI_KEY}` },
                    body: JSON.stringify({ model: "gpt-3.5-turbo", messages: apiMessages })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let aiReply = data.choices[0].message.content;

                const regexes = [
                    { re: /\[(?:CASE|CLIENT|NOTE)\s*:\s*([^|\]]+)\|\|?\s*([\s\S]*?)\]/gi, col: "notes", map: m => ({ title: m[1].trim(), content: m[2].trim() }) },
                    { re: /\[(?:TASK)\s*:\s*([^|\]]+)\|\|?\s*([\s\S]*?)\]/gi, col: "tasks", map: m => ({ title: m[1].trim(), status: m[2].trim() }) },
                    { re: /\[(?:REMINDER)\s*:\s*([^|\]]+)\|\|?\s*([\s\S]*?)\]/gi, col: "reminders", map: m => ({ title: m[1].trim(), time: m[2].trim() }) },
                    { re: /\[(?:NOTEBOOK|PAGE)\s*:\s*([^|\]]+)\|\|?\s*([\s\S]*?)\]/gi, col: "notebooks", map: m => ({ title: m[1].trim(), content: m[2].trim() }) }
                ];

                for (let r of regexes) {
                    let match;
                    while ((match = r.re.exec(aiReply)) !== null) {
                        const payload = { ...r.map(match), timestamp: new Date().toISOString() };
                        await addDoc(collection(db, r.col), payload);
                    }
                    aiReply = aiReply.replace(r.re, '').trim(); 
                }

                await addDoc(collection(db, "chats"), { role: "assistant", content: aiReply, timestamp: new Date().toISOString() });

            } catch (error) { alert("Error: " + error.message); } 
            finally { document.getElementById(loadingId)?.remove(); }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
