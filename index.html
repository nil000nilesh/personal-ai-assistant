<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Steno Pro - Case Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .devanagari { font-family: 'Noto Sans Devanagari', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-btn.active { background-color: rgba(255, 255, 255, 0.1); color: #60a5fa; border-left: 4px solid #3b82f6; font-weight: 600; }
        .tab-btn-mob.active { color: #3b82f6; font-weight: bold; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .recording { animation: pulse-ring 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        
        .client-updates-scroll::-webkit-scrollbar { width: 4px; }
        .client-updates-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

        .notebook-page {
            background-image: repeating-linear-gradient(transparent, transparent 27px, #f1f5f9 27px, #f1f5f9 28px);
            line-height: 28px;
            padding-top: 2px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .modal-open { opacity: 1; visibility: visible; }
        .modal-closed { opacity: 0; visibility: hidden; }
        .modal-content-open { transform: translateY(0) scale(1); }
        .modal-content-closed { transform: translateY(100px) scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] overflow-hidden flex flex-col selection:bg-blue-200">

    <div id="login-screen" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&q=80&w=1920')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/40"></div>
        <div class="glass-card p-10 rounded-[2rem] shadow-2xl text-center max-w-md w-[90%] relative z-10 transform transition-all hover:scale-[1.02]">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-blue-500/30">
                <span class="text-4xl">ğŸ’¼</span>
            </div>
            <h1 class="text-4xl font-extrabold mb-3 text-slate-900 tracking-tight">Smart Steno Pro</h1>
            <p class="text-slate-600 mb-8 text-sm leading-relaxed">Aapka personal AI assistant jo aapke cases, tasks aur meetings ko automatically manage karta hai.</p>
            
            <button id="login-btn" class="w-full bg-slate-900 hover:bg-slate-800 text-white px-6 py-4 rounded-xl font-bold shadow-xl transition-all flex items-center justify-center gap-3">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                Sign in with Google
            </button>
            <p class="mt-6 text-xs text-slate-400 font-medium tracking-wide uppercase">Secured by Bank Standards</p>
        </div>
    </div>

    <div id="pin-screen" class="hidden absolute inset-0 z-[100] flex-col items-center justify-center bg-slate-900 text-white bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&q=80&w=1920')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mb-6">ğŸ”’</div>
            <h2 class="text-2xl mb-8 font-semibold tracking-wide">Enter Security PIN</h2>
            <input type="password" id="pin-input" maxlength="4" class="bg-slate-800/50 border-2 border-slate-600 p-4 text-center text-5xl tracking-[0.5em] text-white rounded-2xl mb-8 w-64 outline-none focus:border-blue-500 transition-colors shadow-inner backdrop-blur-sm" />
            <button id="verify-pin-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-xl shadow-lg shadow-blue-500/30 font-bold transition-all hover:-translate-y-1">Unlock Dashboard</button>
        </div>
    </div>

    <div id="app-layout" class="hidden flex-1 flex-col md:flex-row w-full h-full bg-slate-50 relative">
        
        <nav class="hidden md:flex flex-col w-72 bg-slate-900 text-slate-300 shadow-2xl z-20">
            <div class="p-8 border-b border-white/5 flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 text-xl">ğŸ’¼</div>
                <h1 class="text-xl font-bold text-white tracking-wide">Smart Steno Pro</h1>
            </div>
            <div class="flex-1 py-6 flex flex-col gap-2 px-4">
                <button id="tab-notebook-desk" class="tab-btn active px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">ğŸ““ Notebook</button>
                <button id="tab-notes-desk" class="tab-btn px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">ğŸ“‚ Client Cases</button>
                <button id="tab-tasks-desk" class="tab-btn px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">âœ… Tasks</button>
                <button id="tab-reminders-desk" class="tab-btn px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">â° Reminders</button>
            </div>
            <div class="p-6 border-t border-white/5">
                <button id="logout-btn-desk" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 px-4 py-3 rounded-xl font-medium transition-colors text-sm flex items-center justify-center gap-2">
                    Secure Logout
                </button>
            </div>
        </nav>

        <main class="flex-1 relative flex flex-col h-full overflow-hidden">
            <header class="md:hidden bg-white border-b border-slate-200 px-5 py-4 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-sm shadow-md">ğŸ’¼</div>
                    <h1 class="text-lg font-bold text-slate-800 tracking-tight">Smart Steno</h1>
                </div>
                <button id="logout-btn-mob" class="text-xs bg-slate-100 text-slate-600 px-3 py-2 rounded-lg font-medium">Logout</button>
            </header>

            <div id="view-notebook" class="absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex flex-col overflow-hidden">
                <!-- Sticky toolbar -->
                <div class="bg-white border-b border-slate-200 px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">ğŸ““ My Notebook</h2>
                            <span id="nb-count" class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">0 notes</span>
                        </div>
                        <!-- Search + Sort + Filter row -->
                        <div class="flex flex-wrap gap-2 items-center">
                            <div class="relative flex-1 min-w-[180px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">ğŸ”</span>
                                <input id="nb-search" type="text" placeholder="Search notes..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 focus:bg-white transition"/>
                            </div>
                            <select id="nb-sort" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 focus:outline-none focus:border-blue-400 text-slate-600">
                                <option value="new">ğŸ• Newest First</option>
                                <option value="old">ğŸ“… Oldest First</option>
                                <option value="az">ğŸ”¤ A â†’ Z</option>
                            </select>
                            <select id="nb-filter" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 focus:outline-none focus:border-blue-400 text-slate-600">
                                <option value="all">ğŸ“‚ All Clients</option>
                            </select>
                            <button id="nb-view-toggle" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 hover:bg-blue-50 hover:border-blue-300 text-slate-600 transition" title="Toggle view">âŠ Grid</button>
                        </div>
                    </div>
                </div>
                <!-- Scrollable grid -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8">
                    <div class="max-w-6xl mx-auto">
                        <div id="notebook-grid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 items-start"></div>
                        <div id="nb-empty" class="hidden text-center py-20 text-slate-400">
                            <div class="text-5xl mb-3">ğŸ“­</div>
                            <p class="font-semibold">No notes found</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-notes" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">Client Cases</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Har client ki history aur latest updates ka record.</p>
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20"></div>
                </div>
            </div>

            <div id="view-tasks" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-hidden">
                <!-- Tasks Toolbar -->
                <div class="bg-white border-b border-slate-200 px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">âœ… My Tasks</h2>
                            <div class="flex items-center gap-2">
                                <span id="task-pending-count" class="text-xs font-black text-orange-600 bg-orange-50 border border-orange-200 px-3 py-1 rounded-full">0 Pending</span>
                                <span id="task-done-count" class="text-xs font-black text-green-600 bg-green-50 border border-green-200 px-3 py-1 rounded-full">0 Done</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative flex-1 min-w-[160px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">ğŸ”</span>
                                <input id="task-search" type="text" placeholder="Search tasks..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 focus:bg-white transition"/>
                            </div>
                            <div id="task-filter-btns" class="flex gap-1.5">
                                <button data-filter="all" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600">All</button>
                                <button data-filter="Pending" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-orange-50 hover:border-orange-200 hover:text-orange-700">â³ Pending</button>
                                <button data-filter="Done" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-green-50 hover:border-green-200 hover:text-green-700">âœ… Done</button>
                                <button data-filter="Urgent" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-red-50 hover:border-red-200 hover:text-red-700">ğŸš¨ Urgent</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 md:px-10 py-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="tasks-list" class="flex flex-col gap-3 pb-20"></div>
                        <div id="task-empty" class="hidden text-center py-20 text-slate-400"><div class="text-5xl mb-3">ğŸ‰</div><p class="font-semibold">Koi task nahi! Sab clear hai.</p></div>
                    </div>
                </div>
            </div>

            <div id="view-reminders" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-hidden">
                <!-- Reminders Toolbar -->
                <div class="bg-white border-b border-slate-200 px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">â° Reminders</h2>
                            <div class="flex gap-2">
                                <span id="rem-upcoming-count" class="text-xs font-black text-blue-700 bg-blue-50 border border-blue-200 px-3 py-1 rounded-full">0 Upcoming</span>
                                <span id="rem-overdue-count" class="text-xs font-black text-red-700 bg-red-50 border border-red-200 px-3 py-1 rounded-full">0 Overdue</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative flex-1 min-w-[160px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">ğŸ”</span>
                                <input id="rem-search" type="text" placeholder="Search reminders..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 transition"/>
                            </div>
                            <div class="flex gap-1.5">
                                <button data-remfilter="all" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600">All</button>
                                <button data-remfilter="today" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-blue-50">ğŸ“… Today</button>
                                <button data-remfilter="upcoming" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-green-50">ğŸŸ¢ Upcoming</button>
                                <button data-remfilter="overdue" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-red-50">ğŸ”´ Overdue</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 md:px-10 py-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="reminders-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div>
                        <div id="rem-empty" class="hidden text-center py-20 text-slate-400"><div class="text-5xl mb-3">ğŸ—“ï¸</div><p class="font-semibold">Koi reminder nahi.</p></div>
                    </div>
                </div>
            </div>

            <button id="open-chat-fab" class="fixed bottom-24 right-6 md:bottom-10 md:right-10 w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-[0_10px_25px_rgba(59,130,246,0.5)] flex flex-col items-center justify-center text-white cursor-pointer hover:scale-110 hover:shadow-[0_15px_35px_rgba(59,130,246,0.6)] transition-all z-[40]">
                <span class="text-2xl mb-0.5">ğŸ¤–</span>
            </button>
        </main>

        <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex items-center justify-around h-[65px] pb-1 shadow-[0_-10px_20px_rgba(0,0,0,0.03)] z-[30]">
            <button id="tab-notebook-mob" class="tab-btn-mob active flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">ğŸ““</span> Notebook
            </button>
            <button id="tab-notes-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">ğŸ“‚</span> Cases
            </button>
            <button id="tab-tasks-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">âœ…</span> Tasks
            </button>
            <button id="tab-reminders-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">â°</span> Reminds
            </button>
        </nav>
    </div>

    <div id="chat-modal" class="modal-closed fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm transition-all duration-300 flex items-end md:items-center justify-center">
        <div id="chat-modal-content" class="modal-content-closed w-full h-[90vh] md:w-[850px] md:h-[85vh] bg-slate-50 md:rounded-3xl rounded-t-[2rem] shadow-2xl flex flex-col overflow-hidden transition-all duration-300 ease-out border border-white/20">
            
            <div class="bg-white border-b border-slate-200 p-4 md:p-5 flex justify-between items-center z-10 shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center relative">
                        <span class="text-2xl">ğŸ¤–</span>
                        <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></span>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-slate-900 text-lg leading-tight">AI Steno Assistant</h3>
                        <p class="text-xs text-slate-500 font-medium mt-0.5">Listening & saving data automatically...</p>
                    </div>
                </div>
                <button id="minimise-chat-btn" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl font-semibold text-sm transition-colors">
                    <span class="text-lg">ğŸ”½</span> <span class="hidden md:block">Minimise</span>
                </button>
            </div>
            
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 flex flex-col scroll-smooth">
                <div class="flex justify-start w-full">
                    <div class="p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-white border border-slate-200 text-slate-700 shadow-sm rounded-tl-sm">
Namaste ğŸ™ â€” AI Steno Assistant at your service. Powered by GPT-4.1. Aap apna kaam boliye, main sambhal leta hoon.
                    </div>
                </div>
            </div>
            
            <div class="p-4 md:p-6 bg-white border-t border-slate-200">
                <div class="max-w-4xl mx-auto flex gap-3 items-center">
                    <button id="mic-btn" class="bg-slate-100 hover:bg-blue-50 text-slate-500 hover:text-blue-600 p-4 rounded-2xl transition-all outline-none border border-slate-200 hover:border-blue-200" title="Click to Speak">
                        ğŸ¤
                    </button>
                    <input type="text" id="user-input" class="flex-1 bg-slate-100 border-transparent focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 p-4 rounded-2xl text-slate-800 outline-none transition-all font-medium placeholder:text-slate-400 shadow-inner" placeholder="Type a command or tap mic..." />
                    <button id="send-btn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 transition-transform active:scale-95">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithRedirect, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733",
            storageBucket: "ai-assistant-app-8e733.firebasestorage.app",
            messagingSenderId: "318215944760",
            appId: "1:318215944760:web:2a387b7bcd068da4ff44cd"
        };
        const SECRET_PIN = "5786"; 
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let chatHistory = [];
        let allSavedNotes = []; 
        let allTasks = [];
        let allReminders = [];
        let allNotebooks = [];

        let isPinVerified = false;
        let DYNAMIC_OPENAI_KEY = "";
        let OPENAI_MODEL = "gpt-4.1"; // Firebase se override ho sakta hai
        let sessionStartTime;

        const ui = {
            login: document.getElementById('login-screen'),
            pin: document.getElementById('pin-screen'),
            appLayout: document.getElementById('app-layout'),
            viewNotes: document.getElementById('view-notes'),
            viewTasks: document.getElementById('view-tasks'),
            viewReminders: document.getElementById('view-reminders'),
            viewNotebook: document.getElementById('view-notebook'),
            chatBox: document.getElementById('chat-box'),
            notesGrid: document.getElementById('notes-grid'),
            tasksList: document.getElementById('tasks-list'),
            remindersList: document.getElementById('reminders-list'),
            notebookGrid: document.getElementById('notebook-grid'),
            userInput: document.getElementById('user-input'),
            micBtn: document.getElementById('mic-btn'),
            chatModal: document.getElementById('chat-modal'),
            chatModalContent: document.getElementById('chat-modal-content')
        };

        const views = ['notes', 'tasks', 'reminders', 'notebook'];

        // ERROR FIXED HERE: Removing flex class so it hides properly
        function hideAllStates() {
            ui.login.classList.add('hidden'); ui.login.classList.remove('flex');
            ui.pin.classList.add('hidden'); ui.pin.classList.remove('flex');
            ui.appLayout.classList.add('hidden'); ui.appLayout.classList.remove('flex');
        }

        function switchView(targetView) {
            views.forEach(v => {
                const deskBtn = document.getElementById(`tab-${v}-desk`);
                const mobBtn = document.getElementById(`tab-${v}-mob`);
                const viewEl = document.getElementById(`view-${v}`);
                if(v === targetView) {
                    viewEl.classList.remove('hidden'); viewEl.classList.add('flex');
                    if(deskBtn) deskBtn.classList.add('active');
                    if(mobBtn) mobBtn.classList.add('active');
                } else {
                    viewEl.classList.add('hidden'); viewEl.classList.remove('flex');
                    if(deskBtn) deskBtn.classList.remove('active');
                    if(mobBtn) mobBtn.classList.remove('active');
                }
            });
        }

        views.forEach(v => {
            document.getElementById(`tab-${v}-desk`)?.addEventListener('click', () => switchView(v));
            document.getElementById(`tab-${v}-mob`)?.addEventListener('click', () => switchView(v));
        });

        const openChatFab = document.getElementById('open-chat-fab');
        const minimiseChatBtn = document.getElementById('minimise-chat-btn');

        function openChatModal() {
            ui.chatModal.classList.remove('modal-closed');
            ui.chatModal.classList.add('modal-open');
            setTimeout(() => {
                ui.chatModalContent.classList.remove('modal-content-closed');
                ui.chatModalContent.classList.add('modal-content-open');
                ui.userInput.focus();
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            }, 10);
        }

        function closeChatModal() {
            ui.chatModalContent.classList.remove('modal-content-open');
            ui.chatModalContent.classList.add('modal-content-closed');
            setTimeout(() => {
                ui.chatModal.classList.remove('modal-open');
                ui.chatModal.classList.add('modal-closed');
            }, 300);
        }

        openChatFab.addEventListener('click', openChatModal);
        minimiseChatBtn.addEventListener('click', closeChatModal);
        ui.chatModal.addEventListener('click', (e) => {
            if (e.target === ui.chatModal) closeChatModal();
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = document.getElementById('login-btn');
            const originalHTML = btn.innerHTML;
            btn.innerText = "Signing in...";
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                if(error.code === 'auth/popup-blocked') {
                    await signInWithRedirect(auth, provider);
                } else {
                    btn.innerHTML = originalHTML;
                }
            }
        });

        onAuthStateChanged(auth, (user) => {
            hideAllStates();
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    if (!isPinVerified) { 
                        ui.pin.classList.remove('hidden'); 
                        ui.pin.classList.add('flex'); 
                    } else { 
                        checkAndLoadApp(); 
                    }
                } else { 
                    alert("Unauthorized Email!"); 
                    signOut(auth); 
                }
            } else { 
                ui.login.classList.remove('hidden'); 
                ui.login.classList.add('flex'); 
            }
        });

        const doLogout = () => { isPinVerified = false; DYNAMIC_OPENAI_KEY = ""; signOut(auth); };
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if (document.getElementById('pin-input').value === SECRET_PIN) {
                isPinVerified = true; 
                checkAndLoadApp();
            } else { 
                alert("Incorrect PIN"); 
                document.getElementById('pin-input').value = ""; 
            }
        });

        async function checkAndLoadApp() {
            hideAllStates();
            try {
                const keyDoc = await getDoc(doc(db, "system_settings", "api_config"));
                if (keyDoc.exists() && keyDoc.data().openai_key) {
                    DYNAMIC_OPENAI_KEY = keyDoc.data().openai_key;
                    if (keyDoc.data().openai_model) OPENAI_MODEL = keyDoc.data().openai_model;
                    sessionStartTime = new Date().toISOString(); 
                    
                    ui.appLayout.classList.remove('hidden'); 
                    ui.appLayout.classList.add('flex');
                    
                    switchView('notebook');
                    loadAppListeners();
                } else { 
                    alert("API Key missing in Database!");
                    ui.login.classList.remove('hidden'); ui.login.classList.add('flex');
                    signOut(auth);
                }
            } catch (error) { 
                alert("Database connection failed."); 
                console.error(error);
            }
        }

        function loadAppListeners() {
            const chatQuery = query(collection(db, "chats"), where("timestamp", ">=", sessionStartTime), orderBy("timestamp", "asc"));
            onSnapshot(chatQuery, (snapshot) => {
                const welcomeMsg = ui.chatBox.firstElementChild;
                ui.chatBox.innerHTML = ""; 
                if(welcomeMsg) ui.chatBox.appendChild(welcomeMsg);
                
                chatHistory = []; 
                snapshot.forEach((docData) => {
                    const msg = docData.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            });

            onSnapshot(query(collection(db, "notes"), orderBy("timestamp", "asc")), (snapshot) => {
                ui.notesGrid.innerHTML = ""; allSavedNotes = []; let groupedNotes = {};
                snapshot.forEach((docData) => {
                    const note = docData.data(); allSavedNotes.push(note);
                    const normalizedTitle = (note.client || note.title || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯").toUpperCase();
                    if(!groupedNotes[normalizedTitle]) groupedNotes[normalizedTitle] = {
                        displayTitle: note.client || note.title || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        mobile: note.mobile || null,
                        updates: []
                    };
                    if(!groupedNotes[normalizedTitle].mobile) {
                        const mobMatch = (note.content || "").match(/\b[6-9]\d{9}\b/);
                        if(mobMatch) groupedNotes[normalizedTitle].mobile = mobMatch[0];
                    }
                    groupedNotes[normalizedTitle].updates.push(note);
                });

                for (const key in groupedNotes) {
                    const group = groupedNotes[key];
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-[1.5rem] shadow-sm hover:shadow-lg border border-slate-100 relative group overflow-hidden transition-all";

                    const latestUpdate = group.updates[group.updates.length - 1];
                    const latestContent = (latestUpdate?.content || "").toLowerCase();
                    let statusBadge = "ğŸ”µ Active";
                    let statusColor = "bg-blue-50 text-blue-700 border-blue-200";
                    if(/disburs|à¤µà¤¿à¤¤à¤°à¤£/.test(latestContent))    { statusBadge = "âœ… Disbursed";  statusColor = "bg-green-50 text-green-700 border-green-200"; }
                    else if(/sanction|à¤¸à¥à¤µà¥€à¤•à¥ƒà¤¤/.test(latestContent)) { statusBadge = "âœ”ï¸ Sanctioned"; statusColor = "bg-emerald-50 text-emerald-700 border-emerald-200"; }
                    else if(/reject|à¤…à¤¸à¥à¤µà¥€à¤•à¥ƒà¤¤/.test(latestContent))  { statusBadge = "âŒ Rejected";   statusColor = "bg-red-50 text-red-700 border-red-200"; }
                    else if(/pending|à¤²à¤‚à¤¬à¤¿à¤¤/.test(latestContent))     { statusBadge = "â³ Pending";    statusColor = "bg-yellow-50 text-yellow-700 border-yellow-200"; }
                    else if(/mortgage|à¤®à¥‰à¤°à¥à¤—à¥‡à¤œ/.test(latestContent))  { statusBadge = "ğŸ“‘ Mortgage";   statusColor = "bg-purple-50 text-purple-700 border-purple-200"; }
                    else if(/processing|à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸à¤¿à¤‚à¤—/.test(latestContent)){ statusBadge = "ğŸ”„ Processing"; statusColor = "bg-indigo-50 text-indigo-700 border-indigo-200"; }

                    function fmtDate(ts) {
                        const d = new Date(ts);
                        return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                    }
                    function fmtTime(ts) {
                        return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                    }
                    function fmtDateTime(ts) { return fmtDate(ts) + ' â€” ' + fmtTime(ts); }

                    const headerHTML = `
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-indigo-500 transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                        <div class="p-5 pb-3 border-b border-slate-100">
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <h3 class="font-extrabold text-slate-800 text-xl leading-tight">${group.displayTitle}</h3>
                                <span class="text-[10px] font-bold px-2.5 py-1 rounded-full border shrink-0 ${statusColor}">${statusBadge}</span>
                            </div>
                            <div class="flex flex-wrap gap-3 text-[11px] text-slate-500 font-semibold mt-1">
                                ${group.mobile ? `<span class="flex items-center gap-1 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-200">ğŸ“± ${group.mobile}</span>` : ""}
                                <span class="flex items-center gap-1 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-200">ğŸ“‹ ${group.updates.length} Update${group.updates.length>1?'s':''}</span>
                                <span class="flex items-center gap-1 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-200">ğŸ• ${fmtDateTime(latestUpdate.timestamp)}</span>
                            </div>
                        </div>`;

                    const sortedUpdates = [...group.updates].reverse();
                    const updatesHTML = sortedUpdates.map((u, idx) => {
                        const isLatest = idx === 0;
                        return `
                        <div class="relative pl-9 pr-4 py-3 ${isLatest ? 'bg-blue-50/30' : ''} border-b border-slate-50 last:border-b-0">
                            <div class="absolute left-3.5 top-4 w-2.5 h-2.5 rounded-full border-2 border-white shadow-sm ${isLatest ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                            ${idx < sortedUpdates.length - 1 ? '<div class="absolute left-[17px] top-7 bottom-0 w-px bg-slate-100"></div>' : ''}
                            <div class="flex items-center gap-2 mb-1.5 flex-wrap">
                                <span class="text-[10px] font-black px-2 py-0.5 rounded-full ${isLatest ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">ğŸ“… ${fmtDate(u.timestamp)}</span>
                                <span class="text-[10px] font-bold text-slate-400">â° ${fmtTime(u.timestamp)}</span>
                                ${isLatest ? '<span class="text-[9px] font-black text-white bg-blue-500 px-2 py-0.5 rounded-full">LATEST</span>' : ''}
                            </div>
                            <p class="text-slate-700 text-sm leading-relaxed font-medium whitespace-pre-wrap devanagari">${u.content}</p>
                        </div>`;
                    }).join("");

                    card.innerHTML = headerHTML + `<div class="overflow-y-auto client-updates-scroll max-h-[350px]">${updatesHTML}</div>`;
                    ui.notesGrid.appendChild(card);
                }
            });

            // TASKS â€” with search, filter, status toggle, priority, due date
            let taskCurrentFilter = 'all';
            let taskSearchQuery = '';

            function renderTasks() {
                const list = document.getElementById('tasks-list');
                const empty = document.getElementById('task-empty');
                const pendingCount = document.getElementById('task-pending-count');
                const doneCount = document.getElementById('task-done-count');
                list.innerHTML = '';

                let filtered = allTasks.filter(t => {
                    const matchFilter = taskCurrentFilter === 'all' || t.status === taskCurrentFilter ||
                        (taskCurrentFilter === 'Urgent' && t.priority === 'Urgent');
                    const matchSearch = !taskSearchQuery || (t.title||'').toLowerCase().includes(taskSearchQuery) ||
                        (t.client||'').toLowerCase().includes(taskSearchQuery);
                    return matchFilter && matchSearch;
                });

                const pending = allTasks.filter(t => t.status !== 'Done').length;
                const done    = allTasks.filter(t => t.status === 'Done').length;
                if(pendingCount) pendingCount.textContent = pending + ' Pending';
                if(doneCount) doneCount.textContent = done + ' Done';

                if(filtered.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                filtered.forEach((task, idx) => {
                    const isDone = task.status === 'Done';
                    const isUrgent = task.priority === 'Urgent';
                    const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !isDone;
                    const d = new Date(task.timestamp);
                    const dateStr = d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                    const timeStr = d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

                    let priorityBadge = '';
                    if(isUrgent) priorityBadge = '<span class="text-[10px] font-black text-red-600 bg-red-50 border border-red-200 px-2 py-0.5 rounded-full">ğŸš¨ URGENT</span>';

                    let dueBadge = '';
                    if(task.dueDate) {
                        const due = new Date(task.dueDate).toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
                        dueBadge = `<span class="text-[10px] font-bold ${isOverdue ? 'text-red-600 bg-red-50' : 'text-slate-500 bg-slate-100'} px-2 py-0.5 rounded-full">ğŸ“… ${due}</span>`;
                    }

                    let statusBadge = '';
                    if(isDone)
                        statusBadge = '<span class="text-[10px] font-black text-green-700 bg-green-50 border border-green-200 px-2.5 py-1 rounded-full">âœ… Done</span>';
                    else if(isOverdue)
                        statusBadge = '<span class="text-[10px] font-black text-red-700 bg-red-50 border border-red-200 px-2.5 py-1 rounded-full animate-pulse">ğŸ”´ Overdue</span>';
                    else
                        statusBadge = '<span class="text-[10px] font-black text-orange-700 bg-orange-50 border border-orange-200 px-2.5 py-1 rounded-full">â³ Pending</span>';

                    const div = document.createElement('div');
                    div.className = `bg-white rounded-2xl border shadow-sm hover:shadow-md transition-all group ${isDone ? 'opacity-60 border-slate-100' : isOverdue ? 'border-red-200' : 'border-slate-100 hover:border-blue-200'}`;
                    div.innerHTML = `
                        <div class="p-4 flex items-start gap-4">
                            <!-- Checkbox -->
                            <button class="task-check-btn mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 ${isDone ? 'bg-green-500 border-green-500' : 'border-slate-300 hover:border-blue-400'} flex items-center justify-center transition-all" data-idx="${idx}">
                                ${isDone ? '<svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                            </button>
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-slate-800 text-base leading-snug devanagari ${isDone ? 'line-through text-slate-400' : ''}">${task.title}</p>
                                <div class="flex flex-wrap gap-2 mt-2 items-center">
                                    ${task.client ? `<span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">ğŸ‘¤ ${task.client}</span>` : ''}
                                    ${dueBadge}
                                    ${priorityBadge}
                                    <span class="text-[10px] text-slate-400 font-semibold ml-auto">ğŸ• ${dateStr} ${timeStr}</span>
                                </div>
                            </div>
                            <!-- Status badge -->
                            <div class="flex-shrink-0">${statusBadge}</div>
                        </div>`;
                    list.appendChild(div);
                });

                // Checkbox toggle
                list.querySelectorAll('.task-check-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        const task = filtered[idx];
                        task.status = task.status === 'Done' ? 'Pending' : 'Done';
                        renderTasks();
                    });
                });
            }

            onSnapshot(query(collection(db, "tasks"), orderBy("timestamp", "desc")), (snapshot) => {
                allTasks = [];
                snapshot.forEach(d => allTasks.push(d.data()));
                renderTasks();
            });

            // Task search
            document.getElementById('task-search')?.addEventListener('input', e => {
                taskSearchQuery = e.target.value.toLowerCase();
                renderTasks();
            });

            // Task filter buttons
            document.getElementById('task-filter-btns')?.addEventListener('click', e => {
                const btn = e.target.closest('[data-filter]');
                if(!btn) return;
                taskCurrentFilter = btn.dataset.filter;
                document.querySelectorAll('.task-filter-btn').forEach(b => {
                    b.className = b === btn
                        ? 'task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600'
                        : 'task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50';
                });
                renderTasks();
            });

            // REMINDERS â€” with search, filter, overdue detection, countdown
            let remCurrentFilter = 'all';
            let remSearchQuery = '';

            function parseRemDate(timeStr) {
                if(!timeStr || timeStr === 'Manual' || timeStr === 'à¤œà¤²à¥à¤¦') return null;
                const d = new Date(timeStr);
                return isNaN(d) ? null : d;
            }

            function renderReminders() {
                const list = document.getElementById('reminders-list');
                const empty = document.getElementById('rem-empty');
                const upcomingEl = document.getElementById('rem-upcoming-count');
                const overdueEl = document.getElementById('rem-overdue-count');
                list.innerHTML = '';
                const now = new Date();

                let filtered = allReminders.filter(r => {
                    const d = parseRemDate(r.time);
                    const isOverdue = d && d < now;
                    const isToday = d && d.toDateString() === now.toDateString();
                    const matchFilter = remCurrentFilter === 'all' ||
                        (remCurrentFilter === 'today' && isToday) ||
                        (remCurrentFilter === 'overdue' && isOverdue) ||
                        (remCurrentFilter === 'upcoming' && d && d >= now);
                    const matchSearch = !remSearchQuery || (r.title||'').toLowerCase().includes(remSearchQuery) ||
                        (r.client||'').toLowerCase().includes(remSearchQuery);
                    return matchFilter && matchSearch;
                });

                const upcoming = allReminders.filter(r => { const d=parseRemDate(r.time); return d && d >= now; }).length;
                const overdue  = allReminders.filter(r => { const d=parseRemDate(r.time); return d && d < now; }).length;
                if(upcomingEl) upcomingEl.textContent = upcoming + ' Upcoming';
                if(overdueEl)  overdueEl.textContent  = overdue  + ' Overdue';

                if(filtered.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                filtered.forEach(rem => {
                    const remDate = parseRemDate(rem.time);
                    const isOverdue = remDate && remDate < now;
                    const isToday   = remDate && remDate.toDateString() === now.toDateString();
                    const isManual  = !remDate;

                    let cardColor, dotColor, timeLabel;
                    if(isOverdue)       { cardColor = 'from-red-50 to-red-100 border-red-200'; dotColor = 'bg-red-500'; timeLabel = 'ğŸ”´ Overdue'; }
                    else if(isToday)    { cardColor = 'from-orange-50 to-amber-50 border-amber-200'; dotColor = 'bg-amber-500'; timeLabel = 'ğŸŸ  Today'; }
                    else if(isManual)   { cardColor = 'from-slate-50 to-slate-100 border-slate-200'; dotColor = 'bg-slate-400'; timeLabel = 'ğŸ“Œ Manual'; }
                    else                { cardColor = 'from-blue-50 to-indigo-50 border-blue-200'; dotColor = 'bg-blue-500'; timeLabel = 'ğŸŸ¢ Upcoming'; }

                    let formattedTime = rem.time;
                    if(remDate) {
                        formattedTime = remDate.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                        if(remDate.getHours() || remDate.getMinutes())
                            formattedTime += ' â€” ' + remDate.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                    }

                    // Days countdown
                    let countdownBadge = '';
                    if(remDate && !isOverdue) {
                        const diff = Math.ceil((remDate - now) / (1000*60*60*24));
                        countdownBadge = diff === 0
                            ? '<span class="text-[10px] font-black text-amber-700 bg-amber-100 px-2 py-0.5 rounded-full animate-pulse">Today!</span>'
                            : `<span class="text-[10px] font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">in ${diff}d</span>`;
                    } else if(isOverdue) {
                        const diff = Math.ceil((now - remDate) / (1000*60*60*24));
                        countdownBadge = `<span class="text-[10px] font-black text-red-700 bg-red-100 px-2 py-0.5 rounded-full">${diff}d ago</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = `bg-gradient-to-br ${cardColor} border p-5 rounded-2xl shadow-sm flex flex-col gap-3 relative overflow-hidden hover:shadow-md transition-all`;
                    div.innerHTML = `
                        <div class="absolute -right-3 -top-3 text-5xl opacity-[0.07] select-none">â°</div>
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${dotColor} ${isOverdue||isToday ? 'animate-pulse' : ''}"></span>
                                <span class="text-xs font-black text-slate-600 uppercase tracking-wide">${timeLabel}</span>
                            </div>
                            ${countdownBadge}
                        </div>
                        <p class="font-bold text-slate-800 text-base leading-snug devanagari">${rem.title}</p>
                        <div class="flex flex-wrap gap-2 items-center mt-1">
                            <span class="text-[11px] font-bold text-slate-500 bg-white/60 px-2 py-0.5 rounded-lg">ğŸ“… ${formattedTime}</span>
                            ${rem.client ? `<span class="text-[10px] font-bold text-blue-600 bg-white/60 px-2 py-0.5 rounded-lg">ğŸ‘¤ ${rem.client}</span>` : ''}
                        </div>`;
                    list.appendChild(div);
                });
            }

            onSnapshot(query(collection(db, "reminders"), orderBy("timestamp", "desc")), (snapshot) => {
                allReminders = [];
                snapshot.forEach(d => allReminders.push(d.data()));
                renderReminders();
            });

            // Reminders search
            document.getElementById('rem-search')?.addEventListener('input', e => {
                remSearchQuery = e.target.value.toLowerCase();
                renderReminders();
            });

            // Reminders filter buttons
            document.querySelectorAll('.rem-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    remCurrentFilter = btn.dataset.remfilter;
                    document.querySelectorAll('.rem-filter-btn').forEach(b => {
                        b.className = b === btn
                            ? 'rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600'
                            : 'rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50';
                    });
                    renderReminders();
                });
            });

            // NOTEBOOK â€” grouped by client, search, sort, filter, grid/list toggle
            let nbSearchQuery = '';
            let nbSort = 'new';
            let nbFilterClient = 'all';
            let nbViewGrid = true;

            function renderNotebook() {
                const grid = document.getElementById('notebook-grid');
                const empty = document.getElementById('nb-empty');
                const countEl = document.getElementById('nb-count');
                grid.innerHTML = '';

                // Group by client
                let grouped = {};
                let allClientNames = new Set();
                allNotebooks.forEach(page => {
                    const key = (page.client || page.title || 'à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯').toUpperCase();
                    const name = page.client || page.title || 'à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯';
                    allClientNames.add(name);
                    if(!grouped[key]) grouped[key] = { displayName: name, updates: [] };
                    grouped[key].updates.push(page);
                });

                // Populate client filter dropdown
                const filterEl = document.getElementById('nb-filter');
                if(filterEl && filterEl.options.length <= 1) {
                    allClientNames.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name; opt.textContent = 'ğŸ‘¤ ' + name;
                        filterEl.appendChild(opt);
                    });
                }

                // Filter by client
                let entries = Object.values(grouped).filter(g => {
                    if(nbFilterClient !== 'all' && g.displayName !== nbFilterClient) return false;
                    if(!nbSearchQuery) return true;
                    return g.displayName.toLowerCase().includes(nbSearchQuery) ||
                        g.updates.some(u => (u.content||'').toLowerCase().includes(nbSearchQuery));
                });

                // Sort
                entries.sort((a, b) => {
                    const aLatest = Math.max(...a.updates.map(u => new Date(u.timestamp)));
                    const bLatest = Math.max(...b.updates.map(u => new Date(u.timestamp)));
                    if(nbSort === 'new') return bLatest - aLatest;
                    if(nbSort === 'old') return aLatest - bLatest;
                    if(nbSort === 'az')  return a.displayName.localeCompare(b.displayName);
                    return 0;
                });

                if(countEl) countEl.textContent = allNotebooks.length + ' notes';
                grid.className = nbViewGrid
                    ? 'grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 items-start'
                    : 'flex flex-col gap-4 pb-20';

                if(entries.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                entries.forEach(group => {
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-[1.5rem] shadow-sm hover:shadow-xl border border-l-[8px] border-yellow-400 border-slate-200 relative transition-all duration-300 overflow-hidden group";

                    const sortedUpdates = [...group.updates].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latest = sortedUpdates[0];

                    function fmtDate(ts) { return new Date(ts).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }
                    function fmtTime(ts) { return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}); }

                    const headerHTML = `
                        <div class="bg-slate-900 text-white px-6 py-4 flex items-center justify-between">
                            <div>
                                <div class="text-[10px] text-yellow-400 font-black uppercase tracking-widest mb-0.5">ğŸ“‹ à¤•à¥à¤²à¤¾à¤‡à¤‚à¤Ÿ à¤¨à¥‹à¤Ÿ</div>
                                <h3 class="font-black text-xl tracking-tight">${group.displayName}</h3>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-slate-400 mb-0.5">à¤•à¥à¤² à¤…à¤ªà¤¡à¥‡à¤Ÿ</div>
                                <div class="text-yellow-400 text-2xl font-black">${group.updates.length}</div>
                            </div>
                        </div>`;

                    const updatesHTML = sortedUpdates.map((page, idx) => {
                        // Highlight search term
                        let displayContent = page.content || '';
                        if(nbSearchQuery) {
                            const regex = new RegExp(`(${nbSearchQuery})`, 'gi');
                            displayContent = displayContent.replace(regex, '<mark class="bg-yellow-200 rounded px-0.5">$1</mark>');
                        }
                        const isLatest = idx === 0;
                        return `
                        <div class="px-6 py-4 border-b border-slate-50 last:border-b-0 ${isLatest ? 'bg-yellow-50/30' : ''}">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="text-[10px] font-black px-2 py-0.5 rounded-full ${isLatest ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-500'}">ğŸ“… ${fmtDate(page.timestamp)}</span>
                                <span class="text-[10px] font-bold text-slate-400">â° ${fmtTime(page.timestamp)}</span>
                                ${isLatest ? '<span class="text-[9px] font-black bg-yellow-400 text-slate-900 px-2 py-0.5 rounded-full">#${group.updates.length}</span>' : `<span class="text-[9px] text-slate-300 font-bold">#${group.updates.length - idx}</span>`}
                            </div>
                            <div class="text-slate-700 text-sm leading-relaxed devanagari font-medium whitespace-pre-wrap">${displayContent}</div>
                        </div>`;
                    }).join('');

                    card.innerHTML = headerHTML + `<div class="divide-y divide-slate-50 max-h-[300px] overflow-y-auto client-updates-scroll">${updatesHTML}</div>`;
                    grid.appendChild(card);
                });
            }

            onSnapshot(query(collection(db, "notebooks"), orderBy("timestamp", "desc")), (snapshot) => {
                allNotebooks = [];
                snapshot.forEach(d => allNotebooks.push(d.data()));
                renderNotebook();
            });

            // Notebook search
            document.getElementById('nb-search')?.addEventListener('input', e => {
                nbSearchQuery = e.target.value.toLowerCase();
                renderNotebook();
            });

            // Notebook sort
            document.getElementById('nb-sort')?.addEventListener('change', e => {
                nbSort = e.target.value;
                renderNotebook();
            });

            // Notebook filter
            document.getElementById('nb-filter')?.addEventListener('change', e => {
                nbFilterClient = e.target.value;
                renderNotebook();
            });

            // Notebook grid/list toggle
            document.getElementById('nb-view-toggle')?.addEventListener('click', () => {
                nbViewGrid = !nbViewGrid;
                document.getElementById('nb-view-toggle').textContent = nbViewGrid ? 'âŠ Grid' : 'â˜° List';
                renderNotebook();
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            if(role === 'user') {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-md rounded-tr-sm";
            } else {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-white border border-slate-200 text-slate-700 shadow-sm rounded-tl-sm";
            }
            bubble.textContent = content;
            div.appendChild(bubble);
            ui.chatBox.appendChild(div);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';

            recognition.onstart = () => { isRecording = true; ui.micBtn.classList.add('recording'); ui.userInput.placeholder = "Listening..."; };
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) ui.userInput.value += event.results[i][0].transcript + ' ';
                    else interimTranscript += event.results[i][0].transcript;
                }
            };
            recognition.onend = () => { isRecording = false; ui.micBtn.classList.remove('recording'); ui.userInput.placeholder = "Type a command or tap mic..."; };
            ui.micBtn.addEventListener('click', () => { if (isRecording) recognition.stop(); else recognition.start(); });
        } else { ui.micBtn.style.display = 'none'; }

        let isProcessing = false;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  REAL AI ENGINE â€” OpenAI GPT-4o powered sendMessage
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function sendMessage() {
            if (isProcessing) return;
            const text = ui.userInput.value.trim();
            if (!text) return;

            isProcessing = true;
            ui.userInput.disabled = true;
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');
            ui.userInput.value = "";

            chatHistory.push({ role: 'user', content: text });

            await addDoc(collection(db, "chats"), {
                role: "user", content: text, timestamp: new Date().toISOString()
            });

            // Loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex justify-start w-full";
            loadingDiv.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-blue-500 text-sm font-bold animate-pulse shadow-sm flex items-center gap-2"><span class="text-xl">ğŸ¤–</span> AI à¤¸à¥‹à¤š à¤°à¤¹à¤¾ à¤¹à¥ˆ...</div>`;
            ui.chatBox.appendChild(loadingDiv);
            ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            try {
                // â”€â”€ 1. FETCH ALL SAVED DATA FROM FIREBASE FOR CONTEXT â”€â”€â”€â”€â”€â”€
                const [notebooksSnap, notesSnap, tasksSnap, remindersSnap] = await Promise.all([
                    getDocs(collection(db, "notebooks")),
                    getDocs(collection(db, "notes")),
                    getDocs(collection(db, "tasks")),
                    getDocs(collection(db, "reminders"))
                ]);

                const notebookData = notebooksSnap.docs.map(d => d.data());
                const casesData    = notesSnap.docs.map(d => d.data());
                const tasksData    = tasksSnap.docs.map(d => d.data());
                const remindersData= remindersSnap.docs.map(d => d.data());

                // Summarise saved data for AI context
                function summarize(arr, fields) {
                    return arr.slice(-30).map(item =>
                        fields.map(f => `${f}: ${item[f] || ''}`).join(' | ')
                    ).join('\n');
                }

                const savedContext = `
=== SAVED NOTEBOOKS (last 30) ===
${summarize(notebookData, ['client','content','timestamp'])}

=== CLIENT CASES (last 30) ===
${summarize(casesData, ['client','content','timestamp'])}

=== TASKS (last 30) ===
${summarize(tasksData, ['title','status','client','timestamp'])}

=== REMINDERS (last 30) ===
${summarize(remindersData, ['title','time','client','timestamp'])}
                `.trim();

                // â”€â”€ 2. SYSTEM PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const today = new Date().toLocaleDateString('en-IN', {
                    day: '2-digit', month: 'long', year: 'numeric'
                });

                const systemPrompt = `
Aap "Smart Steno Pro" ke AI Assistant hain â€” ek intelligent banking case manager jo Nilesh ji ke liye kaam karta hai.
Aaj ki tarikh: ${today}

AAPKE PAAS YEH SAVED DATA HAI (Firebase se fetch kiya):
${savedContext}

AAPKA KAAM:
1. Agar user koi CLIENT INFORMATION deta hai (koi bhi banking case â€” loan, mortgage, sanction, visit, CMA, processing, etc.):
   - Ek professional, official Devanagari Hindi mein notebook draft banao
   - Har point naye line mein, appropriate emoji ke saath
   - Sahi tense use karo: "ho gaya" = âœ… à¤ªà¥‚à¤°à¥à¤£, "ho raha hai" = ğŸ”„ à¤ªà¥à¤°à¤—à¤¤à¤¿ à¤®à¥‡à¤‚, "karna hai" = â³ à¤²à¤‚à¤¬à¤¿à¤¤
   - Client ka naam detect karo
   - JSON format mein respond karo (niche format diya hai)

2. Agar user KUCH PUCHH raha hai (jaise "Paawan Bio Energy ka status kya hai?", "kaunse cases pending hain?", "aaj ke tasks batao"):
   - Saved data mein se dhundh ke jawab do
   - Hindi mein, clearly, bullet points mein
   - JSON format mein respond karo

3. Agar user REMINDER ya TASK manually maangta hai:
   - Create karo

RESPONSE FORMAT (HAMESHA valid JSON do, kuch bhi extra mat likho):
{
  "reply": "...(user ko dikhane wala message Hindi mein)...",
  "notebook": {
    "save": true/false,
    "client": "Client Name",
    "content": "...Official Devanagari Hindi draft, line by line points..."
  },
  "case": {
    "save": true/false,
    "client": "Client Name",
    "mobile": "10-digit mobile number agar diya ho, warna null",
    "content": "...case summary Hindi mein..."
  },
  "task": {
    "save": true/false,
    "client": "Client Name",
    "title": "...task title Hindi mein..."
  },
  "reminder": {
    "save": true/false,
    "client": "Client Name",
    "title": "...reminder title...",
    "time": "...time/date..."
  }
}

RULES:
- notebook.save = true: HAMESHA jab user koi client info/update deta hai
- case.save = true: Jab nayi case kholni ho ya major update ho
- task.save = true: Jab koi kaam karna baaki ho (pending action)
- reminder.save = true: Jab koi date/follow-up mention ho
- Sirf JSON do â€” koi explanation, code block, backtick nahi
- Hindi mein likho, professional banking language use karo
                `.trim();

                // â”€â”€ 3. CALL OPENAI GPT-4o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const messages = [
                    { role: "system", content: systemPrompt },
                    ...chatHistory.slice(-10) // last 10 messages for context
                ];

                const openaiRes = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${DYNAMIC_OPENAI_KEY}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: messages,
                        temperature: 0.3,
                        max_tokens: 1200
                    })
                });

                if (!openaiRes.ok) {
                    const errData = await openaiRes.json();
                    throw new Error(errData.error?.message || "OpenAI API Error");
                }

                const openaiData = await openaiRes.json();
                const rawContent = openaiData.choices[0].message.content.trim();

                // â”€â”€ 4. PARSE AI RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                let aiResponse;
                try {
                    // Strip code fences if any
                    const clean = rawContent.replace(/```json|```/g, '').trim();
                    aiResponse = JSON.parse(clean);
                } catch(e) {
                    // If AI returned plain text (not JSON), show it directly
                    aiResponse = { reply: rawContent, notebook: { save: false }, case: { save: false }, task: { save: false }, reminder: { save: false } };
                }

                const replyText = aiResponse.reply || "à¤•à¤¾à¤°à¥à¤¯ à¤¸à¤®à¥à¤ªà¤¨à¥à¤¨ à¤¹à¥à¤†à¥¤";
                chatHistory.push({ role: 'assistant', content: replyText });

                // â”€â”€ 5. SAVE TO FIREBASE BASED ON AI DECISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const now = new Date().toISOString();
                const savePromises = [];

                if (aiResponse.notebook?.save && aiResponse.notebook?.content) {
                    savePromises.push(addDoc(collection(db, "notebooks"), {
                        title: aiResponse.notebook.client || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        content: aiResponse.notebook.content,
                        client: aiResponse.notebook.client || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        timestamp: now
                    }));
                }

                if (aiResponse.case?.save && aiResponse.case?.content) {
                    savePromises.push(addDoc(collection(db, "notes"), {
                        title: aiResponse.case.client || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        content: aiResponse.case.content,
                        client: aiResponse.case.client || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        mobile: aiResponse.case.mobile || null,
                        timestamp: now
                    }));
                }

                if (aiResponse.task?.save && aiResponse.task?.title) {
                    savePromises.push(addDoc(collection(db, "tasks"), {
                        title: aiResponse.task.title,
                        status: "Pending",
                        client: aiResponse.task.client || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        timestamp: now
                    }));
                }

                if (aiResponse.reminder?.save && aiResponse.reminder?.title) {
                    savePromises.push(addDoc(collection(db, "reminders"), {
                        title: aiResponse.reminder.title,
                        time: aiResponse.reminder.time || "à¤œà¤²à¥à¤¦",
                        client: aiResponse.reminder.client || "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯",
                        timestamp: now
                    }));
                }

                // Save AI reply to chat
                savePromises.push(addDoc(collection(db, "chats"), {
                    role: "assistant", content: replyText, timestamp: now
                }));

                await Promise.all(savePromises);

                // â”€â”€ 6. RENDER AI REPLY â€” onSnapshot se automatically render hoga
                loadingDiv.remove();
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            } catch (err) {
                loadingDiv.remove();
                const errMsg = `âŒ à¤¤à¥à¤°à¥à¤Ÿà¤¿: ${err.message}`;
                await addDoc(collection(db, "chats"), {
                    role: "assistant", content: errMsg, timestamp: new Date().toISOString()
                });
            } finally {
                isProcessing = false;
                ui.userInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
                ui.userInput.focus();
            }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
