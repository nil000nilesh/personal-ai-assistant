<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for chat */
        #chat-box::-webkit-scrollbar { width: 6px; }
        #chat-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans text-gray-800">

    <div id="login-screen" class="flex flex-col h-screen items-center justify-center bg-gray-100">
        <h1 class="text-3xl font-bold mb-8 text-slate-800">My AI Assistant</h1>
        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold shadow-lg transition-all">
            Login with Google
        </button>
    </div>

    <div id="pin-screen" class="hidden flex-col h-screen items-center justify-center bg-gray-100">
        <h2 class="text-2xl mb-6 font-semibold text-slate-800">Enter 4-Digit PIN</h2>
        <input type="password" id="pin-input" maxlength="4" class="border-2 border-gray-400 p-3 text-center text-3xl tracking-[1em] text-black rounded mb-6 w-48 outline-none focus:border-blue-500 shadow-sm" />
        <button id="verify-pin-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg shadow font-medium">
            Verify Access
        </button>
    </div>

    <div id="chat-screen" class="hidden flex-col h-screen bg-gray-50">
        <div class="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md">
            <h1 class="text-lg font-bold">Personal AI Assistant</h1>
            <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 px-4 py-2 rounded font-medium transition-colors">Logout</button>
        </div>
        
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col">
            </div>

        <div class="p-4 bg-white border-t flex gap-3 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <input type="text" id="user-input" class="flex-1 border border-gray-300 p-3 rounded-xl text-black outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Type your message or plan..." />
            <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium shadow transition-colors">Send</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules directly from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // ðŸ›‘ IMPORTANT: PASTE YOUR KEYS HERE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733"
        };
        const OPENAI_API_KEY = "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";
        const SECRET_PIN = "5786"; // e.g., "1234"
        // ==========================================

        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        // UI Elements
        const loginScreen = document.getElementById('login-screen');
        const pinScreen = document.getElementById('pin-screen');
        const chatScreen = document.getElementById('chat-screen');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        
        let chatHistory = [];
        let isPinVerified = false;

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    loginScreen.classList.add('hidden');
                    if (!isPinVerified) {
                        pinScreen.classList.remove('hidden');
                        chatScreen.classList.add('hidden');
                    }
                } else {
                    alert("Unauthorized access! This app is restricted.");
                    signOut(auth);
                }
            } else {
                loginScreen.classList.remove('hidden');
                pinScreen.classList.add('hidden');
                chatScreen.classList.add('hidden');
                isPinVerified = false;
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- PIN Logic ---
        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            const pin = document.getElementById('pin-input').value;
            if (pin === SECRET_PIN) {
                isPinVerified = true;
                pinScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                chatScreen.classList.add('flex');
                loadChatHistory();
            } else {
                alert("Incorrect PIN");
                document.getElementById('pin-input').value = "";
            }
        });

        // --- Chat & Database Logic ---
        function loadChatHistory() {
            const q = query(collection(db, "chats"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                chatHistory = [];
                chatBox.innerHTML = ""; // Clear box before reloading
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to bottom
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl max-w-[85%] leading-relaxed ${
                role === 'user' 
                ? 'bg-blue-600 text-white rounded-br-none shadow-sm' 
                : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none shadow-sm'
            }`;
            bubble.textContent = content;
            
            div.appendChild(bubble);
            chatBox.appendChild(div);
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. Show user message instantly
            userInput.value = "";
            const userMsg = { role: "user", content: text, timestamp: new Date().toISOString() };
            await addDoc(collection(db, "chats"), userMsg);

            // 2. Add loading indicator
            const loadingId = "loading-" + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = "text-gray-500 text-sm ml-2 italic";
            loadingDiv.textContent = "Assistant is thinking...";
            chatBox.appendChild(loadingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            // 3. Call OpenAI API directly
            try {
                // System message sets the context
                const systemPrompt = {
                    role: "system",
                    content: "You are a highly capable personal AI assistant for Nilesh, a Credit Manager at Bank of Baroda. Help him with daily planning, task management, and provide practical, concise advice."
                };

                // Combine system prompt with history and new message
                const apiMessages = [systemPrompt, ...chatHistory, { role: "user", content: text }];

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: apiMessages
                    })
                });

                const data = await response.json();
                const aiReply = data.choices[0].message.content;

                // 4. Save AI reply to Firebase
                await addDoc(collection(db, "chats"), { 
                    role: "assistant", 
                    content: aiReply, 
                    timestamp: new Date().toISOString() 
                });

            } catch (error) {
                console.error("OpenAI Error:", error);
                alert("Failed to get response from AI. Check console for details.");
            } finally {
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.remove();
            }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>

</html>
