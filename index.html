<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-btn.active { background: #1e293b; color: #fff; border-left: 4px solid #3b82f6; }
        .tab-btn-mob.active { color: #2563eb; font-weight: 700; border-bottom: 3px solid #2563eb; }
        .toast { animation: slideIn .25s ease-out; }
        @keyframes slideIn { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-[100dvh] overflow-hidden flex flex-col">
    <div id="login-screen" class="absolute inset-0 z-50 flex items-center justify-center bg-white p-4">
        <div class="p-8 rounded-2xl shadow-xl border bg-white w-full max-w-sm text-center">
            <h1 class="text-3xl font-extrabold text-slate-800">My AI Steno</h1>
            <p class="text-sm text-gray-500 mt-1 mb-6">Record-first Assistant</p>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold">Sign in with Google</button>
        </div>
    </div>

    <div id="pin-screen" class="hidden absolute inset-0 z-50 flex-col items-center justify-center bg-slate-900 text-white">
        <h2 class="text-2xl mb-4">Enter Security PIN</h2>
        <input id="pin-input" type="password" maxlength="4" class="bg-slate-800 border-2 border-slate-700 p-4 text-center text-3xl tracking-[0.5em] rounded-xl mb-4 w-56" />
        <button id="verify-pin-btn" class="bg-blue-600 hover:bg-blue-500 px-8 py-2 rounded-xl">Unlock</button>
    </div>

    <div id="app-layout" class="hidden flex-1 md:flex-row flex-col h-full">
        <nav class="hidden md:flex w-64 bg-slate-900 text-slate-300 flex-col">
            <div class="p-5 border-b border-slate-800"><h2 class="text-white font-bold text-xl">My AI Steno</h2></div>
            <div class="flex-1 p-3 space-y-1">
                <button id="tab-chat-desk" class="tab-btn active w-full text-left px-4 py-3 rounded-lg">Chat</button>
                <button id="tab-notes-desk" class="tab-btn w-full text-left px-4 py-3 rounded-lg">Client Cases</button>
                <button id="tab-reminders-desk" class="tab-btn w-full text-left px-4 py-3 rounded-lg">Reminders</button>
                <button id="tab-notebook-desk" class="tab-btn w-full text-left px-4 py-3 rounded-lg">Notebook</button>
                <button id="tab-tasks-desk" class="tab-btn w-full text-left px-4 py-3 rounded-lg">Tasks</button>
            </div>
            <div class="p-3 border-t border-slate-800"><button id="logout-btn-desk" class="w-full text-red-400 bg-red-500/10 py-2 rounded-lg">Log Out</button></div>
        </nav>

        <main class="flex-1 relative overflow-hidden">
            <header class="md:hidden bg-slate-900 text-white p-3 flex items-center justify-between">
                <h1 class="font-bold">My AI Steno</h1>
                <button id="logout-btn-mob" class="text-xs bg-slate-800 px-3 py-1 rounded">Logout</button>
            </header>

            <section id="view-chat" class="absolute inset-0 md:top-0 top-[52px] md:bottom-0 bottom-[60px] flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                <div class="p-3 bg-white border-t">
                    <div class="max-w-4xl mx-auto flex gap-2">
                        <input id="user-input" class="flex-1 bg-gray-100 p-3 rounded-xl" placeholder="Data save karo ya records pucho..." />
                        <button id="send-btn" class="bg-blue-600 text-white px-5 rounded-xl">Send</button>
                    </div>
                </div>
            </section>

            <section id="view-notes" class="hidden absolute inset-0 md:top-0 top-[52px] md:bottom-0 bottom-[60px] overflow-y-auto p-4">
                <h2 class="text-2xl font-bold mb-4">Client Cases</h2>
                <div id="notes-grid" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </section>

            <section id="view-reminders" class="hidden absolute inset-0 md:top-0 top-[52px] md:bottom-0 bottom-[60px] overflow-y-auto p-4 space-y-4">
                <h2 class="text-2xl font-bold">Reminders</h2>
                <div class="bg-white p-4 rounded-xl border space-y-2">
                    <input id="reminder-title" class="w-full bg-gray-100 p-2 rounded" placeholder="Reminder title" />
                    <input id="reminder-datetime" type="datetime-local" class="w-full bg-gray-100 p-2 rounded" />
                    <button id="add-reminder-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Add Reminder</button>
                </div>
                <div id="reminders-list" class="space-y-2"></div>
            </section>

            <section id="view-notebook" class="hidden absolute inset-0 md:top-0 top-[52px] md:bottom-0 bottom-[60px] overflow-y-auto p-4 space-y-4">
                <h2 class="text-2xl font-bold">Notebook</h2>
                <div class="bg-white p-4 rounded-xl border space-y-2">
                    <input id="notebook-title" class="w-full bg-gray-100 p-2 rounded" placeholder="Note heading" />
                    <textarea id="notebook-content" class="w-full bg-gray-100 p-2 rounded h-28" placeholder="Jaise human note karta hai waise likho..."></textarea>
                    <button id="add-notebook-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save Note</button>
                </div>
                <div id="notebook-list" class="space-y-3"></div>
            </section>

            <section id="view-tasks" class="hidden absolute inset-0 md:top-0 top-[52px] md:bottom-0 bottom-[60px] overflow-y-auto p-4 space-y-4">
                <h2 class="text-2xl font-bold">Task Assignments</h2>
                <div class="bg-white p-4 rounded-xl border grid md:grid-cols-4 gap-2">
                    <input id="task-title" class="bg-gray-100 p-2 rounded" placeholder="Task" />
                    <input id="task-assignee" class="bg-gray-100 p-2 rounded" placeholder="Assigned to" />
                    <input id="task-due" type="datetime-local" class="bg-gray-100 p-2 rounded" />
                    <button id="add-task-btn" class="bg-blue-600 text-white rounded-lg">Add Task</button>
                </div>
                <div id="tasks-list" class="space-y-2"></div>
            </section>
        </main>

        <nav class="md:hidden absolute bottom-0 w-full bg-white border-t h-[60px] flex text-xs">
            <button id="tab-chat-mob" class="tab-btn-mob active flex-1">Chat</button>
            <button id="tab-notes-mob" class="tab-btn-mob flex-1">Cases</button>
            <button id="tab-reminders-mob" class="tab-btn-mob flex-1">Remind</button>
            <button id="tab-notebook-mob" class="tab-btn-mob flex-1">Notes</button>
            <button id="tab-tasks-mob" class="tab-btn-mob flex-1">Tasks</button>
        </nav>
    </div>

    <div id="toast-wrap" class="fixed z-50 right-3 top-3 space-y-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU", authDomain: "ai-assistant-app-8e733.firebaseapp.com", projectId: "ai-assistant-app-8e733", storageBucket: "ai-assistant-app-8e733.firebasestorage.app", messagingSenderId: "318215944760", appId: "1:318215944760:web:2a387b7bcd068da4ff44cd" };
        const SECRET_PIN = "5786";
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let sessionStartTime = new Date().toISOString();
        let allSavedNotes = [];
        let reminders = [];
        const notified = new Set();

        const views = ['chat','notes','reminders','notebook','tasks'];
        const viewEls = Object.fromEntries(views.map(v => [v, document.getElementById(`view-${v}`)]));

        function switchView(view) {
            views.forEach(v => {
                viewEls[v].classList.toggle('hidden', v !== view);
                if (v === view) viewEls[v].classList.add('flex'); else viewEls[v].classList.remove('flex');
                document.getElementById(`tab-${v}-desk`)?.classList.toggle('active', v === view);
                document.getElementById(`tab-${v}-mob`)?.classList.toggle('active', v === view);
            });
        }

        views.forEach(v => {
            document.getElementById(`tab-${v}-desk`)?.addEventListener('click', () => switchView(v));
            document.getElementById(`tab-${v}-mob`)?.addEventListener('click', () => switchView(v));
        });

        function hideAll() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('pin-screen').classList.add('hidden');
            document.getElementById('app-layout').classList.add('hidden');
        }

        async function handleLogin() {
            const btn = document.getElementById('login-btn');
            btn.textContent = 'Signing in...';
            try { await signInWithPopup(auth, provider); }
            catch (e) {
                if (["auth/popup-blocked", "auth/cancelled-popup-request", "auth/popup-closed-by-user"].includes(e.code)) await signInWithRedirect(auth, provider);
                else alert(`Login failed: ${e.message}`);
            }
            btn.textContent = 'Sign in with Google';
        }
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        getRedirectResult(auth).catch(e => alert(`Google login error: ${e.message}`));

        onAuthStateChanged(auth, (user) => {
            hideAll();
            if (!user) return document.getElementById('login-screen').classList.remove('hidden');
            if (user.email !== ALLOWED_EMAIL) { alert('Unauthorized access!'); signOut(auth); return; }
            document.getElementById('pin-screen').classList.remove('hidden');
            document.getElementById('pin-screen').classList.add('flex');
        });

        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if (document.getElementById('pin-input').value !== SECRET_PIN) return alert('Incorrect PIN');
            hideAll();
            document.getElementById('app-layout').classList.remove('hidden');
            document.getElementById('app-layout').classList.add('flex');
            sessionStartTime = new Date().toISOString();
            loadAllData();
        });

        const doLogout = () => signOut(auth);
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        function normalize(t) { return (t || '').toLowerCase().replace(/[^a-z0-9\s]/gi, ' ').replace(/\s+/g, ' ').trim(); }
        const nowIso = () => new Date().toISOString();

        function renderMessage(role, text) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = role === 'user' ? 'bg-blue-600 text-white px-4 py-2 rounded-2xl' : 'bg-white border px-4 py-2 rounded-2xl';
            bubble.textContent = text;
            row.appendChild(bubble);
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        function toast(msg) {
            const wrap = document.getElementById('toast-wrap');
            const t = document.createElement('div');
            t.className = 'toast bg-slate-900 text-white px-4 py-2 rounded-lg shadow';
            t.textContent = msg;
            wrap.appendChild(t);
            setTimeout(() => t.remove(), 6000);
        }

        function findClientNotesByName(text) {
            const q = normalize(text);
            return allSavedNotes.filter(n => {
                const title = normalize(n.title);
                return title && (q.includes(title) || title.split(' ').every(p => q.includes(p)));
            }).sort((a,b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
        }

        function answerFromRecords(text) {
            const q = text.trim();

            const clientMatch = q.match(/^([a-zA-Z\s]{3,})\s+ka\s+/i);
            const looksLikeUpdate = /(loan|amount|mobile|number|scheme|status|address|emi|pmmy)/i.test(q) && !/\?/.test(q);
            if (clientMatch && looksLikeUpdate) {
                const title = clientMatch[1].trim();
                return { type: 'save-note', title, content: q };
            }

            const notes = findClientNotesByName(q);
            if (notes.length) {
                if (/(loan\s*amount|amount|kitna|kitana|kitne|raashi|rashi)/i.test(q)) {
                    for (const n of notes) {
                        const m = (n.content || '').match(/(?:₹|rs\.?|inr)?\s*([0-9][0-9,]{2,})/i);
                        if (m) return { type: 'answer', text: `${n.title} ka loan amount ₹${Number(m[1].replace(/,/g,'')).toLocaleString('en-IN')} hai (saved record).` };
                    }
                    return { type: 'answer', text: `${notes[0].title} ke saved record me clear loan amount nahi mila.` };
                }
                if (/(mobile|phone|contact|number|no\.?)/i.test(q)) {
                    for (const n of notes) {
                        const m = (n.content || '').match(/(?:\+91[-\s]?)?([6-9]\d{9})/);
                        if (m) return { type: 'answer', text: `${n.title} ka mobile number ${m[1]} hai (saved record).` };
                    }
                    return { type: 'answer', text: `${notes[0].title} ke saved record me mobile number nahi mila.` };
                }
                return { type: 'answer', text: `${notes[0].title} ke saved records me ye mila: ${notes[0].content}` };
            }

            return { type: 'refuse', text: 'Mujhe ye information saved records me nahi mili, isliye main answer nahi de sakta.' };
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            await addDoc(collection(db, 'chats'), { role: 'user', content: text, timestamp: nowIso() });

            const result = answerFromRecords(text);
            if (result.type === 'save-note') {
                await addDoc(collection(db, 'notes'), { title: result.title, content: result.content, timestamp: nowIso() });
                await addDoc(collection(db, 'chats'), { role: 'assistant', content: `Maine ${result.title} ki file me note kar liya hai.`, timestamp: nowIso() });
                return;
            }
            await addDoc(collection(db, 'chats'), { role: 'assistant', content: result.text, timestamp: nowIso() });
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

        async function addReminder() {
            const title = document.getElementById('reminder-title').value.trim();
            const due = document.getElementById('reminder-datetime').value;
            if (!title || !due) return alert('Reminder title aur time dono chahiye.');
            await addDoc(collection(db, 'reminders'), { title, dueAt: new Date(due).toISOString(), timestamp: nowIso() });
            document.getElementById('reminder-title').value = '';
            document.getElementById('reminder-datetime').value = '';
        }
        document.getElementById('add-reminder-btn').addEventListener('click', addReminder);

        async function addNotebook() {
            const title = document.getElementById('notebook-title').value.trim();
            const content = document.getElementById('notebook-content').value.trim();
            if (!title || !content) return alert('Notebook title aur content dono chahiye.');
            await addDoc(collection(db, 'notebook_entries'), { title, content, timestamp: nowIso() });
            document.getElementById('notebook-title').value = '';
            document.getElementById('notebook-content').value = '';
        }
        document.getElementById('add-notebook-btn').addEventListener('click', addNotebook);

        async function addTask() {
            const title = document.getElementById('task-title').value.trim();
            const assignee = document.getElementById('task-assignee').value.trim();
            const due = document.getElementById('task-due').value;
            if (!title || !assignee || !due) return alert('Task, assignee, due time required.');
            await addDoc(collection(db, 'tasks'), { title, assignee, dueAt: new Date(due).toISOString(), status: 'pending', timestamp: nowIso() });
            document.getElementById('task-title').value = '';
            document.getElementById('task-assignee').value = '';
            document.getElementById('task-due').value = '';
        }
        document.getElementById('add-task-btn').addEventListener('click', addTask);

        function renderNotes() {
            const wrap = document.getElementById('notes-grid');
            wrap.innerHTML = '';
            const grouped = {};
            allSavedNotes.forEach(n => {
                const k = (n.title || 'Unknown').toUpperCase();
                grouped[k] = grouped[k] || { title: n.title || 'Unknown', items: [] };
                grouped[k].items.push(n);
            });
            Object.values(grouped).forEach(g => {
                g.items.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl border p-4';
                card.innerHTML = `<h3 class="font-bold mb-2">${g.title}</h3>${g.items.map(i => `<p class="text-sm mb-2">• ${i.content}</p>`).join('')}`;
                wrap.appendChild(card);
            });
        }

        function loadAllData() {
            onSnapshot(query(collection(db, 'chats'), where('timestamp', '>=', sessionStartTime), orderBy('timestamp', 'asc')), (snap) => {
                const box = document.getElementById('chat-box'); box.innerHTML='';
                snap.forEach(d => renderMessage(d.data().role, d.data().content));
            });

            onSnapshot(query(collection(db, 'notes'), orderBy('timestamp', 'asc')), (snap) => {
                allSavedNotes = [];
                snap.forEach(d => allSavedNotes.push(d.data()));
                renderNotes();
            });

            onSnapshot(query(collection(db, 'reminders'), orderBy('dueAt', 'asc')), (snap) => {
                reminders = [];
                const list = document.getElementById('reminders-list');
                list.innerHTML = '';
                snap.forEach(d => reminders.push({ id: d.id, ...d.data() }));
                reminders.forEach(r => {
                    const el = document.createElement('div');
                    el.className = 'bg-white border rounded-lg p-3';
                    el.textContent = `${r.title} — ${new Date(r.dueAt).toLocaleString()}`;
                    list.appendChild(el);
                });
            });

            onSnapshot(query(collection(db, 'notebook_entries'), orderBy('timestamp', 'desc')), (snap) => {
                const list = document.getElementById('notebook-list'); list.innerHTML = '';
                snap.forEach(d => {
                    const n = d.data();
                    const el = document.createElement('div');
                    el.className = 'bg-white border rounded-xl p-4';
                    el.innerHTML = `<h3 class="font-semibold">${n.title}</h3><p class="text-sm text-gray-500 mb-2">${new Date(n.timestamp).toLocaleString()}</p><p class="whitespace-pre-wrap">${n.content}</p>`;
                    list.appendChild(el);
                });
            });

            onSnapshot(query(collection(db, 'tasks'), orderBy('dueAt', 'asc')), (snap) => {
                const list = document.getElementById('tasks-list'); list.innerHTML = '';
                snap.forEach(d => {
                    const t = d.data();
                    const el = document.createElement('div');
                    el.className = 'bg-white border rounded-lg p-3';
                    el.innerHTML = `<p class="font-medium">${t.title}</p><p class="text-sm text-gray-600">Assigned: ${t.assignee} | Due: ${new Date(t.dueAt).toLocaleString()} | Status: ${t.status || 'pending'}</p>`;
                    list.appendChild(el);
                });
            });
        }

        setInterval(() => {
            const now = Date.now();
            reminders.forEach(r => {
                if (new Date(r.dueAt).getTime() <= now && !notified.has(r.id)) {
                    notified.add(r.id);
                    toast(`⏰ Reminder: ${r.title}`);
                }
            });
        }, 15000);
    </script>
</body>
</html>
