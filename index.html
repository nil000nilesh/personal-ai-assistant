<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Steno Pro - Case Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .devanagari { font-family: 'Noto Sans Devanagari', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-btn.active { color: #60a5fa; font-weight: 700; }
        .tab-btn-mob.active { color: #3b82f6; font-weight: bold; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .recording { animation: pulse-ring 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        
        .client-updates-scroll::-webkit-scrollbar { width: 4px; }
        .client-updates-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

        .notebook-page {
            background-image: repeating-linear-gradient(transparent, transparent 27px, #f1f5f9 27px, #f1f5f9 28px);
            line-height: 28px;
            padding-top: 2px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .modal-open { opacity: 1; visibility: visible; }
        .modal-closed { opacity: 0; visibility: hidden; }
        .modal-content-open { transform: translateY(0) scale(1); }
        .modal-content-closed { transform: translateY(100px) scale(0.95); }

        /* ‚îÄ‚îÄ COLLAPSIBLE SIDEBAR ‚îÄ‚îÄ */
        #sidebar {
            width: 68px;
            transition: width 0.28s cubic-bezier(0.4,0,0.2,1);
            overflow: hidden;
            flex-shrink: 0;
        }
        #sidebar.expanded { width: 230px; }
        #sidebar .label-text { opacity: 0; width: 0; overflow: hidden; white-space: nowrap; transition: opacity 0.2s, width 0.28s; }
        #sidebar.expanded .label-text { opacity: 1; width: auto; }
        #sidebar .logo-text { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s, width 0.28s; }
        #sidebar.expanded .logo-text { opacity: 1; width: auto; }
        #sidebar .logout-text { display: none; }
        #sidebar.expanded .logout-text { display: inline; }
        #sidebar .tab-btn { justify-content: center; }
        #sidebar.expanded .tab-btn { justify-content: flex-start; }
        #sidebar .tab-btn.active { border-left: 3px solid #60a5fa; background: rgba(255,255,255,0.08); }
        #sidebar .tab-btn:not(.active) { border-left: 3px solid transparent; }

        /* Tooltip on collapsed */
        #sidebar:not(.expanded) .nav-item { position: relative; }
        #sidebar:not(.expanded) .nav-item:hover::after {
            content: attr(data-label);
            position: absolute;
            left: 68px;
            top: 50%;
            transform: translateY(-50%);
            background: #1e293b;
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 10px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        #sidebar:not(.expanded) .nav-item:hover::before {
            content: '';
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1e293b;
            z-index: 100;
        }

        /* ‚îÄ‚îÄ APP BACKGROUND ‚îÄ‚îÄ */
        #app-layout {
            background: #f0f4ff;
            background-image:
                radial-gradient(ellipse at 20% 20%, rgba(99,102,241,0.07) 0%, transparent 55%),
                radial-gradient(ellipse at 80% 80%, rgba(59,130,246,0.06) 0%, transparent 55%),
                radial-gradient(ellipse at 60% 10%, rgba(139,92,246,0.05) 0%, transparent 40%);
        }
        /* Toolbar glass effect */
        .toolbar-glass {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(99,102,241,0.08);
        }
        /* Content cards subtle shadow upgrade */
        #notebook-grid > *, #notes-grid > *, #tasks-list > *, #reminders-list > * {
            box-shadow: 0 2px 12px rgba(99,102,241,0.07), 0 1px 3px rgba(0,0,0,0.05);
        }
        @keyframes fabPulse {
            0%   { transform: scale(1); opacity: 0.8; }
            50%  { transform: scale(1.18); opacity: 0.3; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.4; }
        }
        #mic-btn.recording {
            background: #fee2e2 !important;
            animation: micPulse 1s infinite;
        }
        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
            50%       { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
        }
        #chat-box::-webkit-scrollbar { width: 4px; }
        #chat-box::-webkit-scrollbar-track { background: transparent; }
        #chat-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #activity-feed::-webkit-scrollbar { width: 3px; }
        #activity-feed::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] overflow-hidden flex flex-col selection:bg-blue-200">

    <div id="login-screen" class="absolute inset-0 z-[100] flex overflow-hidden">
        <!-- Left panel ‚Äî branding -->
        <div class="hidden md:flex flex-col justify-between w-1/2 bg-gradient-to-br from-slate-900 via-blue-950 to-indigo-900 p-12 relative overflow-hidden">
            <!-- Decorative circles -->
            <div class="absolute -top-24 -left-24 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -right-24 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl"></div>
            <!-- Logo + name -->
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-16">
                    <div class="w-11 h-11 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </div>
                    <span class="text-white font-black text-xl tracking-tight">CaseDesk <span class="text-blue-400">AI</span></span>
                </div>
                <h2 class="text-5xl font-black text-white leading-tight mb-4">Your AI-Powered<br/><span class="text-blue-400">Case Manager</span></h2>
                <p class="text-slate-400 text-base leading-relaxed max-w-sm">Banking cases, tasks aur reminders ‚Äî sab kuch ek jagah. AI se boliye, automatically ho jata hai.</p>
            </div>
            <!-- Feature list -->
            <div class="relative z-10 space-y-4">
                <div class="flex items-center gap-3 text-slate-300 text-sm"><div class="w-8 h-8 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400">üìã</div> Smart case notes ‚Äî Hindi mein, auto-draft</div>
                <div class="flex items-center gap-3 text-slate-300 text-sm"><div class="w-8 h-8 bg-indigo-500/20 rounded-xl flex items-center justify-center text-indigo-400">‚è∞</div> Smart reminders with overdue alerts</div>
                <div class="flex items-center gap-3 text-slate-300 text-sm"><div class="w-8 h-8 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-400">ü§ñ</div> GPT-4.1 powered AI assistant</div>
            </div>
        </div>
        <!-- Right panel ‚Äî login form -->
        <div class="flex-1 flex flex-col items-center justify-center bg-white px-8 md:px-16">
            <!-- Mobile logo -->
            <div class="md:hidden flex items-center gap-2 mb-10">
                <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                </div>
                <span class="font-black text-xl text-slate-900 tracking-tight">CaseDesk <span class="text-blue-500">AI</span></span>
            </div>
            <div class="w-full max-w-sm">
                <h3 class="text-3xl font-black text-slate-900 mb-2">Welcome back</h3>
                <p class="text-slate-500 text-sm mb-10">Sign in to access your dashboard</p>
                <button id="login-btn" class="w-full bg-white border-2 border-slate-200 hover:border-blue-300 hover:bg-blue-50 text-slate-700 px-6 py-4 rounded-2xl font-bold shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-3 text-sm group">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                    <svg class="w-4 h-4 text-slate-400 group-hover:text-blue-500 ml-auto transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </button>
                <div class="mt-8 flex items-center gap-3 text-xs text-slate-400">
                    <div class="flex-1 h-px bg-slate-100"></div>
                    <span>Private & Secure</span>
                    <div class="flex-1 h-px bg-slate-100"></div>
                </div>
                <div class="mt-6 grid grid-cols-3 gap-3 text-center text-[11px] text-slate-500">
                    <div class="bg-slate-50 rounded-xl p-3"><div class="text-lg mb-1">üîí</div>Encrypted</div>
                    <div class="bg-slate-50 rounded-xl p-3"><div class="text-lg mb-1">‚òÅÔ∏è</div>Cloud Sync</div>
                    <div class="bg-slate-50 rounded-xl p-3"><div class="text-lg mb-1">ü§ñ</div>AI Powered</div>
                </div>
            </div>
        </div>
    </div>

    <div id="pin-screen" class="hidden absolute inset-0 z-[100] flex-col items-center justify-center bg-slate-900 text-white bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&q=80&w=1920')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div class="flex items-center gap-2 mb-8">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                </div>
                <span class="font-black text-xl text-white">CaseDesk <span class="text-blue-400">AI</span></span>
            </div>
            <div class="w-14 h-14 bg-white/10 rounded-2xl flex items-center justify-center mb-5 border border-white/10">üîê</div>
            <h2 class="text-xl mb-2 font-bold tracking-wide text-white">Enter Security PIN</h2>
            <p class="text-slate-400 text-sm mb-8">Your dashboard is protected</p>
            <input type="password" id="pin-input" maxlength="4" class="bg-slate-800/50 border-2 border-slate-600 p-4 text-center text-5xl tracking-[0.5em] text-white rounded-2xl mb-8 w-64 outline-none focus:border-blue-500 transition-colors shadow-inner backdrop-blur-sm" />
            <button id="verify-pin-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-xl shadow-lg shadow-blue-500/30 font-bold transition-all hover:-translate-y-1">Unlock Dashboard</button>
        </div>
    </div>

    <div id="app-layout" class="hidden flex-1 flex-col md:flex-row w-full h-full relative">
        
        <!-- COLLAPSIBLE SIDEBAR -->
        <nav id="sidebar" class="hidden md:flex flex-col bg-slate-900 text-slate-300 shadow-2xl z-20 relative"
             onmouseenter="this.classList.add('expanded')"
             onmouseleave="this.classList.remove('expanded')">

            <!-- Logo row -->
            <div class="h-16 border-b border-white/5 flex items-center px-3.5 gap-3 flex-shrink-0 overflow-hidden">
                <div class="w-9 h-9 flex-shrink-0 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <svg class="w-5 h-5 text-white flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                </div>
                <div class="logo-text flex-shrink-0">
                    <div class="text-sm font-black text-white tracking-tight leading-tight">CaseDesk <span class="text-blue-400">AI</span></div>
                    <div class="text-[9px] text-slate-500 font-semibold">GPT-4.1 Powered</div>
                </div>
            </div>

            <!-- Nav items -->
            <div class="flex-1 py-4 flex flex-col gap-1 px-2 overflow-hidden">
                <div class="nav-item" data-label="Notebook">
                    <button id="tab-notebook-desk" class="tab-btn active w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        <span class="label-text text-sm">Notebook</span>
                    </button>
                </div>
                <div class="nav-item" data-label="Client Cases">
                    <button id="tab-notes-desk" class="tab-btn w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span class="label-text text-sm">Client Cases</span>
                    </button>
                </div>
                <div class="nav-item" data-label="Tasks">
                    <button id="tab-tasks-desk" class="tab-btn w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                        <span class="label-text text-sm">Tasks</span>
                    </button>
                </div>
                <div class="nav-item" data-label="Reminders">
                    <button id="tab-reminders-desk" class="tab-btn w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        <span class="label-text text-sm">Reminders</span>
                    </button>
                </div>
            </div>

            <!-- Logout -->
            <div class="p-2 border-t border-white/5 flex-shrink-0">
                <div class="nav-item" data-label="Logout">
                    <button id="logout-btn-desk" class="w-full h-11 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl font-medium transition-colors flex items-center gap-3 px-2.5 justify-center">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        <span class="label-text logout-text text-sm">Logout</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-1 relative flex flex-col h-full overflow-hidden" style="background:transparent">
            <header class="md:hidden bg-white border-b border-slate-200 px-5 py-4 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                        <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </div>
                    <h1 class="text-base font-black text-slate-900 tracking-tight">CaseDesk <span class="text-blue-500">AI</span></h1>
                </div>
                <button id="logout-btn-mob" class="text-xs bg-slate-100 text-slate-600 px-3 py-2 rounded-lg font-medium">Logout</button>
            </header>

            <div id="view-notebook" class="absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex flex-col overflow-hidden">
                <!-- Sticky toolbar -->
                <div class="toolbar-glass px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">üìì My Notebook</h2>
                            <span id="nb-count" class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">0 notes</span>
                        </div>
                        <!-- Search + Sort + Filter row -->
                        <div class="flex flex-wrap gap-2 items-center">
                            <div class="relative flex-1 min-w-[180px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                                <input id="nb-search" type="text" placeholder="Search notes..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 focus:bg-white transition"/>
                            </div>
                            <select id="nb-sort" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 focus:outline-none focus:border-blue-400 text-slate-600">
                                <option value="new">üïê Newest First</option>
                                <option value="old">üìÖ Oldest First</option>
                                <option value="az">üî§ A ‚Üí Z</option>
                            </select>
                            <select id="nb-filter" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 focus:outline-none focus:border-blue-400 text-slate-600">
                                <option value="all">üìÇ All Clients</option>
                            </select>
                            <button id="nb-view-toggle" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 hover:bg-blue-50 hover:border-blue-300 text-slate-600 transition" title="Toggle view">‚äû Grid</button>
                        </div>
                    </div>
                </div>
                <!-- Scrollable grid -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8">
                    <div class="max-w-6xl mx-auto">
                        <div id="notebook-grid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 items-start"></div>
                        <div id="nb-empty" class="hidden text-center py-20 text-slate-400">
                            <div class="text-5xl mb-3">üì≠</div>
                            <p class="font-semibold">No notes found</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-notes" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">Client Cases</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Har client ki history aur latest updates ka record.</p>
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20"></div>
                </div>
            </div>

            <div id="view-tasks" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-hidden">
                <!-- Tasks Toolbar -->
                <div class="toolbar-glass px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">‚úÖ My Tasks</h2>
                            <div class="flex items-center gap-2">
                                <span id="task-pending-count" class="text-xs font-black text-orange-600 bg-orange-50 border border-orange-200 px-3 py-1 rounded-full">0 Pending</span>
                                <span id="task-done-count" class="text-xs font-black text-green-600 bg-green-50 border border-green-200 px-3 py-1 rounded-full">0 Done</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative flex-1 min-w-[160px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                                <input id="task-search" type="text" placeholder="Search tasks..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 focus:bg-white transition"/>
                            </div>
                            <div id="task-filter-btns" class="flex gap-1.5">
                                <button data-filter="all" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600">All</button>
                                <button data-filter="Pending" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-orange-50 hover:border-orange-200 hover:text-orange-700">‚è≥ Pending</button>
                                <button data-filter="Done" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-green-50 hover:border-green-200 hover:text-green-700">‚úÖ Done</button>
                                <button data-filter="Urgent" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-red-50 hover:border-red-200 hover:text-red-700">üö® Urgent</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 md:px-10 py-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="tasks-list" class="flex flex-col gap-3 pb-20"></div>
                        <div id="task-empty" class="hidden text-center py-20 text-slate-400"><div class="text-5xl mb-3">üéâ</div><p class="font-semibold">Koi task nahi! Sab clear hai.</p></div>
                    </div>
                </div>
            </div>

            <div id="view-reminders" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-hidden">
                <!-- Reminders Toolbar -->
                <div class="toolbar-glass px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">‚è∞ Reminders</h2>
                            <div class="flex gap-2">
                                <span id="rem-upcoming-count" class="text-xs font-black text-blue-700 bg-blue-50 border border-blue-200 px-3 py-1 rounded-full">0 Upcoming</span>
                                <span id="rem-overdue-count" class="text-xs font-black text-red-700 bg-red-50 border border-red-200 px-3 py-1 rounded-full">0 Overdue</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative flex-1 min-w-[160px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                                <input id="rem-search" type="text" placeholder="Search reminders..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 transition"/>
                            </div>
                            <div class="flex gap-1.5">
                                <button data-remfilter="all" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600">All</button>
                                <button data-remfilter="today" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-blue-50">üìÖ Today</button>
                                <button data-remfilter="upcoming" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-green-50">üü¢ Upcoming</button>
                                <button data-remfilter="overdue" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-red-50">üî¥ Overdue</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 md:px-10 py-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="reminders-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div>
                        <div id="rem-empty" class="hidden text-center py-20 text-slate-400"><div class="text-5xl mb-3">üóìÔ∏è</div><p class="font-semibold">Koi reminder nahi.</p></div>
                    </div>
                </div>
            </div>

            <!-- DRAGGABLE FAB -->
            <div id="chat-fab" style="position:fixed;bottom:28px;right:24px;z-index:200;cursor:grab;user-select:none;">
                <button id="open-chat-fab" style="width:62px;height:62px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#2563eb);box-shadow:0 8px 32px rgba(79,70,229,0.45);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;position:relative;" title="CaseDesk AI">
                    <!-- AI Icon SVG -->
                    <svg width="28" height="28" viewBox="0 0 40 40" fill="none">
                        <circle cx="20" cy="20" r="20" fill="white" fill-opacity="0.15"/>
                        <rect x="10" y="14" width="20" height="14" rx="5" fill="white"/>
                        <circle cx="15" cy="21" r="2.5" fill="#4f46e5"/>
                        <circle cx="25" cy="21" r="2.5" fill="#4f46e5"/>
                        <rect x="17" y="24" width="6" height="1.5" rx="0.75" fill="#4f46e5"/>
                        <rect x="15" y="10" width="2" height="4" rx="1" fill="white"/>
                        <rect x="23" y="10" width="2" height="4" rx="1" fill="white"/>
                        <circle cx="15" cy="9.5" r="1.5" fill="white"/>
                        <circle cx="25" cy="9.5" r="1.5" fill="white"/>
                    </svg>
                    <!-- Notification badge -->
                    <span id="fab-badge" style="display:none;position:absolute;top:-3px;right:-3px;min-width:18px;height:18px;background:#ef4444;border-radius:9px;border:2px solid #fff;font-size:10px;font-weight:900;color:white;align-items:center;justify-content:center;padding:0 3px;">0</span>
                    <!-- Pulse ring -->
                    <span style="position:absolute;inset:-4px;border-radius:50%;border:2px solid rgba(79,70,229,0.4);animation:fabPulse 2.5s infinite;pointer-events:none;"></span>
                </button>
            </div>
        </main>

        <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex items-center justify-around h-[65px] pb-1 shadow-[0_-10px_20px_rgba(0,0,0,0.03)] z-[30]">
            <button id="tab-notebook-mob" class="tab-btn-mob active flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">üìì</span> Notebook
            </button>
            <button id="tab-notes-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">üìÇ</span> Cases
            </button>
            <button id="tab-tasks-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">‚úÖ</span> Tasks
            </button>
            <button id="tab-reminders-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">‚è∞</span> Reminds
            </button>
        </nav>
    </div>

    <!-- FLOATING CHAT PANEL ‚Äî Draggable, Right-side, Modern -->
    <div id="chat-panel" style="
        display:none;
        position:fixed;
        bottom:100px;
        right:20px;
        width:390px;
        height:580px;
        z-index:500;
        border-radius:20px;
        box-shadow:0 24px 60px rgba(0,0,0,0.18),0 4px 16px rgba(79,70,229,0.12);
        overflow:hidden;
        border:1px solid rgba(255,255,255,0.8);
        background:#f8faff;
        display:none;
        flex-direction:column;
        transition:opacity 0.2s,transform 0.2s;
        min-width:320px;min-height:400px;
    ">
        <!-- RESIZE HANDLE -->
        <div id="chat-resize" style="position:absolute;bottom:0;left:0;right:0;height:6px;cursor:ns-resize;z-index:10;background:transparent;"></div>

        <!-- HEADER ‚Äî Draggable -->
        <div id="chat-panel-header" style="
            background:linear-gradient(135deg,#1e1b4b 0%,#312e81 50%,#1d4ed8 100%);
            padding:14px 16px 12px;
            display:flex;align-items:center;gap:12px;
            cursor:move;flex-shrink:0;
            position:relative;overflow:hidden;
        ">
            <!-- Decorative glow -->
            <div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:rgba(139,92,246,0.2);border-radius:50%;pointer-events:none;"></div>
            <!-- AI Avatar -->
            <div style="width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;backdrop-filter:blur(8px);">
                <svg width="22" height="22" viewBox="0 0 40 40" fill="none">
                    <rect x="6" y="12" width="28" height="18" rx="6" fill="white"/>
                    <circle cx="14" cy="21" r="3" fill="#4f46e5"/>
                    <circle cx="26" cy="21" r="3" fill="#4f46e5"/>
                    <rect x="16" y="25" width="8" height="2" rx="1" fill="#4f46e5"/>
                    <rect x="13" y="7" width="3" height="5" rx="1.5" fill="white"/>
                    <rect x="24" y="7" width="3" height="5" rx="1.5" fill="white"/>
                    <circle cx="14.5" cy="6.5" r="2" fill="white"/>
                    <circle cx="25.5" cy="6.5" r="2" fill="white"/>
                </svg>
            </div>
            <!-- Title -->
            <div style="flex:1;min-width:0;">
                <div style="font-weight:800;font-size:14px;color:white;letter-spacing:-0.3px;line-height:1.2;">CaseDesk AI</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.6);margin-top:1px;display:flex;align-items:center;gap:4px;">
                    <span style="width:6px;height:6px;background:#4ade80;border-radius:50%;display:inline-block;animation:pulse 2s infinite;"></span>
                    Online ¬∑ GPT-4.1
                </div>
            </div>
            <!-- Header buttons -->
            <div style="display:flex;gap:6px;align-items:center;">
                <!-- Activity toggle -->
                <button id="toggle-activity-btn" title="Live Activity" style="width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.2)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </button>
                <!-- Minimize -->
                <button id="minimise-chat-btn" title="Minimize" style="width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.2)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <!-- Close -->
                <button id="close-chat-btn" title="Close" style="width:30px;height:30px;border-radius:8px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseenter="this.style.background='rgba(239,68,68,0.4)'" onmouseleave="this.style.background='rgba(239,68,68,0.2)'">
                    <svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </div>

        <!-- LIVE ACTIVITY BAR (collapsible) -->
        <div id="activity-bar" style="background:#fff;border-bottom:1px solid #e2e8f0;padding:8px 14px;display:none;flex-shrink:0;">
            <div style="font-size:10px;font-weight:800;color:#6366f1;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">‚ö° Live Activity</div>
            <div id="activity-feed" style="display:flex;flex-direction:column;gap:4px;max-height:90px;overflow-y:auto;">
                <div style="font-size:11px;color:#94a3b8;font-style:italic;">Koi activity nahi abhi...</div>
            </div>
        </div>

        <!-- CHAT MESSAGES -->
        <div id="chat-box" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:#f8faff;">
            <div style="display:flex;justify-content:flex-start;">
                <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;border-top-left-radius:4px;padding:12px 14px;max-width:85%;font-size:13px;line-height:1.6;color:#334155;box-shadow:0 1px 4px rgba(0,0,0,0.05);">
                    Namaste üôè ‚Äî <strong>CaseDesk AI</strong> at your service.<br/>Boliye, kya kaam hai?
                </div>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div style="padding:12px;background:white;border-top:1px solid #e2e8f0;flex-shrink:0;">
            <div style="display:flex;gap:8px;align-items:center;background:#f1f5f9;border-radius:14px;padding:6px 8px;border:1.5px solid transparent;transition:border-color 0.2s;" id="input-wrapper">
                <!-- Mic -->
                <button id="mic-btn" title="Voice Input" style="width:36px;height:36px;border-radius:10px;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s;" onmouseenter="this.style.background='#e2e8f0'" onmouseleave="this.style.background='transparent'">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#64748b" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                </button>
                <!-- Input -->
                <input type="text" id="user-input" placeholder="Kuch bhi boliye..." style="flex:1;background:transparent;border:none;outline:none;font-size:13px;color:#1e293b;font-family:inherit;font-weight:500;" />
                <!-- Send -->
                <button id="send-btn" style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#4f46e5,#2563eb);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 2px 8px rgba(79,70,229,0.35);" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                    <svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                </button>
            </div>
            <div style="text-align:center;margin-top:6px;font-size:9px;color:#cbd5e1;font-weight:600;letter-spacing:0.5px;">CASDESK AI ¬∑ GPT-4.1</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithRedirect, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733",
            storageBucket: "ai-assistant-app-8e733.firebasestorage.app",
            messagingSenderId: "318215944760",
            appId: "1:318215944760:web:2a387b7bcd068da4ff44cd"
        };
        const SECRET_PIN = "5786"; 
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let chatHistory = [];
        let allSavedNotes = []; 
        let allTasks = [];
        let allReminders = [];
        let allNotebooks = [];

        let isPinVerified = false;
        let DYNAMIC_OPENAI_KEY = "";
        let OPENAI_MODEL = "gpt-4.1"; // Firebase se override ho sakta hai
        let sessionStartTime;

        const ui = {
            login: document.getElementById('login-screen'),
            pin: document.getElementById('pin-screen'),
            appLayout: document.getElementById('app-layout'),
            viewNotes: document.getElementById('view-notes'),
            viewTasks: document.getElementById('view-tasks'),
            viewReminders: document.getElementById('view-reminders'),
            viewNotebook: document.getElementById('view-notebook'),
            chatBox: document.getElementById('chat-box'),
            notesGrid: document.getElementById('notes-grid'),
            tasksList: document.getElementById('tasks-list'),
            remindersList: document.getElementById('reminders-list'),
            notebookGrid: document.getElementById('notebook-grid'),
            userInput: document.getElementById('user-input'),
            micBtn: document.getElementById('mic-btn'),
            chatModal: document.getElementById('chat-modal'),
            chatModalContent: document.getElementById('chat-modal-content')
        };

        const views = ['notes', 'tasks', 'reminders', 'notebook'];

        // ERROR FIXED HERE: Removing flex class so it hides properly
        function hideAllStates() {
            ui.login.classList.add('hidden'); ui.login.classList.remove('flex');
            ui.pin.classList.add('hidden'); ui.pin.classList.remove('flex');
            ui.appLayout.classList.add('hidden'); ui.appLayout.classList.remove('flex');
        }

        function switchView(targetView) {
            views.forEach(v => {
                const deskBtn = document.getElementById(`tab-${v}-desk`);
                const mobBtn = document.getElementById(`tab-${v}-mob`);
                const viewEl = document.getElementById(`view-${v}`);
                if(v === targetView) {
                    viewEl.classList.remove('hidden'); viewEl.classList.add('flex');
                    if(deskBtn) deskBtn.classList.add('active');
                    if(mobBtn) mobBtn.classList.add('active');
                } else {
                    viewEl.classList.add('hidden'); viewEl.classList.remove('flex');
                    if(deskBtn) deskBtn.classList.remove('active');
                    if(mobBtn) mobBtn.classList.remove('active');
                }
            });
        }

        views.forEach(v => {
            document.getElementById(`tab-${v}-desk`)?.addEventListener('click', () => switchView(v));
            document.getElementById(`tab-${v}-mob`)?.addEventListener('click', () => switchView(v));
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  FLOATING CHAT PANEL ‚Äî Drag, Resize, Badge, Activity
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const chatPanel  = document.getElementById('chat-panel');
        const chatFab    = document.getElementById('chat-fab');
        const fabBtn     = document.getElementById('open-chat-fab');
        const fabBadge   = document.getElementById('fab-badge');
        let unreadCount  = 0;
        let panelVisible = false;

        function showPanel() {
            chatPanel.style.display = 'flex';
            chatPanel.style.opacity = '0';
            chatPanel.style.transform = 'translateY(16px) scale(0.97)';
            requestAnimationFrame(() => {
                chatPanel.style.transition = 'opacity 0.22s ease, transform 0.22s ease';
                chatPanel.style.opacity = '1';
                chatPanel.style.transform = 'translateY(0) scale(1)';
            });
            panelVisible = true;
            unreadCount = 0;
            fabBadge.style.display = 'none';
            setTimeout(() => { ui.userInput.focus(); ui.chatBox.scrollTop = ui.chatBox.scrollHeight; }, 100);
        }

        function hidePanel() {
            chatPanel.style.transition = 'opacity 0.18s ease, transform 0.18s ease';
            chatPanel.style.opacity = '0';
            chatPanel.style.transform = 'translateY(14px) scale(0.97)';
            setTimeout(() => { chatPanel.style.display = 'none'; chatPanel.style.display = ''; chatPanel.style.display = 'none'; }, 180);
            panelVisible = false;
        }

        fabBtn.addEventListener('click', (e) => {
            if(panelVisible) hidePanel(); else showPanel();
        });
        document.getElementById('minimise-chat-btn').addEventListener('click', hidePanel);
        document.getElementById('close-chat-btn').addEventListener('click', hidePanel);

        // Activity bar toggle
        document.getElementById('toggle-activity-btn').addEventListener('click', () => {
            const bar = document.getElementById('activity-bar');
            bar.style.display = (bar.style.display === 'none' || bar.style.display === '') ? 'block' : 'none';
        });

        // Add activity entry function
        window.addActivity = function(icon, text, color) {
            const feed = document.getElementById('activity-feed');
            const now = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            const placeholder = feed.querySelector('[style*="italic"]');
            if(placeholder) placeholder.remove();
            const item = document.createElement('div');
            item.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;padding:3px 0;border-bottom:1px solid #f1f5f9;';
            item.innerHTML = '<span style="font-size:12px;flex-shrink:0;">' + icon + '</span>' +
                '<span style="color:' + (color||'#475569') + ';flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + text + '</span>' +
                '<span style="color:#94a3b8;font-size:9px;flex-shrink:0;">' + now + '</span>';
            feed.insertBefore(item, feed.firstChild);
            while(feed.children.length > 8) feed.removeChild(feed.lastChild);
            if(!panelVisible) {
                unreadCount++;
                fabBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                fabBadge.style.display = 'flex';
            }
        };

        // ‚îÄ‚îÄ DRAG PANEL (header drag) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const dragHandle = document.getElementById('chat-panel-header');
        let dragging = false, dragOffX = 0, dragOffY = 0;
        dragHandle.addEventListener('mousedown', e => {
            if(e.target.closest('button')) return;
            dragging = true;
            const r = chatPanel.getBoundingClientRect();
            dragOffX = e.clientX - r.left; dragOffY = e.clientY - r.top;
            chatPanel.style.transition = 'none';
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', e => {
            if(!dragging) return;
            let nx = e.clientX - dragOffX, ny = e.clientY - dragOffY;
            const pw = chatPanel.offsetWidth, ph = chatPanel.offsetHeight;
            nx = Math.max(0, Math.min(window.innerWidth - pw, nx));
            ny = Math.max(0, Math.min(window.innerHeight - ph, ny));
            chatPanel.style.left = nx + 'px'; chatPanel.style.top = ny + 'px';
            chatPanel.style.right = 'auto';   chatPanel.style.bottom = 'auto';
        });
        document.addEventListener('mouseup', () => { dragging = false; document.body.style.userSelect = ''; });

        // ‚îÄ‚îÄ DRAG FAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let fabDragging = false, fabOX = 0, fabOY = 0, fabMoved = false;
        chatFab.addEventListener('mousedown', e => {
            fabDragging = true; fabMoved = false;
            const r = chatFab.getBoundingClientRect();
            fabOX = e.clientX - r.left; fabOY = e.clientY - r.top;
            chatFab.style.transition = 'none';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });
        document.addEventListener('mousemove', e => {
            if(!fabDragging) return;
            fabMoved = true;
            let nx = e.clientX - fabOX, ny = e.clientY - fabOY;
            nx = Math.max(8, Math.min(window.innerWidth - chatFab.offsetWidth - 8, nx));
            ny = Math.max(8, Math.min(window.innerHeight - chatFab.offsetHeight - 8, ny));
            chatFab.style.left = nx + 'px'; chatFab.style.top = ny + 'px';
            chatFab.style.right = 'auto';   chatFab.style.bottom = 'auto';
        });
        document.addEventListener('mouseup', () => { fabDragging = false; document.body.style.userSelect = ''; });

        // ‚îÄ‚îÄ RESIZE PANEL (bottom drag) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let resizing = false, rsY = 0, rsH = 0;
        document.getElementById('chat-resize').addEventListener('mousedown', e => {
            resizing = true; rsY = e.clientY; rsH = chatPanel.offsetHeight;
            document.body.style.userSelect = 'none'; e.stopPropagation();
        });
        document.addEventListener('mousemove', e => {
            if(!resizing) return;
            const newH = Math.max(380, Math.min(window.innerHeight - 60, rsH - (e.clientY - rsY)));
            chatPanel.style.height = newH + 'px';
        });
        document.addEventListener('mouseup', () => { resizing = false; document.body.style.userSelect = ''; });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = document.getElementById('login-btn');
            const originalHTML = btn.innerHTML;
            btn.innerText = "Signing in...";
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                if(error.code === 'auth/popup-blocked') {
                    await signInWithRedirect(auth, provider);
                } else {
                    btn.innerHTML = originalHTML;
                }
            }
        });

        onAuthStateChanged(auth, (user) => {
            hideAllStates();
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    if (!isPinVerified) { 
                        ui.pin.classList.remove('hidden'); 
                        ui.pin.classList.add('flex'); 
                    } else { 
                        checkAndLoadApp(); 
                    }
                } else { 
                    alert("Unauthorized Email!"); 
                    signOut(auth); 
                }
            } else { 
                ui.login.classList.remove('hidden'); 
                ui.login.classList.add('flex'); 
            }
        });

        const doLogout = () => { isPinVerified = false; DYNAMIC_OPENAI_KEY = ""; signOut(auth); };
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if (document.getElementById('pin-input').value === SECRET_PIN) {
                isPinVerified = true; 
                checkAndLoadApp();
            } else { 
                alert("Incorrect PIN"); 
                document.getElementById('pin-input').value = ""; 
            }
        });

        async function checkAndLoadApp() {
            hideAllStates();
            try {
                const keyDoc = await getDoc(doc(db, "system_settings", "api_config"));
                if (keyDoc.exists() && keyDoc.data().openai_key) {
                    DYNAMIC_OPENAI_KEY = keyDoc.data().openai_key;
                    if (keyDoc.data().openai_model) OPENAI_MODEL = keyDoc.data().openai_model;
                    sessionStartTime = new Date().toISOString(); 
                    
                    ui.appLayout.classList.remove('hidden'); 
                    ui.appLayout.classList.add('flex');
                    
                    switchView('notebook');
                    loadAppListeners();
                } else { 
                    alert("API Key missing in Database!");
                    ui.login.classList.remove('hidden'); ui.login.classList.add('flex');
                    signOut(auth);
                }
            } catch (error) { 
                alert("Database connection failed."); 
                console.error(error);
            }
        }

        function loadAppListeners() {
            const chatQuery = query(collection(db, "chats"), where("timestamp", ">=", sessionStartTime), orderBy("timestamp", "asc"));
            onSnapshot(chatQuery, (snapshot) => {
                const welcomeMsg = ui.chatBox.firstElementChild;
                ui.chatBox.innerHTML = ""; 
                if(welcomeMsg) ui.chatBox.appendChild(welcomeMsg);
                
                chatHistory = []; 
                snapshot.forEach((docData) => {
                    const msg = docData.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            });

            onSnapshot(query(collection(db, "notes"), orderBy("timestamp", "asc")), (snapshot) => {
                ui.notesGrid.innerHTML = ""; allSavedNotes = []; let groupedNotes = {};
                snapshot.forEach((docData) => {
                    const note = docData.data(); allSavedNotes.push(note);
                    const normalizedTitle = (note.client || note.title || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø").toUpperCase();
                    if(!groupedNotes[normalizedTitle]) groupedNotes[normalizedTitle] = {
                        displayTitle: note.client || note.title || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        mobile: note.mobile || null,
                        updates: []
                    };
                    if(!groupedNotes[normalizedTitle].mobile) {
                        const mobMatch = (note.content || "").match(/\b[6-9]\d{9}\b/);
                        if(mobMatch) groupedNotes[normalizedTitle].mobile = mobMatch[0];
                    }
                    groupedNotes[normalizedTitle].updates.push(note);
                });

                for (const key in groupedNotes) {
                    const group = groupedNotes[key];
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-2xl shadow-md hover:shadow-xl border border-slate-100 relative overflow-hidden transition-all duration-300 group";

                    const latestUpdate = group.updates[group.updates.length - 1];
                    const latestContent = (latestUpdate?.content || "").toLowerCase();
                    let statusBadge = "üîµ Active";
                    let statusColor = "bg-blue-50 text-blue-700 border-blue-200";
                    // STRICT matching ‚Äî avoid false positives like "disbursement suunishchit"
                    if(/disburse ho gaya|disbursed|‡§µ‡§ø‡§§‡§∞‡§£ ‡§π‡•ã ‡§ó‡§Ø‡§æ|‡§µ‡§ø‡§§‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£/.test(latestContent))
                        { statusBadge = "‚úÖ Disbursed";  statusColor = "bg-green-50 text-green-700 border-green-200"; }
                    else if(/rejected|‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§/.test(latestContent))
                        { statusBadge = "‚ùå Rejected";   statusColor = "bg-red-50 text-red-700 border-red-200"; }
                    else if(/sanctioned|sanction ho gaya|‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ|‡§ã‡§£ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§/.test(latestContent))
                        { statusBadge = "‚úîÔ∏è Sanctioned"; statusColor = "bg-emerald-50 text-emerald-700 border-emerald-200"; }
                    else if(/mortgage|‡§Æ‡•â‡§∞‡•ç‡§ó‡•á‡§ú/.test(latestContent))
                        { statusBadge = "üìë Mortgage";   statusColor = "bg-purple-50 text-purple-700 border-purple-200"; }
                    else if(/processing start|processing ho|‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó/.test(latestContent))
                        { statusBadge = "üîÑ Processing"; statusColor = "bg-indigo-50 text-indigo-700 border-indigo-200"; }
                    else if(/pending|‡§≤‡§Ç‡§¨‡§ø‡§§/.test(latestContent))
                        { statusBadge = "‚è≥ Pending";    statusColor = "bg-yellow-50 text-yellow-700 border-yellow-200"; }

                    function fmtDate(ts) {
                        const d = new Date(ts);
                        return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                    }
                    function fmtTime(ts) {
                        return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                    }
                    function fmtDateTime(ts) { return fmtDate(ts) + ' ‚Äî ' + fmtTime(ts); }

                    // Dynamic gradient per status
                    let headerGrad = "from-blue-600 to-indigo-700";
                    if(statusBadge.includes("Disbursed"))    headerGrad = "from-emerald-600 to-green-700";
                    else if(statusBadge.includes("Sanctioned")) headerGrad = "from-teal-600 to-emerald-700";
                    else if(statusBadge.includes("Rejected"))   headerGrad = "from-red-600 to-rose-700";
                    else if(statusBadge.includes("Mortgage"))   headerGrad = "from-purple-600 to-violet-700";
                    else if(statusBadge.includes("Processing")) headerGrad = "from-indigo-500 to-blue-700";
                    else if(statusBadge.includes("Pending"))    headerGrad = "from-amber-500 to-orange-600";

                    const mobNo = group.mobile ? '<span class="flex items-center gap-1 bg-white/10 px-2.5 py-1 rounded-full border border-white/10 text-white/70">üì± ' + group.mobile + '</span>' : '';
                    const updCnt = group.updates.length;
                    const lastTime = fmtDateTime(latestUpdate.timestamp);

                    const headerHTML = `
                        <div class="bg-gradient-to-br ${headerGrad} p-5 relative overflow-hidden">
                            <div class="absolute -right-6 -top-6 w-28 h-28 bg-white/5 rounded-full pointer-events-none"></div>
                            <div class="absolute right-2 -bottom-5 w-16 h-16 bg-white/5 rounded-full pointer-events-none"></div>
                            <div class="flex items-start justify-between gap-2 mb-3 relative">
                                <div>
                                    <p class="text-white/50 text-[9px] font-black uppercase tracking-widest mb-1">üìÅ Client Case</p>
                                    <h3 class="font-black text-white text-xl leading-tight tracking-tight">${group.displayTitle}</h3>
                                </div>
                                <span class="text-[10px] font-black px-3 py-1.5 rounded-full shrink-0 bg-white/20 text-white border border-white/20">${statusBadge}</span>
                            </div>
                            <div class="flex flex-wrap gap-1.5 text-[10px] font-bold relative">
                                ${mobNo}
                                <span class="flex items-center gap-1 bg-white/10 px-2.5 py-1 rounded-full border border-white/10 text-white/70">üìã ${updCnt} Update${updCnt>1?'s':''}</span>
                                <span class="flex items-center gap-1 bg-white/10 px-2.5 py-1 rounded-full border border-white/10 text-white/70">üïê ${lastTime}</span>
                            </div>
                        </div>`;


                    const sortedUpdates = [...group.updates].reverse();
                    const updatesHTML = sortedUpdates.map((u, idx) => {
                        const isLatest = idx === 0;
                        return `
                        <div class="relative pl-9 pr-4 py-3 ${isLatest ? 'bg-blue-50/30' : ''} border-b border-slate-50 last:border-b-0">
                            <div class="absolute left-3.5 top-4 w-2.5 h-2.5 rounded-full border-2 border-white shadow-sm ${isLatest ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                            ${idx < sortedUpdates.length - 1 ? '<div class="absolute left-[17px] top-7 bottom-0 w-px bg-slate-100"></div>' : ''}
                            <div class="flex items-center gap-2 mb-1.5 flex-wrap">
                                <span class="text-[10px] font-black px-2 py-0.5 rounded-full ${isLatest ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">üìÖ ${fmtDate(u.timestamp)}</span>
                                <span class="text-[10px] font-bold text-slate-400">‚è∞ ${fmtTime(u.timestamp)}</span>
                                ${isLatest ? '<span class="text-[9px] font-black text-white bg-blue-500 px-2 py-0.5 rounded-full">LATEST</span>' : ''}
                            </div>
                            <p class="text-slate-700 text-sm leading-relaxed font-medium whitespace-pre-wrap devanagari">${u.content}</p>
                        </div>`;
                    }).join("");

                    card.innerHTML = headerHTML + `<div class="overflow-y-auto client-updates-scroll max-h-[350px]">${updatesHTML}</div>`;
                    ui.notesGrid.appendChild(card);
                }
            });

            // TASKS ‚Äî with search, filter, status toggle, priority, due date
            let taskCurrentFilter = 'all';
            let taskSearchQuery = '';

            function renderTasks() {
                const list = document.getElementById('tasks-list');
                const empty = document.getElementById('task-empty');
                const pendingCount = document.getElementById('task-pending-count');
                const doneCount = document.getElementById('task-done-count');
                list.innerHTML = '';

                let filtered = allTasks.filter(t => {
                    const matchFilter = taskCurrentFilter === 'all' || t.status === taskCurrentFilter ||
                        (taskCurrentFilter === 'Urgent' && t.priority === 'Urgent');
                    const matchSearch = !taskSearchQuery || (t.title||'').toLowerCase().includes(taskSearchQuery) ||
                        (t.client||'').toLowerCase().includes(taskSearchQuery);
                    return matchFilter && matchSearch;
                });

                const pending = allTasks.filter(t => t.status !== 'Done').length;
                const done    = allTasks.filter(t => t.status === 'Done').length;
                if(pendingCount) pendingCount.textContent = pending + ' Pending';
                if(doneCount) doneCount.textContent = done + ' Done';

                if(filtered.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                filtered.forEach((task, idx) => {
                    const isDone = task.status === 'Done';
                    const isUrgent = task.priority === 'Urgent';
                    const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !isDone;
                    const d = new Date(task.timestamp);
                    const dateStr = d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                    const timeStr = d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

                    let priorityBadge = '';
                    if(isUrgent) priorityBadge = '<span class="text-[10px] font-black text-red-600 bg-red-50 border border-red-200 px-2 py-0.5 rounded-full">üö® URGENT</span>';

                    let dueBadge = '';
                    if(task.dueDate) {
                        const due = new Date(task.dueDate).toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
                        dueBadge = `<span class="text-[10px] font-bold ${isOverdue ? 'text-red-600 bg-red-50' : 'text-slate-500 bg-slate-100'} px-2 py-0.5 rounded-full">üìÖ ${due}</span>`;
                    }

                    let statusBadge = '';
                    if(isDone)
                        statusBadge = '<span class="text-[10px] font-black text-green-700 bg-green-50 border border-green-200 px-2.5 py-1 rounded-full">‚úÖ Done</span>';
                    else if(isOverdue)
                        statusBadge = '<span class="text-[10px] font-black text-red-700 bg-red-50 border border-red-200 px-2.5 py-1 rounded-full animate-pulse">üî¥ Overdue</span>';
                    else
                        statusBadge = '<span class="text-[10px] font-black text-orange-700 bg-orange-50 border border-orange-200 px-2.5 py-1 rounded-full">‚è≥ Pending</span>';

                    const div = document.createElement('div');
                    div.className = `bg-white rounded-2xl border shadow-sm hover:shadow-md transition-all group ${isDone ? 'opacity-60 border-slate-100' : isOverdue ? 'border-red-200' : 'border-slate-100 hover:border-blue-200'}`;
                    div.innerHTML = `
                        <div class="p-4 flex items-start gap-4">
                            <!-- Checkbox -->
                            <button class="task-check-btn mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 ${isDone ? 'bg-green-500 border-green-500' : 'border-slate-300 hover:border-blue-400'} flex items-center justify-center transition-all" data-idx="${idx}">
                                ${isDone ? '<svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                            </button>
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-slate-800 text-base leading-snug devanagari ${isDone ? 'line-through text-slate-400' : ''}">${task.title}</p>
                                <div class="flex flex-wrap gap-2 mt-2 items-center">
                                    ${task.client ? `<span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">üë§ ${task.client}</span>` : ''}
                                    ${dueBadge}
                                    ${priorityBadge}
                                    <span class="text-[10px] text-slate-400 font-semibold ml-auto">üïê ${dateStr} ${timeStr}</span>
                                </div>
                            </div>
                            <!-- Status badge -->
                            <div class="flex-shrink-0">${statusBadge}</div>
                        </div>`;
                    list.appendChild(div);
                });

                // Checkbox toggle
                list.querySelectorAll('.task-check-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        const task = filtered[idx];
                        task.status = task.status === 'Done' ? 'Pending' : 'Done';
                        renderTasks();
                    });
                });
            }

            onSnapshot(query(collection(db, "tasks"), orderBy("timestamp", "desc")), (snapshot) => {
                allTasks = [];
                snapshot.forEach(d => allTasks.push(d.data()));
                renderTasks();
            });

            // Task search
            document.getElementById('task-search')?.addEventListener('input', e => {
                taskSearchQuery = e.target.value.toLowerCase();
                renderTasks();
            });

            // Task filter buttons
            document.getElementById('task-filter-btns')?.addEventListener('click', e => {
                const btn = e.target.closest('[data-filter]');
                if(!btn) return;
                taskCurrentFilter = btn.dataset.filter;
                document.querySelectorAll('.task-filter-btn').forEach(b => {
                    b.className = b === btn
                        ? 'task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600'
                        : 'task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50';
                });
                renderTasks();
            });

            // REMINDERS ‚Äî with search, filter, overdue detection, countdown
            let remCurrentFilter = 'all';
            let remSearchQuery = '';

            function parseRemDate(timeStr) {
                if(!timeStr || timeStr === 'Manual' || timeStr === '‡§ú‡§≤‡•ç‡§¶') return null;
                const d = new Date(timeStr);
                return isNaN(d) ? null : d;
            }

            function renderReminders() {
                const list = document.getElementById('reminders-list');
                const empty = document.getElementById('rem-empty');
                const upcomingEl = document.getElementById('rem-upcoming-count');
                const overdueEl = document.getElementById('rem-overdue-count');
                list.innerHTML = '';
                const now = new Date();

                let filtered = allReminders.filter(r => {
                    const d = parseRemDate(r.time);
                    const isOverdue = d && d < now;
                    const isToday = d && d.toDateString() === now.toDateString();
                    const matchFilter = remCurrentFilter === 'all' ||
                        (remCurrentFilter === 'today' && isToday) ||
                        (remCurrentFilter === 'overdue' && isOverdue) ||
                        (remCurrentFilter === 'upcoming' && d && d >= now);
                    const matchSearch = !remSearchQuery || (r.title||'').toLowerCase().includes(remSearchQuery) ||
                        (r.client||'').toLowerCase().includes(remSearchQuery);
                    return matchFilter && matchSearch;
                });

                const upcoming = allReminders.filter(r => { const d=parseRemDate(r.time); return d && d >= now; }).length;
                const overdue  = allReminders.filter(r => { const d=parseRemDate(r.time); return d && d < now; }).length;
                if(upcomingEl) upcomingEl.textContent = upcoming + ' Upcoming';
                if(overdueEl)  overdueEl.textContent  = overdue  + ' Overdue';

                if(filtered.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                filtered.forEach(rem => {
                    const remDate = parseRemDate(rem.time);
                    const isOverdue = remDate && remDate < now;
                    const isToday   = remDate && remDate.toDateString() === now.toDateString();
                    const isManual  = !remDate;

                    let cardColor, dotColor, timeLabel;
                    if(isOverdue)       { cardColor = 'from-red-50 to-red-100 border-red-200'; dotColor = 'bg-red-500'; timeLabel = 'üî¥ Overdue'; }
                    else if(isToday)    { cardColor = 'from-orange-50 to-amber-50 border-amber-200'; dotColor = 'bg-amber-500'; timeLabel = 'üü† Today'; }
                    else if(isManual)   { cardColor = 'from-slate-50 to-slate-100 border-slate-200'; dotColor = 'bg-slate-400'; timeLabel = 'üìå Manual'; }
                    else                { cardColor = 'from-blue-50 to-indigo-50 border-blue-200'; dotColor = 'bg-blue-500'; timeLabel = 'üü¢ Upcoming'; }

                    let formattedTime = rem.time;
                    if(remDate) {
                        formattedTime = remDate.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                        if(remDate.getHours() || remDate.getMinutes())
                            formattedTime += ' ‚Äî ' + remDate.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                    }

                    // Days countdown
                    let countdownBadge = '';
                    if(remDate && !isOverdue) {
                        const diff = Math.ceil((remDate - now) / (1000*60*60*24));
                        countdownBadge = diff === 0
                            ? '<span class="text-[10px] font-black text-amber-700 bg-amber-100 px-2 py-0.5 rounded-full animate-pulse">Today!</span>'
                            : `<span class="text-[10px] font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">in ${diff}d</span>`;
                    } else if(isOverdue) {
                        const diff = Math.ceil((now - remDate) / (1000*60*60*24));
                        countdownBadge = `<span class="text-[10px] font-black text-red-700 bg-red-100 px-2 py-0.5 rounded-full">${diff}d ago</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = `bg-gradient-to-br ${cardColor} border p-5 rounded-2xl shadow-sm flex flex-col gap-3 relative overflow-hidden hover:shadow-md transition-all`;
                    div.innerHTML = `
                        <div class="absolute -right-3 -top-3 text-5xl opacity-[0.07] select-none">‚è∞</div>
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${dotColor} ${isOverdue||isToday ? 'animate-pulse' : ''}"></span>
                                <span class="text-xs font-black text-slate-600 uppercase tracking-wide">${timeLabel}</span>
                            </div>
                            ${countdownBadge}
                        </div>
                        <p class="font-bold text-slate-800 text-base leading-snug devanagari">${rem.title}</p>
                        <div class="flex flex-wrap gap-2 items-center mt-1">
                            <span class="text-[11px] font-bold text-slate-500 bg-white/60 px-2 py-0.5 rounded-lg">üìÖ ${formattedTime}</span>
                            ${rem.client ? `<span class="text-[10px] font-bold text-blue-600 bg-white/60 px-2 py-0.5 rounded-lg">üë§ ${rem.client}</span>` : ''}
                        </div>`;
                    list.appendChild(div);
                });
            }

            onSnapshot(query(collection(db, "reminders"), orderBy("timestamp", "desc")), (snapshot) => {
                allReminders = [];
                snapshot.forEach(d => allReminders.push(d.data()));
                renderReminders();
            });

            // Reminders search
            document.getElementById('rem-search')?.addEventListener('input', e => {
                remSearchQuery = e.target.value.toLowerCase();
                renderReminders();
            });

            // Reminders filter buttons
            document.querySelectorAll('.rem-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    remCurrentFilter = btn.dataset.remfilter;
                    document.querySelectorAll('.rem-filter-btn').forEach(b => {
                        b.className = b === btn
                            ? 'rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600'
                            : 'rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50';
                    });
                    renderReminders();
                });
            });

            // NOTEBOOK ‚Äî grouped by client, search, sort, filter, grid/list toggle
            let nbSearchQuery = '';
            let nbSort = 'new';
            let nbFilterClient = 'all';
            let nbViewGrid = true;

            function renderNotebook() {
                const grid = document.getElementById('notebook-grid');
                const empty = document.getElementById('nb-empty');
                const countEl = document.getElementById('nb-count');
                grid.innerHTML = '';

                // Group by client
                let grouped = {};
                let allClientNames = new Set();
                allNotebooks.forEach(page => {
                    const key = (page.client || page.title || '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø').toUpperCase();
                    const name = page.client || page.title || '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø';
                    allClientNames.add(name);
                    if(!grouped[key]) grouped[key] = { displayName: name, updates: [] };
                    grouped[key].updates.push(page);
                });

                // Populate client filter dropdown
                const filterEl = document.getElementById('nb-filter');
                if(filterEl && filterEl.options.length <= 1) {
                    allClientNames.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name; opt.textContent = 'üë§ ' + name;
                        filterEl.appendChild(opt);
                    });
                }

                // Filter by client
                let entries = Object.values(grouped).filter(g => {
                    if(nbFilterClient !== 'all' && g.displayName !== nbFilterClient) return false;
                    if(!nbSearchQuery) return true;
                    return g.displayName.toLowerCase().includes(nbSearchQuery) ||
                        g.updates.some(u => (u.content||'').toLowerCase().includes(nbSearchQuery));
                });

                // Sort
                entries.sort((a, b) => {
                    const aLatest = Math.max(...a.updates.map(u => new Date(u.timestamp)));
                    const bLatest = Math.max(...b.updates.map(u => new Date(u.timestamp)));
                    if(nbSort === 'new') return bLatest - aLatest;
                    if(nbSort === 'old') return aLatest - bLatest;
                    if(nbSort === 'az')  return a.displayName.localeCompare(b.displayName);
                    return 0;
                });

                if(countEl) countEl.textContent = allNotebooks.length + ' notes';
                grid.className = nbViewGrid
                    ? 'grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 items-start'
                    : 'flex flex-col gap-4 pb-20';

                if(entries.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                entries.forEach(group => {
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-[1.5rem] shadow-sm hover:shadow-xl border border-l-[8px] border-yellow-400 border-slate-200 relative transition-all duration-300 overflow-hidden group";

                    const sortedUpdates = [...group.updates].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latest = sortedUpdates[0];

                    function fmtDate(ts) { return new Date(ts).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }
                    function fmtTime(ts) { return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}); }

                    const headerHTML = `
                        <div class="bg-slate-900 text-white px-6 py-4 flex items-center justify-between">
                            <div>
                                <div class="text-[10px] text-yellow-400 font-black uppercase tracking-widest mb-0.5">üìã ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§®‡•ã‡§ü</div>
                                <h3 class="font-black text-xl tracking-tight">${group.displayName}</h3>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-slate-400 mb-0.5">‡§ï‡•Å‡§≤ ‡§Ö‡§™‡§°‡•á‡§ü</div>
                                <div class="text-yellow-400 text-2xl font-black">${group.updates.length}</div>
                            </div>
                        </div>`;

                    const updatesHTML = sortedUpdates.map((page, idx) => {
                        let displayContent = page.content || '';
                        if(nbSearchQuery) {
                            const regex = new RegExp('(' + nbSearchQuery + ')', 'gi');
                            displayContent = displayContent.replace(regex, '<mark class="bg-yellow-200 rounded px-0.5">$1</mark>');
                        }
                        const isLatest = idx === 0;
                        const dDate = new Date(page.timestamp).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                        const dTime = new Date(page.timestamp).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                        const updateNum = group.updates.length - idx;
                        const badgeClass = isLatest ? 'bg-yellow-400 text-slate-900 font-black' : 'bg-slate-100 text-slate-400';
                        return '<div class="px-6 py-4 border-b border-slate-50 last:border-b-0 ' + (isLatest ? 'bg-yellow-50/30' : '') + '">' +
                            '<div class="flex items-center gap-2 mb-2 flex-wrap">' +
                            '<span class="text-[10px] font-black px-2 py-0.5 rounded-full ' + (isLatest ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-500') + '">üìÖ ' + dDate + '</span>' +
                            '<span class="text-[10px] font-bold text-slate-400">‚è∞ ' + dTime + '</span>' +
                            '<span class="text-[9px] font-bold px-2 py-0.5 rounded-full ml-auto ' + badgeClass + '">#' + updateNum + '</span>' +
                            '</div>' +
                            '<div class="text-slate-700 text-sm leading-relaxed devanagari font-medium whitespace-pre-wrap">' + displayContent + '</div>' +
                            '</div>';
                    }).join('');

                    card.innerHTML = headerHTML + `<div class="divide-y divide-slate-50 max-h-[300px] overflow-y-auto client-updates-scroll">${updatesHTML}</div>`;
                    grid.appendChild(card);
                });
            }

            onSnapshot(query(collection(db, "notebooks"), orderBy("timestamp", "desc")), (snapshot) => {
                allNotebooks = [];
                snapshot.forEach(d => allNotebooks.push(d.data()));
                renderNotebook();
            });

            // Notebook search
            document.getElementById('nb-search')?.addEventListener('input', e => {
                nbSearchQuery = e.target.value.toLowerCase();
                renderNotebook();
            });

            // Notebook sort
            document.getElementById('nb-sort')?.addEventListener('change', e => {
                nbSort = e.target.value;
                renderNotebook();
            });

            // Notebook filter
            document.getElementById('nb-filter')?.addEventListener('change', e => {
                nbFilterClient = e.target.value;
                renderNotebook();
            });

            // Notebook grid/list toggle
            document.getElementById('nb-view-toggle')?.addEventListener('click', () => {
                nbViewGrid = !nbViewGrid;
                document.getElementById('nb-view-toggle').textContent = nbViewGrid ? '‚äû Grid' : '‚ò∞ List';
                renderNotebook();
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            if(role === 'user') {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-md rounded-tr-sm";
            } else {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-white border border-slate-200 text-slate-700 shadow-sm rounded-tl-sm";
            }
            bubble.textContent = content;
            div.appendChild(bubble);
            ui.chatBox.appendChild(div);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';

            recognition.onstart = () => { isRecording = true; ui.micBtn.classList.add('recording'); ui.userInput.placeholder = "Listening..."; };
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) ui.userInput.value += event.results[i][0].transcript + ' ';
                    else interimTranscript += event.results[i][0].transcript;
                }
            };
            recognition.onend = () => { isRecording = false; ui.micBtn.classList.remove('recording'); ui.userInput.placeholder = "Type a command or tap mic..."; };
            ui.micBtn.addEventListener('click', () => { if (isRecording) recognition.stop(); else recognition.start(); });
        } else { ui.micBtn.style.display = 'none'; }

        let isProcessing = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  REAL AI ENGINE ‚Äî OpenAI GPT-4o powered sendMessage
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function sendMessage() {
            if (isProcessing) return;
            const text = ui.userInput.value.trim();
            if (!text) return;

            isProcessing = true;
            ui.userInput.disabled = true;
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');
            ui.userInput.value = "";

            chatHistory.push({ role: 'user', content: text });

            await addDoc(collection(db, "chats"), {
                role: "user", content: text, timestamp: new Date().toISOString()
            });

            // Loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex justify-start w-full";
            loadingDiv.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-blue-500 text-sm font-bold animate-pulse shadow-sm flex items-center gap-2"><span class="text-xl">ü§ñ</span> AI ‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•à...</div>`;
            ui.chatBox.appendChild(loadingDiv);
            ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            try {
                // ‚îÄ‚îÄ 1. FETCH ALL SAVED DATA FROM FIREBASE FOR CONTEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const [notebooksSnap, notesSnap, tasksSnap, remindersSnap] = await Promise.all([
                    getDocs(collection(db, "notebooks")),
                    getDocs(collection(db, "notes")),
                    getDocs(collection(db, "tasks")),
                    getDocs(collection(db, "reminders"))
                ]);

                const notebookData = notebooksSnap.docs.map(d => d.data());
                const casesData    = notesSnap.docs.map(d => d.data());
                const tasksData    = tasksSnap.docs.map(d => d.data());
                const remindersData= remindersSnap.docs.map(d => d.data());

                // Summarise saved data for AI context
                function summarize(arr, fields) {
                    return arr.slice(-30).map(item =>
                        fields.map(f => `${f}: ${item[f] || ''}`).join(' | ')
                    ).join('\n');
                }

                const savedContext = `
=== SAVED NOTEBOOKS (last 30) ===
${summarize(notebookData, ['client','content','timestamp'])}

=== CLIENT CASES (last 30) ===
${summarize(casesData, ['client','content','timestamp'])}

=== TASKS (last 30) ===
${summarize(tasksData, ['title','status','client','timestamp'])}

=== REMINDERS (last 30) ===
${summarize(remindersData, ['title','time','client','timestamp'])}
                `.trim();

                // ‚îÄ‚îÄ 2. SYSTEM PROMPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const today = new Date().toLocaleDateString('en-IN', {
                    day: '2-digit', month: 'long', year: 'numeric'
                });

                const systemPrompt = `
Aap "Smart Steno Pro" ke AI Assistant hain ‚Äî ek intelligent banking case manager jo Nilesh ji ke liye kaam karta hai.
Aaj ki tarikh: ${today}

AAPKE PAAS YEH SAVED DATA HAI (Firebase se fetch kiya):
${savedContext}

AAPKA KAAM:
1. Agar user koi CLIENT INFORMATION deta hai (koi bhi banking case ‚Äî loan, mortgage, sanction, visit, CMA, processing, etc.):
   - Ek professional, official Devanagari Hindi mein notebook draft banao
   - Har point naye line mein, appropriate emoji ke saath
   - Sahi tense use karo: "ho gaya" = ‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£, "ho raha hai" = üîÑ ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§Æ‡•á‡§Ç, "karna hai" = ‚è≥ ‡§≤‡§Ç‡§¨‡§ø‡§§
   - Client ka naam detect karo
   - JSON format mein respond karo (niche format diya hai)

2. Agar user KUCH PUCHH raha hai (jaise "Paawan Bio Energy ka status kya hai?", "kaunse cases pending hain?", "aaj ke tasks batao"):
   - Saved data mein se dhundh ke jawab do
   - Hindi mein, clearly, bullet points mein
   - JSON format mein respond karo

3. Agar user REMINDER ya TASK manually maangta hai:
   - Create karo

RESPONSE FORMAT (HAMESHA valid JSON do, kuch bhi extra mat likho):
{
  "reply": "...(user ko dikhane wala message Hindi mein)...",
  "notebook": {
    "save": true/false,
    "client": "Client Name",
    "content": "...Official Devanagari Hindi draft, line by line points..."
  },
  "case": {
    "save": true/false,
    "client": "Client Name",
    "mobile": "10-digit mobile number agar diya ho, warna null",
    "content": "...case summary Hindi mein..."
  },
  "task": {
    "save": true/false,
    "client": "Client Name",
    "title": "...task title Hindi mein..."
  },
  "reminder": {
    "save": true/false,
    "client": "Client Name",
    "title": "...reminder title...",
    "time": "...time/date..."
  }
}

RULES:
- notebook.save = true: HAMESHA jab user koi client info/update deta hai
- case.save = true: Jab nayi case kholni ho ya major update ho
- task.save = true: Jab koi kaam karna baaki ho (pending action)
- reminder.save = true: Jab koi date/follow-up mention ho
- Sirf JSON do ‚Äî koi explanation, code block, backtick nahi
- Hindi mein likho, professional banking language use karo
                `.trim();

                // ‚îÄ‚îÄ 3. CALL OPENAI GPT-4o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const messages = [
                    { role: "system", content: systemPrompt },
                    ...chatHistory.slice(-10) // last 10 messages for context
                ];

                const openaiRes = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${DYNAMIC_OPENAI_KEY}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: messages,
                        temperature: 0.3,
                        max_tokens: 1200
                    })
                });

                if (!openaiRes.ok) {
                    const errData = await openaiRes.json();
                    throw new Error(errData.error?.message || "OpenAI API Error");
                }

                const openaiData = await openaiRes.json();
                const rawContent = openaiData.choices[0].message.content.trim();

                // ‚îÄ‚îÄ 4. PARSE AI RESPONSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                let aiResponse;
                try {
                    // Strip code fences if any
                    const clean = rawContent.replace(/```json|```/g, '').trim();
                    aiResponse = JSON.parse(clean);
                } catch(e) {
                    // If AI returned plain text (not JSON), show it directly
                    aiResponse = { reply: rawContent, notebook: { save: false }, case: { save: false }, task: { save: false }, reminder: { save: false } };
                }

                const replyText = aiResponse.reply || "‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡§Æ‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•Å‡§Ü‡•§";
                chatHistory.push({ role: 'assistant', content: replyText });

                // ‚îÄ‚îÄ 5. SAVE TO FIREBASE BASED ON AI DECISION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const now = new Date().toISOString();
                const savePromises = [];

                if (aiResponse.notebook?.save && aiResponse.notebook?.content) {
                    savePromises.push(addDoc(collection(db, "notebooks"), {
                        title: aiResponse.notebook.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        content: aiResponse.notebook.content,
                        client: aiResponse.notebook.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('üìì', 'Notebook updated: ' + (aiResponse.notebook.client || 'General'), '#4f46e5');
                }

                if (aiResponse.case?.save && aiResponse.case?.content) {
                    savePromises.push(addDoc(collection(db, "notes"), {
                        title: aiResponse.case.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        content: aiResponse.case.content,
                        client: aiResponse.case.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        mobile: aiResponse.case.mobile || null,
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('üìÇ', 'Client case saved: ' + (aiResponse.case.client || 'General'), '#0891b2');
                }

                if (aiResponse.task?.save && aiResponse.task?.title) {
                    savePromises.push(addDoc(collection(db, "tasks"), {
                        title: aiResponse.task.title,
                        status: "Pending",
                        client: aiResponse.task.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('‚úÖ', 'Task created: ' + aiResponse.task.title.substring(0,30), '#d97706');
                }

                if (aiResponse.reminder?.save && aiResponse.reminder?.title) {
                    savePromises.push(addDoc(collection(db, "reminders"), {
                        title: aiResponse.reminder.title,
                        time: aiResponse.reminder.time || "‡§ú‡§≤‡•ç‡§¶",
                        client: aiResponse.reminder.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('‚è∞', 'Reminder set: ' + aiResponse.reminder.title.substring(0,30), '#dc2626');
                }

                // Save AI reply to chat
                savePromises.push(addDoc(collection(db, "chats"), {
                    role: "assistant", content: replyText, timestamp: now
                }));

                await Promise.all(savePromises);

                // ‚îÄ‚îÄ 6. RENDER AI REPLY ‚Äî onSnapshot se automatically render hoga
                loadingDiv.remove();
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            } catch (err) {
                loadingDiv.remove();
                const errMsg = `‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${err.message}`;
                await addDoc(collection(db, "chats"), {
                    role: "assistant", content: errMsg, timestamp: new Date().toISOString()
                });
            } finally {
                isProcessing = false;
                ui.userInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
                ui.userInput.focus();
            }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
