<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Steno Pro - Case Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .devanagari { font-family: 'Noto Sans Devanagari', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-btn.active { background-color: rgba(255, 255, 255, 0.1); color: #60a5fa; border-left: 4px solid #3b82f6; font-weight: 600; }
        .tab-btn-mob.active { color: #3b82f6; font-weight: bold; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .recording { animation: pulse-ring 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        
        .client-updates-scroll::-webkit-scrollbar { width: 4px; }
        .client-updates-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

        .notebook-page {
            background-image: repeating-linear-gradient(transparent, transparent 27px, #f1f5f9 27px, #f1f5f9 28px);
            line-height: 28px;
            padding-top: 2px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .modal-open { opacity: 1; visibility: visible; }
        .modal-closed { opacity: 0; visibility: hidden; }
        .modal-content-open { transform: translateY(0) scale(1); }
        .modal-content-closed { transform: translateY(100px) scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] overflow-hidden flex flex-col selection:bg-blue-200">

    <div id="login-screen" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&q=80&w=1920')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/40"></div>
        <div class="glass-card p-10 rounded-[2rem] shadow-2xl text-center max-w-md w-[90%] relative z-10 transform transition-all hover:scale-[1.02]">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-blue-500/30">
                <span class="text-4xl">ЁЯТ╝</span>
            </div>
            <h1 class="text-4xl font-extrabold mb-3 text-slate-900 tracking-tight">Smart Steno Pro</h1>
            <p class="text-slate-600 mb-8 text-sm leading-relaxed">Aapka personal AI assistant jo aapke cases, tasks aur meetings ko automatically manage karta hai.</p>
            
            <button id="login-btn" class="w-full bg-slate-900 hover:bg-slate-800 text-white px-6 py-4 rounded-xl font-bold shadow-xl transition-all flex items-center justify-center gap-3">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                Sign in with Google
            </button>
            <p class="mt-6 text-xs text-slate-400 font-medium tracking-wide uppercase">Secured by Bank Standards</p>
        </div>
    </div>

    <div id="pin-screen" class="hidden absolute inset-0 z-[100] flex-col items-center justify-center bg-slate-900 text-white bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&q=80&w=1920')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mb-6">ЁЯФТ</div>
            <h2 class="text-2xl mb-8 font-semibold tracking-wide">Enter Security PIN</h2>
            <input type="password" id="pin-input" maxlength="4" class="bg-slate-800/50 border-2 border-slate-600 p-4 text-center text-5xl tracking-[0.5em] text-white rounded-2xl mb-8 w-64 outline-none focus:border-blue-500 transition-colors shadow-inner backdrop-blur-sm" />
            <button id="verify-pin-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-xl shadow-lg shadow-blue-500/30 font-bold transition-all hover:-translate-y-1">Unlock Dashboard</button>
        </div>
    </div>

    <div id="app-layout" class="hidden flex-1 flex-col md:flex-row w-full h-full bg-slate-50 relative">
        
        <nav class="hidden md:flex flex-col w-72 bg-slate-900 text-slate-300 shadow-2xl z-20">
            <div class="p-8 border-b border-white/5 flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 text-xl">ЁЯТ╝</div>
                <h1 class="text-xl font-bold text-white tracking-wide">Smart Steno Pro</h1>
            </div>
            <div class="flex-1 py-6 flex flex-col gap-2 px-4">
                <button id="tab-notebook-desk" class="tab-btn active px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">ЁЯУУ Notebook</button>
                <button id="tab-notes-desk" class="tab-btn px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">ЁЯУВ Client Cases</button>
                <button id="tab-tasks-desk" class="tab-btn px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">тЬЕ Tasks</button>
                <button id="tab-reminders-desk" class="tab-btn px-4 py-3.5 rounded-xl text-left font-medium transition-all flex items-center gap-3 hover:bg-white/5">тП░ Reminders</button>
            </div>
            <div class="p-6 border-t border-white/5">
                <button id="logout-btn-desk" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 px-4 py-3 rounded-xl font-medium transition-colors text-sm flex items-center justify-center gap-2">
                    Secure Logout
                </button>
            </div>
        </nav>

        <main class="flex-1 relative flex flex-col h-full overflow-hidden">
            <header class="md:hidden bg-white border-b border-slate-200 px-5 py-4 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-sm shadow-md">ЁЯТ╝</div>
                    <h1 class="text-lg font-bold text-slate-800 tracking-tight">Smart Steno</h1>
                </div>
                <button id="logout-btn-mob" class="text-xs bg-slate-100 text-slate-600 px-3 py-2 rounded-lg font-medium">Logout</button>
            </header>

            <div id="view-notebook" class="absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">My Notebook</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Aapke sabhi important drafts aur meeting notes yahan automatically save hote hain.</p>
                    <div id="notebook-grid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 pb-20 items-start"></div>
                </div>
            </div>

            <div id="view-notes" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">Client Cases</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Har client ki history aur latest updates ka record.</p>
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20"></div>
                </div>
            </div>

            <div id="view-tasks" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-4xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">My Tasks</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Aapki smart to-do list jo AI ne banayi hai.</p>
                    <div id="tasks-list" class="flex flex-col gap-4 pb-20"></div>
                </div>
            </div>

            <div id="view-reminders" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-4xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">Reminders</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Upcoming calls, meetings aur alerts.</p>
                    <div id="reminders-list" class="grid grid-cols-1 md:grid-cols-2 gap-5 pb-20"></div>
                </div>
            </div>

            <button id="open-chat-fab" class="fixed bottom-24 right-6 md:bottom-10 md:right-10 w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-[0_10px_25px_rgba(59,130,246,0.5)] flex flex-col items-center justify-center text-white cursor-pointer hover:scale-110 hover:shadow-[0_15px_35px_rgba(59,130,246,0.6)] transition-all z-[40]">
                <span class="text-2xl mb-0.5">ЁЯдЦ</span>
            </button>
        </main>

        <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex items-center justify-around h-[65px] pb-1 shadow-[0_-10px_20px_rgba(0,0,0,0.03)] z-[30]">
            <button id="tab-notebook-mob" class="tab-btn-mob active flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">ЁЯУУ</span> Notebook
            </button>
            <button id="tab-notes-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">ЁЯУВ</span> Cases
            </button>
            <button id="tab-tasks-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">тЬЕ</span> Tasks
            </button>
            <button id="tab-reminders-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">тП░</span> Reminds
            </button>
        </nav>
    </div>

    <div id="chat-modal" class="modal-closed fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm transition-all duration-300 flex items-end md:items-center justify-center">
        <div id="chat-modal-content" class="modal-content-closed w-full h-[90vh] md:w-[850px] md:h-[85vh] bg-slate-50 md:rounded-3xl rounded-t-[2rem] shadow-2xl flex flex-col overflow-hidden transition-all duration-300 ease-out border border-white/20">
            
            <div class="bg-white border-b border-slate-200 p-4 md:p-5 flex justify-between items-center z-10 shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center relative">
                        <span class="text-2xl">ЁЯдЦ</span>
                        <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></span>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-slate-900 text-lg leading-tight">AI Steno Assistant</h3>
                        <p class="text-xs text-slate-500 font-medium mt-0.5">Listening & saving data automatically...</p>
                    </div>
                </div>
                <button id="minimise-chat-btn" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl font-semibold text-sm transition-colors">
                    <span class="text-lg">ЁЯФ╜</span> <span class="hidden md:block">Minimise</span>
                </button>
            </div>
            
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 flex flex-col scroll-smooth">
                <div class="flex justify-start w-full">
                    <div class="p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-white border border-slate-200 text-slate-700 shadow-sm rounded-tl-sm">
                        Namaste Nilesh! Main aapka AI Assistant hoon. Aap mujhe naye Tasks, Reminders ya Client details bata sakte hain. Main automatically unhe background me update kar dunga.
                    </div>
                </div>
            </div>
            
            <div class="p-4 md:p-6 bg-white border-t border-slate-200">
                <div class="max-w-4xl mx-auto flex gap-3 items-center">
                    <button id="mic-btn" class="bg-slate-100 hover:bg-blue-50 text-slate-500 hover:text-blue-600 p-4 rounded-2xl transition-all outline-none border border-slate-200 hover:border-blue-200" title="Click to Speak">
                        ЁЯОд
                    </button>
                    <input type="text" id="user-input" class="flex-1 bg-slate-100 border-transparent focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 p-4 rounded-2xl text-slate-800 outline-none transition-all font-medium placeholder:text-slate-400 shadow-inner" placeholder="Type a command or tap mic..." />
                    <button id="send-btn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 transition-transform active:scale-95">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithRedirect, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733",
            storageBucket: "ai-assistant-app-8e733.firebasestorage.app",
            messagingSenderId: "318215944760",
            appId: "1:318215944760:web:2a387b7bcd068da4ff44cd"
        };
        const SECRET_PIN = "5786"; 
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let chatHistory = [];
        let allSavedNotes = []; 
        let allTasks = [];
        let allReminders = [];
        let allNotebooks = [];

        let isPinVerified = false;
        let DYNAMIC_OPENAI_KEY = ""; 
        let sessionStartTime;

        const ui = {
            login: document.getElementById('login-screen'),
            pin: document.getElementById('pin-screen'),
            appLayout: document.getElementById('app-layout'),
            viewNotes: document.getElementById('view-notes'),
            viewTasks: document.getElementById('view-tasks'),
            viewReminders: document.getElementById('view-reminders'),
            viewNotebook: document.getElementById('view-notebook'),
            chatBox: document.getElementById('chat-box'),
            notesGrid: document.getElementById('notes-grid'),
            tasksList: document.getElementById('tasks-list'),
            remindersList: document.getElementById('reminders-list'),
            notebookGrid: document.getElementById('notebook-grid'),
            userInput: document.getElementById('user-input'),
            micBtn: document.getElementById('mic-btn'),
            chatModal: document.getElementById('chat-modal'),
            chatModalContent: document.getElementById('chat-modal-content')
        };

        const views = ['notes', 'tasks', 'reminders', 'notebook'];

        // ERROR FIXED HERE: Removing flex class so it hides properly
        function hideAllStates() {
            ui.login.classList.add('hidden'); ui.login.classList.remove('flex');
            ui.pin.classList.add('hidden'); ui.pin.classList.remove('flex');
            ui.appLayout.classList.add('hidden'); ui.appLayout.classList.remove('flex');
        }

        function switchView(targetView) {
            views.forEach(v => {
                const deskBtn = document.getElementById(`tab-${v}-desk`);
                const mobBtn = document.getElementById(`tab-${v}-mob`);
                const viewEl = document.getElementById(`view-${v}`);
                if(v === targetView) {
                    viewEl.classList.remove('hidden'); viewEl.classList.add('flex');
                    if(deskBtn) deskBtn.classList.add('active');
                    if(mobBtn) mobBtn.classList.add('active');
                } else {
                    viewEl.classList.add('hidden'); viewEl.classList.remove('flex');
                    if(deskBtn) deskBtn.classList.remove('active');
                    if(mobBtn) mobBtn.classList.remove('active');
                }
            });
        }

        views.forEach(v => {
            document.getElementById(`tab-${v}-desk`)?.addEventListener('click', () => switchView(v));
            document.getElementById(`tab-${v}-mob`)?.addEventListener('click', () => switchView(v));
        });

        const openChatFab = document.getElementById('open-chat-fab');
        const minimiseChatBtn = document.getElementById('minimise-chat-btn');

        function openChatModal() {
            ui.chatModal.classList.remove('modal-closed');
            ui.chatModal.classList.add('modal-open');
            setTimeout(() => {
                ui.chatModalContent.classList.remove('modal-content-closed');
                ui.chatModalContent.classList.add('modal-content-open');
                ui.userInput.focus();
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            }, 10);
        }

        function closeChatModal() {
            ui.chatModalContent.classList.remove('modal-content-open');
            ui.chatModalContent.classList.add('modal-content-closed');
            setTimeout(() => {
                ui.chatModal.classList.remove('modal-open');
                ui.chatModal.classList.add('modal-closed');
            }, 300);
        }

        openChatFab.addEventListener('click', openChatModal);
        minimiseChatBtn.addEventListener('click', closeChatModal);
        ui.chatModal.addEventListener('click', (e) => {
            if (e.target === ui.chatModal) closeChatModal();
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = document.getElementById('login-btn');
            const originalHTML = btn.innerHTML;
            btn.innerText = "Signing in...";
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                if(error.code === 'auth/popup-blocked') {
                    await signInWithRedirect(auth, provider);
                } else {
                    btn.innerHTML = originalHTML;
                }
            }
        });

        onAuthStateChanged(auth, (user) => {
            hideAllStates();
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    if (!isPinVerified) { 
                        ui.pin.classList.remove('hidden'); 
                        ui.pin.classList.add('flex'); 
                    } else { 
                        checkAndLoadApp(); 
                    }
                } else { 
                    alert("Unauthorized Email!"); 
                    signOut(auth); 
                }
            } else { 
                ui.login.classList.remove('hidden'); 
                ui.login.classList.add('flex'); 
            }
        });

        const doLogout = () => { isPinVerified = false; DYNAMIC_OPENAI_KEY = ""; signOut(auth); };
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if (document.getElementById('pin-input').value === SECRET_PIN) {
                isPinVerified = true; 
                checkAndLoadApp();
            } else { 
                alert("Incorrect PIN"); 
                document.getElementById('pin-input').value = ""; 
            }
        });

        async function checkAndLoadApp() {
            hideAllStates();
            try {
                const keyDoc = await getDoc(doc(db, "system_settings", "api_config"));
                if (keyDoc.exists() && keyDoc.data().openai_key) {
                    DYNAMIC_OPENAI_KEY = keyDoc.data().openai_key;
                    sessionStartTime = new Date().toISOString(); 
                    
                    ui.appLayout.classList.remove('hidden'); 
                    ui.appLayout.classList.add('flex');
                    
                    switchView('notebook');
                    loadAppListeners();
                } else { 
                    alert("API Key missing in Database!");
                    ui.login.classList.remove('hidden'); ui.login.classList.add('flex');
                    signOut(auth);
                }
            } catch (error) { 
                alert("Database connection failed."); 
                console.error(error);
            }
        }

        function loadAppListeners() {
            const chatQuery = query(collection(db, "chats"), where("timestamp", ">=", sessionStartTime), orderBy("timestamp", "asc"));
            onSnapshot(chatQuery, (snapshot) => {
                const welcomeMsg = ui.chatBox.firstElementChild;
                ui.chatBox.innerHTML = ""; 
                if(welcomeMsg) ui.chatBox.appendChild(welcomeMsg);
                
                chatHistory = []; 
                snapshot.forEach((docData) => {
                    const msg = docData.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            });

            onSnapshot(query(collection(db, "notes"), orderBy("timestamp", "asc")), (snapshot) => {
                ui.notesGrid.innerHTML = ""; allSavedNotes = []; let groupedNotes = {}; 
                snapshot.forEach((docData) => {
                    const note = docData.data(); allSavedNotes.push(note); 
                    const normalizedTitle = note.title.toUpperCase();
                    if(!groupedNotes[normalizedTitle]) groupedNotes[normalizedTitle] = { displayTitle: note.title, updates: [] };
                    groupedNotes[normalizedTitle].updates.push(note);
                });
                for (const key in groupedNotes) {
                    const group = groupedNotes[key];
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-[1.5rem] shadow-sm hover:shadow-lg border border-slate-100 flex flex-col transition-all h-[280px] relative group overflow-hidden";
                    let updatesHTML = group.updates.reverse().map(u => `
                        <div class="border-l-[3px] border-blue-400 pl-4 py-3 relative bg-slate-50/50 mb-2 rounded-r-xl">
                            <div class="absolute w-2.5 h-2.5 bg-blue-500 rounded-full -left-[6px] top-4 border-2 border-white shadow-sm"></div>
                            <p class="text-slate-700 text-sm whitespace-pre-wrap leading-relaxed">${u.content}</p>
                        </div>
                    `).join("");
                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-indigo-500 transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                        <h3 class="font-extrabold text-slate-800 text-xl border-b border-slate-100 pb-4 mb-3">${group.displayTitle}</h3>
                        <div class="overflow-y-auto client-updates-scroll flex-1 pr-1">${updatesHTML}</div>`;
                    ui.notesGrid.appendChild(card);
                }
            });

            onSnapshot(query(collection(db, "tasks"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.tasksList.innerHTML = ""; allTasks = [];
                snapshot.forEach((docData) => {
                    const task = docData.data(); allTasks.push(task);
                    const div = document.createElement('div');
                    div.className = "bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md flex items-center gap-5 transition-shadow";
                    div.innerHTML = `
                        <input type="checkbox" class="w-6 h-6 rounded-md border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer transition-colors hover:bg-blue-50">
                        <span class="flex-1 text-slate-800 font-semibold text-lg">${task.title}</span>
                        <span class="text-[11px] font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full uppercase tracking-wider">${task.status}</span>`;
                    ui.tasksList.appendChild(div);
                });
            });

            onSnapshot(query(collection(db, "reminders"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.remindersList.innerHTML = ""; allReminders = [];
                snapshot.forEach((docData) => {
                    const rem = docData.data(); allReminders.push(rem);
                    const div = document.createElement('div');
                    div.className = "bg-gradient-to-br from-orange-50 to-red-50 border border-orange-100 p-6 rounded-[1.5rem] shadow-sm flex flex-col gap-2 relative overflow-hidden";
                    div.innerHTML = `
                        <div class="absolute -right-4 -top-4 text-6xl opacity-10">тП░</div>
                        <span class="text-red-600 font-extrabold text-sm tracking-wide uppercase flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> ${rem.time}</span>
                        <span class="text-slate-800 font-semibold text-lg leading-snug">${rem.title}</span>`;
                    ui.remindersList.appendChild(div);
                });
            });

            onSnapshot(query(collection(db, "notebooks"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.notebookGrid.innerHTML = ""; allNotebooks = [];

                // Group notebooks by client name
                let groupedNotebooks = {};
                snapshot.forEach((docData) => {
                    const page = docData.data(); allNotebooks.push(page);
                    const key = (page.client || page.title || "рд╕рд╛рдорд╛рдиреНрдп").toUpperCase();
                    if (!groupedNotebooks[key]) {
                        groupedNotebooks[key] = { displayName: page.client || page.title || "рд╕рд╛рдорд╛рдиреНрдп", updates: [] };
                    }
                    groupedNotebooks[key].updates.push(page);
                });

                for (const key in groupedNotebooks) {
                    const group = groupedNotebooks[key];
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-[2rem] shadow-sm hover:shadow-xl border border-slate-200 border-l-[12px] border-l-yellow-400 relative transition-all duration-300 transform hover:-translate-y-1 overflow-hidden";

                    // Build client header
                    let headerHTML = `
                        <div class="bg-slate-900 text-white px-8 py-5 flex items-center justify-between">
                            <div>
                                <div class="text-xs text-yellow-400 font-bold uppercase tracking-widest mb-1">ЁЯУЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдиреЛрдЯ</div>
                                <h3 class="font-black text-2xl tracking-tight">${group.displayName}</h3>
                            </div>
                            <div class="text-right text-xs text-slate-300 font-semibold">
                                рдХреБрд▓ рдЕрдкрдбреЗрдЯ: <span class="text-yellow-400 text-lg font-black">${group.updates.length}</span>
                            </div>
                        </div>
                    `;

                    // Build each update entry
                    let updatesHTML = group.updates.map((page, idx) => {
                        const dateObj = new Date(page.timestamp);
                        const formattedDate = dateObj.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                        const formattedTime = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });

                        // Clean content тАФ remove AI Insights section if present
                        let cleanContent = page.content || "";
                        cleanContent = cleanContent.replace(/ЁЯУЛ\s*AI Insights[\s\S]*?(Status:.*?(Brain|рдорд╕реНрддрд┐рд╖реНрдХ)[^\n]*)/gi, "").trim();
                        cleanContent = cleanContent.replace(/AI Insights:[\s\S]*/gi, "").trim();
                        cleanContent = cleanContent.replace(/тАв\s*Date:.*\n?/gi, "").trim();
                        cleanContent = cleanContent.replace(/тАв\s*Details:.*\n?/gi, "").trim();
                        cleanContent = cleanContent.replace(/тАв\s*Status:.*\n?/gi, "").trim();
                        cleanContent = cleanContent.replace(/Summary:/gi, "").trim();

                        return `
                        <div class="px-8 py-5 border-b border-slate-100 last:border-b-0">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="bg-yellow-50 border border-yellow-200 text-yellow-800 text-[11px] font-black px-3 py-1 rounded-full uppercase tracking-wide">ЁЯУЕ ${formattedDate}</span>
                                <span class="text-slate-400 text-[11px] font-bold">тП░ ${formattedTime}</span>
                                <span class="text-slate-300 text-[10px] ml-auto">#${group.updates.length - idx}</span>
                            </div>
                            <div class="text-slate-800 text-[15px] whitespace-pre-wrap font-medium leading-relaxed devanagari">${cleanContent}</div>
                        </div>`;
                    }).join("");

                    card.innerHTML = headerHTML + `<div class="divide-y divide-slate-50">${updatesHTML}</div>`;
                    ui.notebookGrid.appendChild(card);
                }
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            if(role === 'user') {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-md rounded-tr-sm";
            } else {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-white border border-slate-200 text-slate-700 shadow-sm rounded-tl-sm";
            }
            bubble.textContent = content;
            div.appendChild(bubble);
            ui.chatBox.appendChild(div);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';

            recognition.onstart = () => { isRecording = true; ui.micBtn.classList.add('recording'); ui.userInput.placeholder = "Listening..."; };
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) ui.userInput.value += event.results[i][0].transcript + ' ';
                    else interimTranscript += event.results[i][0].transcript;
                }
            };
            recognition.onend = () => { isRecording = false; ui.micBtn.classList.remove('recording'); ui.userInput.placeholder = "Type a command or tap mic..."; };
            ui.micBtn.addEventListener('click', () => { if (isRecording) recognition.stop(); else recognition.start(); });
        } else { ui.micBtn.style.display = 'none'; }

        let isProcessing = false; // Prevents Double Clicking Duplication

        async function sendMessage() {
    if (isProcessing) return;

    const text = ui.userInput.value.trim();
    if (!text) return;

    isProcessing = true;
    ui.userInput.disabled = true;
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.classList.add('opacity-50');

    ui.userInput.value = "";

    // ---------- SAVE USER CHAT ----------
    await addDoc(collection(db, "chats"), {
        role: "user",
        content: text,
        timestamp: new Date().toISOString()
    });

    const loadingId = "loading-" + Date.now();
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = "text-blue-500 text-sm ml-2 font-bold animate-pulse py-2";
    loadingDiv.textContent = "Processing...";
    ui.chatBox.appendChild(loadingDiv);

    try {

        // ---------- CLIENT DETECT (Hindi + English, any case) ----------
        function detectClient(text) {
            // Known name keywords pattern: first last name (2-3 words)
            // Try explicit "ka" pattern like "sumit rathod ka..."
            const kaMatch = text.match(/([a-zA-Z\u0900-\u097F]+(?:\s[a-zA-Z\u0900-\u097F]+){1,2})\s+ka\b/i);
            if (kaMatch) return toTitleCase(kaMatch[1].trim());

            // Try Capitalized names
            const capMatch = text.match(/([A-Z][a-z]+(?:\s[A-Z][a-z]+){1,2}(?:\sPvt\.?\sLtd\.?)?)/);
            if (capMatch) return capMatch[1].trim();

            // Try 2-word lowercase names at start
            const lowerMatch = text.match(/^([a-z]+\s[a-z]+)/i);
            if (lowerMatch) return toTitleCase(lowerMatch[1].trim());

            return "рд╕рд╛рдорд╛рдиреНрдп";
        }

        function toTitleCase(str) {
            return str.replace(/\w\S*/g, (w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
        }

        const clientName = detectClient(text);

        // ---------- INTELLIGENT NOTEBOOK DRAFT тАФ CONTEXT-AWARE HINDI ----------
        function generateNotebookHindi(rawText, client) {

            // тФАтФА helpers тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            // Tense helper: karna hai / ho gaya / ho raha hai detect karo
            function isFuturePending(txt) {
                return /karna hai|karni hai|dena hai|update karna|taiyar karna|bhejna hai|submit karna|visit karna|start karo|рдХрд░рдирд╛ рд╣реИ|рджреЗрдирд╛ рд╣реИ|рднреЗрдЬрдирд╛ рд╣реИ|рд▓рдВрдмрд┐рдд рд╣реИ/i.test(txt);
            }
            function isOngoing(txt) {
                return /start ho gaya|chal raha|processing|ho raha|рд╢реБрд░реВ рд╣реЛ рдЧрдпрд╛|рдкреНрд░рдЧрддрд┐ рдореЗрдВ|processing start/i.test(txt);
            }
            function isDone(txt) {
                return /ho gaya|done|complete|ho chuka|disburs|рд╣реЛ рдЧрдпрд╛|рдкреВрд░реНрдг|рд╕рдореНрдкрдиреНрди/i.test(txt);
            }

            // Tense-correct suffix
            function suffix(line) {
                if (isDone(rawText) && !isFuturePending(rawText)) return line + " тАФ тЬЕ рдкреВрд░реНрдгред";
                if (isOngoing(rawText))                             return line + " тАФ ЁЯФД рдкреНрд░рдЧрддрд┐ рдореЗрдВред";
                return line + " тАФ тП│ рдХрд╛рд░реНрдп рд▓рдВрдмрд┐рддред";
            }

            // тФАтФА extract amount if any тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            const amtMatch = rawText.match(/(?:тВ╣|rs\.?|rupe[ey]a?|amount|рд░рд╛рд╢рд┐)[:\s]*([0-9,]+(?:\s*(?:lakh|cr|k|lac|рд╣рдЬрд╛рд░|рд▓рд╛рдЦ|рдХрд░реЛрдбрд╝))?)/i);
            const amtStr   = amtMatch ? `тВ╣${amtMatch[1].trim()}` : null;

            // тФАтФА extract date if any тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            const dtMatch = rawText.match(/(\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\d{1,2}\s+(?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s*\d{0,4})/i);
            const dtStr    = dtMatch ? dtMatch[0] : null;

            // тФАтФА extract person names mentioned after "ko" / "se" тФАтФАтФАтФАтФАтФАтФАтФАтФА
            const personMatch = rawText.match(/([A-Za-z\u0900-\u097F]+(?:\s[A-Za-z\u0900-\u097F]+)?)\s+ko\b/i);
            const personName  = personMatch ? toTitleCase(personMatch[1].trim()) : null;

            const lower = rawText.toLowerCase();
            const points = [];

            // тФАтФА PROCESSING / STATUS тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/processing start|processing ho gaya|рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рд╢реБрд░реВ/i.test(rawText))
                points.push("ЁЯФД рдкреНрд░рдХрд░рдг рдХреА рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдкреНрд░рд╛рд░рдВрдн рд╣реЛ рдЪреБрдХреА рд╣реИред");

            if(/tejas|рдЯреЗрдЬрд╕/i.test(rawText))
                points.push("ЁЯПж рдкреНрд░рдХрд░рдг рдЯреЗрдЬрд╕ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рджрд░реНрдЬ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред");

            // тФАтФА CMA тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/cma/i.test(rawText)) {
                if(isFuturePending(rawText))
                    points.push("ЁЯУК CMA рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ рдбреЗрдЯрд╛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рд╣реИ тАФ рдЕрднреА рд▓рдВрдмрд┐рддред");
                else if(isDone(rawText))
                    points.push("ЁЯУК CMA рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ рдбреЗрдЯрд╛ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ тАФ тЬЕ рдкреВрд░реНрдгред");
                else
                    points.push("ЁЯУК CMA рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ рдбреЗрдЯрд╛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рд╣реИред");
            }

            // тФАтФА PRE-SANCTION VISIT тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/presanction|pre.?sanction|pre sanction|рдкреНрд░реА-рд╕реЗрдВрдХреНрд╢рди|рдкреНрд░реА рд╕реЗрдВрдХреНрд╢рди/i.test(rawText)) {
                if(isFuturePending(rawText))
                    points.push("ЁЯПа рдкреНрд░реА-рд╕реЗрдВрдХреНрд╢рди рд╡рд┐рдЬрд╝рд┐рдЯ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рд╣реИ тАФ рдЕрднреА рд▓рдВрдмрд┐рддред");
                else if(isDone(rawText))
                    points.push("ЁЯПа рдкреНрд░реА-рд╕реЗрдВрдХреНрд╢рди рд╡рд┐рдЬрд╝рд┐рдЯ рд╕рдореНрдкрдиреНрди рд╣реЛ рдЪреБрдХреА рд╣реИред");
                else
                    points.push("ЁЯПа рдкреНрд░реА-рд╕реЗрдВрдХреНрд╢рди рд╡рд┐рдЬрд╝рд┐рдЯ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдЬрд╛рдиреА рд╣реИред");
            }

            // тФАтФА SANCTION тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/sanction|рд╕реНрд╡реАрдХреГрдд|рд╕реЗрдВрдХреНрд╢рди/i.test(rawText)) {
                if(/ho jaye|ho jaaye|hone ke baad|рд╣реЛрдиреЗ рдкрд░|рд╣реЛ рдЬрд╛рдП/i.test(rawText))
                    points.push("тЬФя╕П рдкреНрд░рд╕реНрддрд╛рд╡ рд╕реНрд╡реАрдХреГрдд (Sanction) рд╣реЛрдиреЗ рдХреЗ рдкрд╢реНрдЪрд╛рдд рдЕрдЧрд▓реА рдХрд╛рд░реНрдпрд╡рд╛рд╣реА рдХреА рдЬрд╛рдПрдЧреАред");
                else if(isDone(rawText))
                    points.push("тЬФя╕П рдЛрдг рдкреНрд░рд╕реНрддрд╛рд╡ рд╕реНрд╡реАрдХреГрдд рд╣реЛ рдЪреБрдХрд╛ рд╣реИред");
                else
                    points.push("тЬФя╕П рдЛрдг рд╕реНрд╡реАрдХреГрддрд┐ (Sanction) рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреНрд░рдЧрддрд┐ рдореЗрдВ рд╣реИред");
            }

            // тФАтФА MORTGAGE тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/mortgage|рдореЙрд░реНрдЧреЗрдЬ/i.test(rawText)) {
                if(/taiyar karke|taiyar kar|рдмрдирд╛рдХрд░|рддреИрдпрд╛рд░ рдХрд░рдХреЗ|dena hai|рджреЗрдирд╛ рд╣реИ/i.test(rawText))
                    points.push("ЁЯУС рдореЙрд░реНрдЧреЗрдЬ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рддреИрдпрд╛рд░ рдХрд░рдХреЗ рд╕рдВрдмрдВрдзрд┐рдд рд╡рд┐рднрд╛рдЧ рдХреЛ рдкреНрд░рд╕реНрддреБрдд рдХрд░рдирд╛ рд╣реИ тАФ тП│ рд▓рдВрдмрд┐рддред");
                else if(/drafting/i.test(rawText))
                    points.push("ЁЯУС рдореЙрд░реНрдЧреЗрдЬ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреА рдбреНрд░рд╛рдлреНрдЯрд┐рдВрдЧ рдХреА рдЬрд╛рдиреА рд╣реИред");
                else if(isDone(rawText))
                    points.push("ЁЯУС рдореЙрд░реНрдЧреЗрдЬ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдкреВрд░реНрдг рдХрд┐рдпрд╛ рдЧрдпрд╛ред");
                else
                    points.push("ЁЯУС рдореЙрд░реНрдЧреЗрдЬ рд╕рдВрдмрдВрдзреА рдХрд╛рд░реНрдпрд╡рд╛рд╣реА рдХреА рдЬрд╛рдиреА рд╣реИред");
            }

            // тФАтФА PROPOSAL тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/proposal|рдкреНрд░рдкреЛрдЬрд▓|praposal/i.test(rawText)) {
                if(/sanction/i.test(rawText))
                    points.push("ЁЯУЛ рдкреНрд░рд╕реНрддрд╛рд╡ (Proposal) рд╕реНрд╡реАрдХреГрддрд┐ рд╣реЗрддреБ рдкреНрд░реЗрд╖рд┐рдд / рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред");
                else
                    points.push("ЁЯУЛ рдЛрдг рдкреНрд░рд╕реНрддрд╛рд╡ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред");
            }

            // тФАтФА LOAN TYPE тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/home loan|рд╣реЛрдо рд▓реЛрди/i.test(rawText))        points.push("ЁЯПа рдкреНрд░рдХрд░рдг рдкреНрд░рдХрд╛рд░: рд╣реЛрдо рд▓реЛрдиред");
            if(/business loan|рдмрд┐рдЬрдиреЗрд╕ рд▓реЛрди/i.test(rawText)) points.push("ЁЯПв рдкреНрд░рдХрд░рдг рдкреНрд░рдХрд╛рд░: рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рдЛрдг (Business Loan)ред");
            if(/personal loan|рдкрд░реНрд╕рдирд▓ рд▓реЛрди/i.test(rawText)) points.push("ЁЯТ│ рдкреНрд░рдХрд░рдг рдкреНрд░рдХрд╛рд░: рдкрд░реНрд╕рдирд▓ рд▓реЛрдиред");
            if(/mortgage loan/i.test(rawText))             points.push("ЁЯПб рдкреНрд░рдХрд░рдг рдкреНрд░рдХрд╛рд░: рдореЙрд░реНрдЧреЗрдЬ рд▓реЛрдиред");

            // тФАтФА DOCUMENT WORK тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/draft|drafting|рдбреНрд░рд╛рдлреНрдЯ/i.test(rawText) && !/mortgage/i.test(rawText))
                points.push(suffix("ЁЯУЭ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдкреНрд░рд╛рд░реВрдк (рдбреНрд░рд╛рдлреНрдЯ) рддреИрдпрд╛рд░ рдХрд░рдирд╛ рд╣реИ"));

            if(/mail|email|рдореЗрд▓/i.test(rawText)) {
                if(personName)
                    points.push(`ЁЯУз рд╢реНрд░реА/рд╕реБрд╢реНрд░реА ${personName} рдХреЛ рдИ-рдореЗрд▓ рднреЗрдЬрдиреА рд╣реИ тАФ тП│ рд▓рдВрдмрд┐рддред`);
                else
                    points.push("ЁЯУз рд╕рдВрдмрдВрдзрд┐рдд рдкрдХреНрд╖ рдХреЛ рдИ-рдореЗрд▓ рдкреНрд░реЗрд╖рд┐рдд рдХрд░рдиреА рд╣реИред");
            }

            if(/submit|рдЬрдорд╛/i.test(rawText))
                points.push(suffix("ЁЯУВ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╕рдВрдмрдВрдзрд┐рдд рд╡рд┐рднрд╛рдЧ рдореЗрдВ рдЬрдорд╛ рдХрд░рдирд╛ рд╣реИ"));

            if(/insurance|рдмреАрдорд╛/i.test(rawText))
                points.push("ЁЯЫбя╕П рдмреАрдорд╛ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдкреНрд░рд╕реНрддреБрдд рдХрд░рдиреЗ рд╣реЗрддреБ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рд╕реВрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПред");

            if(/LC|letter of credit|рдПрд▓рд╕реА/i.test(rawText))
                points.push("ЁЯФЦ рдПрд▓рд╕реА (рд▓реЗрдЯрд░ рдСрдл рдХреНрд░реЗрдбрд┐рдЯ) рдХреА рдЬрд╛рдБрдЪ рдПрд╡рдВ рд╕рддреНрдпрд╛рдкрди рдХрд░рдирд╛ рд╣реИред");

            // тФАтФА COMMUNICATION тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(/call|phone|рдлреЛрди|рдХреЙрд▓/i.test(rawText))
                points.push("ЁЯУЮ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рджреВрд░рднрд╛рд╖ рдкрд░ рд╕рдВрдкрд░реНрдХ рдХрд░рдирд╛ рд╣реИред");

            if(/meeting|рдореАрдЯрд┐рдВрдЧ|рдмреИрдардХ/i.test(rawText))
                points.push("ЁЯдЭ рдмреИрдардХ / рдореАрдЯрд┐рдВрдЧ рдЖрдпреЛрдЬрд┐рдд рдХреА рдЬрд╛рдиреА рд╣реИред");

            if(/follow.?up|рдлреЙрд▓реЛ рдЕрдк/i.test(rawText))
                points.push("ЁЯФФ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдлреЙрд▓реЛ-рдЕрдк рд╣реЗрддреБ рд╕реВрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПред");

            if(/urgent|рдЬрд░реВрд░реА|рддреБрд░рдВрдд/i.test(rawText))
                points.push("ЁЯЪи рдпрд╣ рдкреНрд░рдХрд░рдг рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рддрддреНрдХрд╛рд▓ рдирд┐рдкрдЯрд╛рди рд╣реЗрддреБ рдЪрд┐рд╣реНрдирд┐рдд рд╣реИред");

            if(/delay|discrepancy|рджреЗрд░реА/i.test(rawText))
                points.push("тЪая╕П рд╡рд┐рд▓рдВрдм / рддреНрд░реБрдЯрд┐ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ тАФ рд╡рд┐рд╢реЗрд╖ рдзреНрдпрд╛рди рдЖрд╡рд╢реНрдпрдХред");

            // тФАтФА AMOUNT тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(amtStr) points.push(`ЁЯТ░ рдЛрдг рд░рд╛рд╢рд┐: ${amtStr} тАФ рдЕрднрд┐рд▓реЗрдЦ рдореЗрдВ рджрд░реНрдЬред`);

            // тФАтФА DATE тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(dtStr) points.push(`ЁЯУЕ рдорд╣рддреНрд╡рдкреВрд░реНрдг рддрд┐рдерд┐: ${dtStr} тАФ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦреЗрдВред`);

            // тФАтФА PERSON NAME тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(personName && !/mail|email/i.test(rawText))
                points.push(`ЁЯСд рд╢реНрд░реА/рд╕реБрд╢реНрд░реА ${personName} рдХреЛ рд╕рдВрдмрдВрдзрд┐рдд рдЬрд╛рдирдХрд╛рд░реА рджреА рдЬрд╛рдПред`);

            // тФАтФА FALLBACK тАФ original text as is тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
            if(points.length === 0) {
                points.push(rawText);
            }

            return points.join("\n");
        }

        // ---------- SAVE NOTEBOOK ----------
        const notebookContent = generateNotebookHindi(text, clientName);

        await addDoc(collection(db, "notebooks"), {
            title: clientName,
            content: notebookContent,
            client: clientName,
            timestamp: new Date().toISOString()
        });

        // ---------- COMMAND DETECT (HINDI + ENGLISH) ----------
        const lower = text.toLowerCase();

        let manualAction = null;

        if(lower.includes("make task") || lower.includes("task banao") || lower.includes("рдЯрд╛рд╕реНрдХ рдмрдирд╛рдУ"))
            manualAction = "task";

        if(lower.includes("make reminder") || lower.includes("reminder banao") || lower.includes("рд░рд┐рдорд╛рдЗрдВрдбрд░ рдмрдирд╛рдУ"))
            manualAction = "reminder";

        if(lower.includes("make case") || lower.includes("case banao") || lower.includes("рдХреЗрд╕ рдмрдирд╛рдУ"))
            manualAction = "case";

        // ---------- MANUAL CREATE FROM CHAT HISTORY ----------
        if(manualAction){

            const lastUserMsg = chatHistory
                .filter(m => m.role === "user")
                .slice(-5)
                .map(m => m.content)
                .join(" ");

            if(manualAction === "case"){
                await addDoc(collection(db, "notes"), {
                    title: clientName,
                    content: lastUserMsg,
                    client: clientName,
                    timestamp: new Date().toISOString()
                });
            }

            if(manualAction === "task"){
                await addDoc(collection(db, "tasks"), {
                    title: clientName + " тАУ рдХрд╛рд░реНрдп рд▓рдВрдмрд┐рдд",
                    status: "Pending",
                    client: clientName,
                    timestamp: new Date().toISOString()
                });
            }

            if(manualAction === "reminder"){
                await addDoc(collection(db, "reminders"), {
                    title: clientName + " тАУ рдлреЙрд▓реЛ рдЕрдк",
                    time: "Manual",
                    client: clientName,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // ---------- RESPONSE ----------
        let responseText = "рдиреЛрдЯрдмреБрдХ рдореЗрдВ рд╕реЗрд╡ рдХрд┐рдпрд╛ рдЧрдпрд╛ тЬФ";

        if(manualAction === "case")
            responseText += "\nрдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗрд╕ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ тЬФ";

        if(manualAction === "task")
            responseText += "\nрдЯрд╛рд╕реНрдХ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ тЬФ";

        if(manualAction === "reminder")
            responseText += "\nрд░рд┐рдорд╛рдЗрдВрдбрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ тЬФ";

        await addDoc(collection(db, "chats"), {
            role: "assistant",
            content: responseText,
            timestamp: new Date().toISOString()
        });

    } catch (err) {
        alert(err.message);
    } finally {
        document.getElementById(loadingId)?.remove();
        isProcessing = false;
        ui.userInput.disabled = false;
        sendBtn.disabled = false;
        sendBtn.classList.remove('opacity-50');
    }
}
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
