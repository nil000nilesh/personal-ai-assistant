<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseDesk AI ‚Äî Powered by GPT-4.1</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect width='40' height='40' rx='11' fill='%236366f1'/><rect x='10' y='8' width='20' height='26' rx='4' fill='white' fill-opacity='0.25' stroke='white' stroke-width='1.5'/><path d='M14 16h12M14 21h12M14 26h8' stroke='white' stroke-width='2' stroke-linecap='round'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .devanagari { font-family: 'Noto Sans Devanagari', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-btn.active { color: #60a5fa; font-weight: 700; }
        .tab-btn-mob.active { color: #3b82f6; font-weight: bold; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .recording { animation: pulse-ring 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        
        .client-updates-scroll::-webkit-scrollbar { width: 4px; }
        .client-updates-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

        .notebook-page {
            background-image: repeating-linear-gradient(transparent, transparent 27px, #f1f5f9 27px, #f1f5f9 28px);
            line-height: 28px;
            padding-top: 2px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .modal-open { opacity: 1; visibility: visible; }
        .modal-closed { opacity: 0; visibility: hidden; }
        .modal-content-open { transform: translateY(0) scale(1); }
        .modal-content-closed { transform: translateY(100px) scale(0.95); }

        /* ‚îÄ‚îÄ COLLAPSIBLE SIDEBAR ‚îÄ‚îÄ */
        #sidebar {
            width: 68px;
            transition: width 0.28s cubic-bezier(0.4,0,0.2,1);
            overflow: hidden;
            flex-shrink: 0;
        }
        #sidebar.expanded { width: 230px; }
        #sidebar .label-text { opacity: 0; width: 0; overflow: hidden; white-space: nowrap; transition: opacity 0.2s, width 0.28s; }
        #sidebar.expanded .label-text { opacity: 1; width: auto; }
        #sidebar .logo-text { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s, width 0.28s; }
        #sidebar.expanded .logo-text { opacity: 1; width: auto; }
        #sidebar .logout-text { display: none; }
        #sidebar.expanded .logout-text { display: inline; }
        #sidebar .tab-btn { justify-content: center; }
        #sidebar.expanded .tab-btn { justify-content: flex-start; }
        #sidebar .tab-btn.active { border-left: 3px solid #60a5fa; background: rgba(255,255,255,0.08); }
        #sidebar .tab-btn:not(.active) { border-left: 3px solid transparent; }

        /* Tooltip on collapsed */
        #sidebar:not(.expanded) .nav-item { position: relative; }
        #sidebar:not(.expanded) .nav-item:hover::after {
            content: attr(data-label);
            position: absolute;
            left: 68px;
            top: 50%;
            transform: translateY(-50%);
            background: #1e293b;
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 10px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        #sidebar:not(.expanded) .nav-item:hover::before {
            content: '';
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1e293b;
            z-index: 100;
        }

        /* ‚îÄ‚îÄ APP BACKGROUND ‚îÄ‚îÄ */
        #app-layout {
            background: #f0f4ff;
            background-image:
                radial-gradient(ellipse at 20% 20%, rgba(99,102,241,0.07) 0%, transparent 55%),
                radial-gradient(ellipse at 80% 80%, rgba(59,130,246,0.06) 0%, transparent 55%),
                radial-gradient(ellipse at 60% 10%, rgba(139,92,246,0.05) 0%, transparent 40%);
        }
        /* Toolbar glass effect */
        .toolbar-glass {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(99,102,241,0.08);
        }
        /* Content cards subtle shadow upgrade */
        #notebook-grid > *, #notes-grid > *, #tasks-list > *, #reminders-list > * {
            box-shadow: 0 2px 12px rgba(99,102,241,0.07), 0 1px 3px rgba(0,0,0,0.05);
        }
        @keyframes fabPulse {
            0%   { transform: scale(1); opacity: 0.8; }
            50%  { transform: scale(1.18); opacity: 0.3; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.4; }
        }
        #mic-btn.recording {
            background: #fee2e2 !important;
            animation: micPulse 1s infinite;
        }
        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
            50%       { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
        }
        #chat-box::-webkit-scrollbar { width: 4px; }
        #chat-box::-webkit-scrollbar-track { background: transparent; }
        #chat-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #activity-feed::-webkit-scrollbar { width: 3px; }
        #activity-feed::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }


        /* ‚ïê‚ïê‚ïê RIGHT SIDE LIVE UPDATE PANEL ‚ïê‚ïê‚ïê */
        #upd-panel-wrap {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 150;
            display: flex;
            align-items: center;
            pointer-events: none;
        }
        /* The pull tab ‚Äî always visible on right edge */
        #upd-pull-tab {
            pointer-events: all;
            width: 32px;
            min-height: 100px;
            background: linear-gradient(180deg, #4f46e5 0%, #2563eb 100%);
            border-radius: 12px 0 0 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            padding: 12px 0;
            box-shadow: -3px 0 12px rgba(79,70,229,0.3);
            transition: width 0.2s;
            position: relative;
            user-select: none;
        }
        #upd-pull-tab:hover { background: linear-gradient(180deg,#4338ca,#1d4ed8); }
        #upd-tab-count {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 16px;
            height: 16px;
            background: #ef4444;
            border-radius: 8px;
            font-size: 8.5px;
            font-weight: 900;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 3px;
            border: 1.5px solid white;
        }
        #upd-tab-icon { color: white; flex-shrink: 0; }
        #upd-tab-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-size: 9.5px;
            font-weight: 800;
            color: rgba(255,255,255,0.9);
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }
        #upd-tab-chevron {
            color: rgba(255,255,255,0.5);
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        /* Panel body ‚Äî slides in from right */
        #upd-panel-body {
            pointer-events: all;
            width: 0;
            overflow: hidden;
            transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
            background: white;
            border-radius: 12px 0 0 12px;
            border: 1px solid #e2e8f0;
            border-right: none;
            box-shadow: -6px 0 24px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }
        #upd-panel-body.open {
            width: 270px;
        }
        #upd-panel-body.open + #upd-pull-tab #upd-tab-chevron,
        #upd-pull-tab.open-state #upd-tab-chevron {
            transform: rotate(180deg);
        }
        /* Panel inner (fixed width inside hidden overflow) */
        #upd-panel-inner {
            width: 270px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }
        /* Row items */
        .upd-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f8faff;
            transition: background 0.15s;
            position: relative;
            text-align: left;
            background: none;
            border: none;
            width: 100%;
            border-bottom: 1px solid #f1f5f9;
        }
        .upd-row:hover { background: #f0f4ff; }
        .upd-row:last-child { border-bottom: none; }
        .upd-row-icon {
            width: 34px; height: 34px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; flex-shrink: 0;
        }
        .upd-row-badge {
            min-width: 22px; height: 22px;
            border-radius: 11px;
            font-size: 11px; font-weight: 900; color: white;
            display: flex; align-items: center; justify-content: center;
            padding: 0 6px; flex-shrink: 0;
            animation: badgePop .25s ease;
        }
        .upd-row-title { font-size: 12px; font-weight: 800; line-height: 1.2; }
        .upd-row-sub   { font-size: 10px; font-weight: 600; margin-top: 1px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* Page visit flash */
        @keyframes visitFlash {
            0%   { background: #dbeafe; }
            100% { background: transparent; }
        }
        .upd-row.visited { animation: visitFlash 0.5s ease; }
        /* Slide in new rows */
        @keyframes rowSlideIn {
            from { opacity: 0; transform: translateX(30px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .upd-row.row-new { animation: rowSlideIn 0.3s ease; }
        /* Badge shake */
        @keyframes badgeShake {
            0%,100% { transform: scale(1); }
            30%      { transform: scale(1.4); }
            60%      { transform: scale(0.9); }
        }
        .upd-row-badge.shake { animation: badgeShake 0.4s ease; }

        /* Mobile: hide on very small screens */
        @media (max-width: 480px) {
            #upd-pull-tab { display: none; }
        }

        /* ‚ïê‚ïê‚ïê NOTIFICATION SYSTEM CSS ‚ïê‚ïê‚ïê */
        /* Bell badge on sidebar icons */
        .nav-badge {
            position: absolute; top: 5px; right: 5px;
            min-width: 17px; height: 17px;
            background: #ef4444; border-radius: 9px;
            font-size: 9px; font-weight: 900; color: #fff;
            display: none; align-items: center; justify-content: center;
            padding: 0 4px; border: 2px solid #0f172a;
            pointer-events: none; z-index: 10;
            animation: badgePop .25s ease;
        }
        @keyframes badgePop { 0%{transform:scale(0)} 70%{transform:scale(1.3)} 100%{transform:scale(1)} }

        /* Notification slide-in panel */
        #notif-panel {
            position: fixed; top: 0; right: -380px; width: 360px; height: 100vh;
            background: #fff; z-index: 400;
            box-shadow: -6px 0 40px rgba(0,0,0,0.13);
            transition: right .3s cubic-bezier(.4,0,.2,1);
            display: flex; flex-direction: column;
            border-left: 1px solid #e2e8f0;
        }
        #notif-panel.open { right: 0; }
        #notif-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.2); z-index: 399;
            backdrop-filter: blur(1px);
        }
        #notif-overlay.open { display: block; }

        /* Toast */
        #toast-wrap {
            position: fixed; top: 18px; right: 18px; z-index: 9999;
            display: flex; flex-direction: column; gap: 8px;
            pointer-events: none; max-width: 320px;
        }
        .toast {
            display: flex; align-items: flex-start; gap: 10px;
            background: #1e293b; color: #fff;
            border-radius: 14px; padding: 11px 14px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.22);
            pointer-events: all;
            animation: toastIn .3s ease;
            border-left: 4px solid #6366f1;
        }
        .toast.t-task     { border-left-color: #f59e0b; }
        .toast.t-reminder { border-left-color: #ef4444; }
        .toast.t-notebook { border-left-color: #6366f1; }
        .toast.t-case     { border-left-color: #0891b2; }
        @keyframes toastIn  { from{opacity:0;transform:translateX(50px)} to{opacity:1;transform:translateX(0)} }
        @keyframes toastOut { from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(50px)} }

        /* Notif list item */
        .nitem { display:flex; gap:10px; align-items:flex-start;
            padding:10px; margin-bottom:5px; border-radius:12px;
            cursor:pointer; transition:all .15s; border:1px solid transparent; }
        .nitem:hover { transform:translateX(-2px); }
        .nitem.unread { background:#eef2ff; border-color:#c7d2fe; }
        .nitem.read   { background:#fafafa; opacity:.75; }
        .nitem .nicon { width:32px; height:32px; border-radius:9px;
            display:flex; align-items:center; justify-content:center;
            font-size:15px; flex-shrink:0; }
        .nitem .ntitle { font-size:12px; font-weight:700; color:#0f172a; line-height:1.3; }
        .nitem .nsub   { font-size:11px; color:#64748b; margin-top:1px;
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .nitem .ntime  { font-size:10px; color:#94a3b8; margin-top:3px; }
        .nitem .ndot   { width:7px; height:7px; border-radius:50%;
            background:#6366f1; flex-shrink:0; margin-top:5px; }

        /* Filter tabs in panel */
        .nf-btn { flex:1; padding:5px 3px; border-radius:8px; font-size:11px;
            font-weight:700; border:1px solid #e2e8f0; cursor:pointer;
            background:#fff; color:#64748b; transition:all .2s; }
        .nf-btn.active { background:#6366f1; color:#fff; border-color:#6366f1; }

        /* Push permission bar */
        #push-bar { padding:10px 14px; background:#fffbeb;
            border-top:1px solid #fde68a; flex-shrink:0;
            display:flex; align-items:center; gap:8px; }

        /* ‚ïê‚ïê‚ïê RIGHT SIDE UPDATE PANEL ‚ïê‚ïê‚ïê */
        #update-panel {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%) translateX(calc(100% - 36px));
            width: 280px;
            max-height: 70vh;
            z-index: 150;
            display: flex;
            flex-direction: row;
            transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
            filter: drop-shadow(-4px 4px 20px rgba(0,0,0,0.12));
        }
        #update-panel.panel-open {
            transform: translateY(-50%) translateX(0);
        }
        /* Tab handle on left edge */
        #update-tab {
            flex-shrink: 0;
            width: 36px;
            background: linear-gradient(180deg, #4f46e5, #2563eb);
            border-radius: 12px 0 0 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            padding: 14px 0;
            position: relative;
        }
        #update-tab-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            font-size: 10px;
            font-weight: 800;
            color: white;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
            margin: 4px 0;
        }
        #update-total-badge {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 18px;
            height: 18px;
            background: #ef4444;
            border-radius: 9px;
            font-size: 9px;
            font-weight: 900;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid white;
            animation: badgePop .25s ease;
        }
        /* Panel body */
        #update-body {
            flex: 1;
            background: white;
            border-radius: 0 12px 12px 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(99,102,241,0.12);
            border-left: none;
        }
        /* Update item */
        .upd-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid #f8faff;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
            text-decoration: none;
        }
        .upd-item:hover { background: #f0f4ff; }
        .upd-item:last-child { border-bottom: none; }
        .upd-icon {
            width: 30px; height: 30px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }
        .upd-count-badge {
            position: absolute;
            top: 6px; right: 10px;
            min-width: 20px; height: 20px;
            border-radius: 10px;
            font-size: 10px; font-weight: 900; color: white;
            display: flex; align-items: center; justify-content: center;
            padding: 0 5px;
            animation: badgePop .25s ease;
        }
        /* Slide animation for new items */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .upd-item.new-item { animation: slideInRight .3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] overflow-hidden flex flex-col selection:bg-blue-200">

    <div id="login-screen" class="absolute inset-0 z-[100] flex overflow-hidden">
        <!-- Left panel ‚Äî branding -->
        <div class="hidden md:flex flex-col justify-between w-1/2 bg-gradient-to-br from-slate-900 via-blue-950 to-indigo-900 p-12 relative overflow-hidden">
            <!-- Decorative circles -->
            <div class="absolute -top-24 -left-24 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -right-24 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl"></div>
            <!-- Logo + name -->
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-16">
                    <svg width="44" height="44" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="40" height="40" rx="11" fill="url(#g44)"/>
<defs><linearGradient id="g44" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#3b82f6"/></linearGradient></defs>
<rect x="12" y="10" width="16" height="20" rx="3" fill="white" fill-opacity="0.2" stroke="white" stroke-width="1.5"/>
<path d="M16 16h8M16 20h8M16 24h5" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
</svg>
                    <span class="text-white font-black text-xl tracking-tight">CaseDesk <span class="text-blue-400">AI</span></span>
                </div>
                <h2 class="text-5xl font-black text-white leading-tight mb-4">Your AI-Powered<br/><span class="text-blue-400">Case Manager</span></h2>
                <p class="text-slate-400 text-base leading-relaxed max-w-sm">Banking cases, tasks aur reminders ‚Äî sab kuch ek jagah. AI se boliye, automatically ho jata hai.</p>
            </div>
            <!-- Feature list -->
            <div class="relative z-10 space-y-4">
                <div class="flex items-center gap-3 text-slate-300 text-sm"><div class="w-8 h-8 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400">üìã</div> Smart case notes ‚Äî Hindi mein, auto-draft</div>
                <div class="flex items-center gap-3 text-slate-300 text-sm"><div class="w-8 h-8 bg-indigo-500/20 rounded-xl flex items-center justify-center text-indigo-400">‚è∞</div> Smart reminders with overdue alerts</div>
                <div class="flex items-center gap-3 text-slate-300 text-sm"><div class="w-8 h-8 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-400">ü§ñ</div> GPT-4.1 powered AI assistant</div>
            </div>
        </div>
        <!-- Right panel ‚Äî login form REDESIGNED -->
        <div class="flex-1 flex flex-col items-center justify-center relative overflow-hidden px-8 md:px-16"
             style="background:linear-gradient(145deg,#f0f4ff 0%,#faf5ff 40%,#fdf2f8 70%,#f0fdf4 100%);">
            <!-- Animated decorative blobs -->
            <div style="position:absolute;top:-80px;right:-80px;width:320px;height:320px;background:linear-gradient(135deg,rgba(99,102,241,0.12),rgba(139,92,246,0.08));border-radius:50%;animation:blobFloat 8s ease-in-out infinite;"></div>
            <div style="position:absolute;bottom:-60px;left:-60px;width:260px;height:260px;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(16,185,129,0.06));border-radius:50%;animation:blobFloat 10s ease-in-out infinite reverse;"></div>
            <div style="position:absolute;top:40%;left:10%;width:120px;height:120px;background:rgba(245,158,11,0.06);border-radius:50%;animation:blobFloat 6s ease-in-out infinite 2s;"></div>
            <!-- Mobile logo -->
            <div class="md:hidden flex items-center gap-2 mb-8 relative z-10">
                <div style="width:40px;height:40px;background:linear-gradient(135deg,#6366f1,#3b82f6);border-radius:11px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(99,102,241,0.4);">
                    <svg width="22" height="22" viewBox="0 0 40 40" fill="none"><rect x="10" y="8" width="20" height="26" rx="4" fill="white" fill-opacity="0.25" stroke="white" stroke-width="1.5"/><path d="M14 16h12M14 21h12M14 26h8" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                </div>
                <span class="font-black text-xl text-slate-800 tracking-tight">CaseDesk <span class="text-indigo-600">AI</span></span>
            </div>
            <div class="w-full max-w-sm relative z-10">
                <!-- Welcome badge -->
                <div style="display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#eef2ff,#e0e7ff);border:1px solid #c7d2fe;border-radius:100px;padding:5px 14px;margin-bottom:20px;">
                    <span style="width:6px;height:6px;background:#6366f1;border-radius:50%;animation:pulse 2s infinite;display:inline-block;"></span>
                    <span style="font-size:11px;font-weight:800;color:#4338ca;letter-spacing:0.5px;">SECURE LOGIN</span>
                </div>
                <h3 style="font-size:36px;font-weight:900;background:linear-gradient(135deg,#1e1b4b,#312e81,#4f46e5);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;line-height:1.1;">Welcome<br/>back üëã</h3>
                <p style="color:#6b7280;font-size:14px;margin-bottom:32px;font-weight:500;">Your AI-powered case manager awaits</p>
                <!-- Google button -->
                <button id="login-btn" style="width:100%;background:white;border:2px solid #e0e7ff;padding:16px 20px;border-radius:16px;font-weight:700;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s;box-shadow:0 4px 20px rgba(99,102,241,0.12);"
                    onmouseenter="this.style.borderColor='#818cf8';this.style.boxShadow='0 6px 30px rgba(99,102,241,0.2)';this.style.transform='translateY(-2px)'"
                    onmouseleave="this.style.borderColor='#e0e7ff';this.style.boxShadow='0 4px 20px rgba(99,102,241,0.12)';this.style.transform=''">
                    <svg style="width:20px;height:20px;flex-shrink:0" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    <span style="color:#1e1b4b;flex:1;text-align:center;">Continue with Google</span>
                    <svg style="width:16px;height:16px;color:#818cf8" fill="none" viewBox="0 0 24 24" stroke="#818cf8" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </button>
                <!-- Divider -->
                <div style="display:flex;align-items:center;gap:12px;margin:24px 0;">
                    <div style="flex:1;height:1px;background:linear-gradient(90deg,transparent,#c7d2fe);"></div>
                    <span style="font-size:11px;font-weight:700;color:#a5b4fc;letter-spacing:1px;">PRIVATE & SECURE</span>
                    <div style="flex:1;height:1px;background:linear-gradient(90deg,#c7d2fe,transparent);"></div>
                </div>
                <!-- Feature badges -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                    <div style="background:linear-gradient(135deg,#eef2ff,#e0e7ff);border:1px solid #c7d2fe;border-radius:16px;padding:14px 8px;text-align:center;">
                        <div style="font-size:22px;margin-bottom:4px;">üîê</div>
                        <div style="font-size:10px;font-weight:800;color:#4338ca;">Encrypted</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #bfdbfe;border-radius:16px;padding:14px 8px;text-align:center;">
                        <div style="font-size:22px;margin-bottom:4px;">‚òÅÔ∏è</div>
                        <div style="font-size:10px;font-weight:800;color:#1d4ed8;">Cloud Sync</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #bbf7d0;border-radius:16px;padding:14px 8px;text-align:center;">
                        <div style="font-size:22px;margin-bottom:4px;">ü§ñ</div>
                        <div style="font-size:10px;font-weight:800;color:#15803d;">AI Powered</div>
                    </div>
                </div>
                <!-- Trust indicators -->
                <div style="margin-top:24px;display:flex;align-items:center;justify-content:center;gap:16px;">
                    <div style="display:flex;align-items:center;gap:5px;color:#9ca3af;font-size:11px;font-weight:600;">
                        <span style="width:5px;height:5px;background:#22c55e;border-radius:50%;"></span> GPT-4.1 Powered
                    </div>
                    <div style="width:1px;height:12px;background:#e5e7eb;"></div>
                    <div style="display:flex;align-items:center;gap:5px;color:#9ca3af;font-size:11px;font-weight:600;">
                        <span style="width:5px;height:5px;background:#6366f1;border-radius:50%;"></span> Firebase Secured
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PIN SCREEN ‚Äî Complete Redesign ‚ïê‚ïê‚ïê -->
    <div id="pin-screen" class="hidden absolute inset-0 z-[100]" style="background:linear-gradient(145deg,#0f172a 0%,#1e1b4b 40%,#0f172a 100%);">
        <!-- Animated bg elements -->
        <div style="position:absolute;inset:0;overflow:hidden;pointer-events:none;">
            <div style="position:absolute;top:-100px;left:-100px;width:400px;height:400px;background:radial-gradient(circle,rgba(99,102,241,0.15) 0%,transparent 70%);animation:blobFloat 8s ease-in-out infinite;"></div>
            <div style="position:absolute;bottom:-80px;right:-80px;width:350px;height:350px;background:radial-gradient(circle,rgba(59,130,246,0.12) 0%,transparent 70%);animation:blobFloat 10s ease-in-out infinite reverse;"></div>
            <div style="position:absolute;top:50%;left:70%;width:200px;height:200px;background:radial-gradient(circle,rgba(139,92,246,0.08) 0%,transparent 70%);animation:blobFloat 6s ease-in-out infinite 3s;"></div>
            <!-- Grid lines -->
            <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(99,102,241,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(99,102,241,0.03) 1px,transparent 1px);background-size:40px 40px;"></div>
        </div>

        <!-- Update mini-panel (locked, shows counts but asks for PIN) -->
        <div id="pin-update-mini" style="position:absolute;top:20px;right:20px;display:none;z-index:10;">
            <div style="background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:12px 16px;min-width:200px;">
                <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.5);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">üì° Live Updates</div>
                <div id="pin-upd-rows" style="display:flex;flex-direction:column;gap:6px;"></div>
                <div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.08);font-size:10px;color:rgba(99,102,241,0.8);font-weight:700;text-align:center;cursor:pointer;" onclick="document.getElementById('pin-input').focus()">
                    üîí PIN dalkar dekho ‚Üí
                </div>
            </div>
        </div>

        <!-- Center card -->
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;">
            <!-- Logo -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:32px;">
                <div style="width:46px;height:46px;background:linear-gradient(135deg,#6366f1,#3b82f6);border-radius:13px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(99,102,241,0.5);">
                    <svg width="26" height="26" viewBox="0 0 40 40" fill="none"><rect x="10" y="8" width="20" height="26" rx="4" fill="white" fill-opacity="0.25" stroke="white" stroke-width="1.5"/><path d="M14 16h12M14 21h12M14 26h8" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                </div>
                <div>
                    <div style="font-size:20px;font-weight:900;color:white;letter-spacing:-0.5px;">CaseDesk <span style="color:#818cf8;">AI</span></div>
                    <div style="font-size:10px;font-weight:700;color:rgba(255,255,255,0.4);letter-spacing:1px;">SECURE ACCESS</div>
                </div>
            </div>

            <!-- Main PIN card -->
            <div style="background:rgba(255,255,255,0.05);backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,0.1);border-radius:28px;padding:36px 40px;width:100%;max-width:360px;text-align:center;box-shadow:0 32px 80px rgba(0,0,0,0.4);">
                <!-- Lock icon animated -->
                <div style="width:64px;height:64px;background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(59,130,246,0.2));border:1px solid rgba(255,255,255,0.15);border-radius:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:28px;animation:lockPulse 3s ease-in-out infinite;">üîê</div>

                <h2 style="font-size:22px;font-weight:900;color:white;margin-bottom:6px;">Enter Security PIN</h2>
                <p id="pin-msg" style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:28px;font-weight:500;">Your dashboard is protected</p>

                <!-- PIN dots -->
                <div style="display:flex;justify-content:center;gap:16px;margin-bottom:24px;" id="pin-dots-row">
                    <div class="pin-dot" style="width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.2);transition:all 0.2s;"></div>
                    <div class="pin-dot" style="width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.2);transition:all 0.2s;"></div>
                    <div class="pin-dot" style="width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.2);transition:all 0.2s;"></div>
                    <div class="pin-dot" style="width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.2);transition:all 0.2s;"></div>
                </div>

                <!-- Hidden input -->
                <input type="password" id="pin-input" maxlength="4" 
                    style="opacity:0;position:absolute;width:1px;height:1px;" 
                    inputmode="numeric" pattern="[0-9]*"/>

                <!-- Number pad -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="pin-numpad">
                    <button class="pin-key" data-v="1">1</button>
                    <button class="pin-key" data-v="2">2</button>
                    <button class="pin-key" data-v="3">3</button>
                    <button class="pin-key" data-v="4">4</button>
                    <button class="pin-key" data-v="5">5</button>
                    <button class="pin-key" data-v="6">6</button>
                    <button class="pin-key" data-v="7">7</button>
                    <button class="pin-key" data-v="8">8</button>
                    <button class="pin-key" data-v="9">9</button>
                    <button class="pin-key pin-key-clear" data-v="C">‚å´</button>
                    <button class="pin-key" data-v="0">0</button>
                    <button class="pin-key pin-key-go" data-v="OK" id="verify-pin-btn">‚úì</button>
                </div>

                <!-- Info -->
                <div id="pin-weekly-info" style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:600;display:none;">
                    üîÑ PIN weekly reset hoga
                </div>
            </div>

            <!-- Session info -->
            <div style="margin-top:20px;font-size:11px;color:rgba(255,255,255,0.3);font-weight:600;display:flex;align-items:center;gap:6px;">
                <span style="width:6px;height:6px;background:#22c55e;border-radius:50%;animation:pulse 2s infinite;display:inline-block;"></span>
                Logged in as Nilesh
            </div>
        </div>
    </div>

    <style>
        @keyframes blobFloat { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-20px) scale(1.05)} }
        @keyframes lockPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
        .pin-key {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            color: white;
            font-size: 20px;
            font-weight: 700;
            padding: 18px 10px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }
        .pin-key:hover { background:rgba(99,102,241,0.3);border-color:rgba(99,102,241,0.5);transform:scale(1.05); }
        .pin-key:active { transform:scale(0.95); }
        .pin-key-clear { background:rgba(239,68,68,0.12);border-color:rgba(239,68,68,0.2);color:#f87171; }
        .pin-key-clear:hover { background:rgba(239,68,68,0.25); }
        .pin-key-go { background:linear-gradient(135deg,#6366f1,#3b82f6);border-color:transparent;box-shadow:0 4px 16px rgba(99,102,241,0.4); }
        .pin-key-go:hover { background:linear-gradient(135deg,#4f46e5,#2563eb);box-shadow:0 6px 20px rgba(99,102,241,0.5); }
        .pin-dot.filled { background:linear-gradient(135deg,#6366f1,#3b82f6);border-color:#6366f1;box-shadow:0 0 8px rgba(99,102,241,0.5); }
        .pin-dot.shake { animation:pinShake 0.4s ease; }
        @keyframes pinShake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
    </style>

    <div id="app-layout" class="hidden flex-1 flex-col md:flex-row w-full relative overflow-hidden" style="height:100dvh;">
        
        <!-- COLLAPSIBLE SIDEBAR -->
        <nav id="sidebar" class="hidden md:flex flex-col bg-slate-900 text-slate-300 shadow-2xl z-20 relative"
             onmouseenter="this.classList.add('expanded')"
             onmouseleave="this.classList.remove('expanded')">

            <!-- Logo row -->
            <div class="h-16 border-b border-white/5 flex items-center px-3.5 gap-3 flex-shrink-0 overflow-hidden">
                <div class="flex-shrink-0"><svg width="36" height="36" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="40" height="40" rx="11" fill="url(#gsb)"/><defs><linearGradient id="gsb" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#3b82f6"/></linearGradient></defs><rect x="10" y="8" width="20" height="26" rx="4" fill="white" fill-opacity="0.2" stroke="white" stroke-width="1.5"/><path d="M14 16h12M14 21h12M14 26h8" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></div>
                <div class="logo-text flex-shrink-0 flex items-center gap-1">
                    <span class="text-[15px] font-black text-white tracking-tight">CaseDesk</span>
                    <span class="text-[15px] font-black text-blue-400">AI</span>
                </div>
            </div>

            <!-- Nav items -->
            <div class="flex-1 py-4 flex flex-col gap-1 px-2 overflow-hidden">
                <div class="nav-item" data-label="Notebook">
                    <button id="tab-notebook-desk" class="tab-btn active w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        <span class="label-text text-sm">Notebook</span>
                    </button>
                </div>
                <div class="nav-item" data-label="Client Cases">
                    <button id="tab-notes-desk" class="tab-btn w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span class="label-text text-sm">Client Cases</span>
                    </button>
                </div>
                <div class="nav-item" data-label="Tasks">
                    <button id="tab-tasks-desk" class="tab-btn w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300" style="position:relative;">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                        <span class="label-text text-sm">Tasks</span>
                        <span id="task-badge" class="nav-badge">0</span>
                    </button>
                </div>
                <div class="nav-item" data-label="Reminders">
                    <button id="tab-reminders-desk" class="tab-btn w-full h-11 rounded-xl font-medium transition-all flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-300" style="position:relative;">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        <span class="label-text text-sm">Reminders</span>
                        <span id="rem-badge" class="nav-badge">0</span>
                    </button>
                </div>
            </div>

            <!-- Notification Bell -->
            <div class="px-2 pb-1">
                <div class="nav-item" data-label="Notifications">
                    <button id="notif-bell-btn" style="position:relative;" class="w-full h-11 rounded-xl font-medium transition-colors flex items-center gap-3 px-2.5 hover:bg-white/5 text-slate-400 hover:text-yellow-300 justify-center">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/><circle cx="19" cy="5" r="3" fill="#ef4444" stroke="none" id="bell-dot" style="display:none"/></svg>
                        <span class="label-text text-sm">Notifications</span>
                        <span id="bell-badge" class="nav-badge" style="border-color:#1e293b;">0</span>
                    </button>
                </div>
            </div>

            <!-- Logout -->
            <div class="p-2 border-t border-white/5 flex-shrink-0">
                <div class="nav-item" data-label="Logout">
                    <button id="logout-btn-desk" class="w-full h-11 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl font-medium transition-colors flex items-center gap-3 px-2.5 justify-center">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        <span class="label-text logout-text text-sm">Logout</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-1 relative flex flex-col h-full overflow-hidden" style="background:transparent">
            <header class="md:hidden bg-white border-b border-slate-200 px-5 py-4 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-2">
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="40" height="40" rx="11" fill="url(#gmob)"/><defs><linearGradient id="gmob" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#3b82f6"/></linearGradient></defs><rect x="10" y="8" width="20" height="26" rx="4" fill="white" fill-opacity="0.2" stroke="white" stroke-width="1.5"/><path d="M14 16h12M14 21h12M14 26h8" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                    <h1 class="text-base font-black text-slate-900 tracking-tight">CaseDesk <span class="text-blue-500">AI</span></h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="notif-bell-mob" style="position:relative;width:36px;height:36px;border-radius:10px;background:#f1f5f9;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="#475569" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        <span id="bell-badge-mob" class="nav-badge" style="border-color:#f1f5f9;top:2px;right:2px;display:none;">0</span>
                    </button>
                    <button id="logout-btn-mob" class="text-xs bg-slate-100 text-slate-600 px-3 py-2 rounded-lg font-medium">Logout</button>
                </div>
            </header>

            <div id="view-notebook" class="absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex flex-col overflow-hidden">
                <!-- Sticky toolbar -->
                <div class="toolbar-glass px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">üìì My Notebook</h2>
                            <span id="nb-count" class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">0 notes</span>
                        </div>
                        <!-- Search + Sort + Filter row -->
                        <div class="flex flex-wrap gap-2 items-center">
                            <div class="relative flex-1 min-w-[180px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                                <input id="nb-search" type="text" placeholder="Search notes..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 focus:bg-white transition"/>
                            </div>
                            <select id="nb-sort" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 focus:outline-none focus:border-blue-400 text-slate-600">
                                <option value="new">üïê Newest First</option>
                                <option value="old">üìÖ Oldest First</option>
                                <option value="az">üî§ A ‚Üí Z</option>
                            </select>
                            <select id="nb-filter" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 focus:outline-none focus:border-blue-400 text-slate-600">
                                <option value="all">üìÇ All Clients</option>
                            </select>
                            <button id="nb-view-toggle" class="text-xs font-bold border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 hover:bg-blue-50 hover:border-blue-300 text-slate-600 transition" title="Toggle view">‚äû Grid</button>
                        </div>
                    </div>
                </div>
                <!-- Scrollable grid -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8">
                    <div class="max-w-6xl mx-auto">
                        <div id="notebook-grid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 items-start"></div>
                        <div id="nb-empty" class="hidden text-center py-20 text-slate-400">
                            <div class="text-5xl mb-3">üì≠</div>
                            <p class="font-semibold">No notes found</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-notes" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-y-auto p-4 md:p-10">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-slate-900 tracking-tight">Client Cases</h2>
                    <p class="text-slate-500 mb-10 text-sm md:text-base">Har client ki history aur latest updates ka record.</p>
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20"></div>
                </div>
            </div>

            <div id="view-tasks" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-hidden">
                <!-- Tasks Toolbar -->
                <div class="toolbar-glass px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">‚úÖ My Tasks</h2>
                            <div class="flex items-center gap-2">
                                <span id="task-pending-count" class="text-xs font-black text-orange-600 bg-orange-50 border border-orange-200 px-3 py-1 rounded-full">0 Pending</span>
                                <span id="task-done-count" class="text-xs font-black text-green-600 bg-green-50 border border-green-200 px-3 py-1 rounded-full">0 Done</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative flex-1 min-w-[160px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                                <input id="task-search" type="text" placeholder="Search tasks..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 focus:bg-white transition"/>
                            </div>
                            <div id="task-filter-btns" class="flex gap-1.5">
                                <button data-filter="all" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600">All</button>
                                <button data-filter="Pending" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-orange-50 hover:border-orange-200 hover:text-orange-700">‚è≥ Pending</button>
                                <button data-filter="Done" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-green-50 hover:border-green-200 hover:text-green-700">‚úÖ Done</button>
                                <button data-filter="Urgent" class="task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-red-50 hover:border-red-200 hover:text-red-700">üö® Urgent</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 md:px-10 py-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="tasks-list" class="flex flex-col gap-3 pb-20"></div>
                        <div id="task-empty" class="hidden text-center py-20 text-slate-400"><div class="text-5xl mb-3">üéâ</div><p class="font-semibold">Koi task nahi! Sab clear hai.</p></div>
                    </div>
                </div>
            </div>

            <div id="view-reminders" class="hidden absolute inset-0 md:top-0 top-[65px] md:bottom-0 bottom-[65px] flex-col overflow-hidden">
                <!-- Reminders Toolbar -->
                <div class="toolbar-glass px-4 md:px-10 py-4 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">‚è∞ Reminders</h2>
                            <div class="flex gap-2">
                                <span id="rem-upcoming-count" class="text-xs font-black text-blue-700 bg-blue-50 border border-blue-200 px-3 py-1 rounded-full">0 Upcoming</span>
                                <span id="rem-overdue-count" class="text-xs font-black text-red-700 bg-red-50 border border-red-200 px-3 py-1 rounded-full">0 Overdue</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative flex-1 min-w-[160px]">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                                <input id="rem-search" type="text" placeholder="Search reminders..." class="w-full pl-8 pr-3 py-2 text-sm border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:border-blue-400 transition"/>
                            </div>
                            <div class="flex gap-1.5">
                                <button data-remfilter="all" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600">All</button>
                                <button data-remfilter="today" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-blue-50">üìÖ Today</button>
                                <button data-remfilter="upcoming" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-green-50">üü¢ Upcoming</button>
                                <button data-remfilter="overdue" class="rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50 hover:bg-red-50">üî¥ Overdue</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 md:px-10 py-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="reminders-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div>
                        <div id="rem-empty" class="hidden text-center py-20 text-slate-400"><div class="text-5xl mb-3">üóìÔ∏è</div><p class="font-semibold">Koi reminder nahi.</p></div>
                    </div>
                </div>
            </div>


                        <!-- ‚ïê‚ïê‚ïê RIGHT SIDE LIVE UPDATE PANEL ‚ïê‚ïê‚ïê -->
            <div id="upd-panel-wrap">

                <!-- Panel body (hidden until open) -->
                <div id="upd-panel-body">
                    <div id="upd-panel-inner">

                        <!-- Header -->
                        <div style="padding:11px 14px 10px;border-bottom:2px solid #eef2ff;background:linear-gradient(135deg,#f8faff 0%,#eef2ff 100%);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;">
                            <div style="display:flex;align-items:center;gap:7px;">
                                <div style="width:26px;height:26px;background:#4f46e5;border-radius:7px;display:flex;align-items:center;justify-content:center;">
                                    <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </div>
                                <span style="font-size:12px;font-weight:800;color:#312e81;">Live Updates</span>
                            </div>
                            <button onclick="clearAllUpdates()" title="Sab clear karo"
                                style="font-size:9px;font-weight:700;color:#94a3b8;background:none;border:1px solid #e2e8f0;cursor:pointer;padding:3px 8px;border-radius:6px;"
                                onmouseenter="this.style.background='#f1f5f9';this.style.color='#ef4444'"
                                onmouseleave="this.style.background='none';this.style.color='#94a3b8'">
                                ‚úï Clear
                            </button>
                        </div>

                        <!-- Rows container -->
                        <div id="upd-rows" style="overflow-y:auto;flex:1;">

                            <!-- NOTEBOOK row -->
                            <button class="upd-row" id="upd-row-notebook" onclick="goToPage('notebook')" style="display:none;">
                                <div class="upd-row-icon" style="background:#eef2ff;">üìì</div>
                                <div style="flex:1;min-width:0;">
                                    <div class="upd-row-title" style="color:#312e81;">Notebook</div>
                                    <div class="upd-row-sub" id="upd-sub-notebook" style="color:#6366f1;"></div>
                                </div>
                                <div class="upd-row-badge" id="upd-badge-notebook" style="background:#6366f1;display:none;">0</div>
                            </button>

                            <!-- CLIENT CASES row -->
                            <button class="upd-row" id="upd-row-notes" onclick="goToPage('notes')" style="display:none;">
                                <div class="upd-row-icon" style="background:#ecfeff;">üìÇ</div>
                                <div style="flex:1;min-width:0;">
                                    <div class="upd-row-title" style="color:#0e7490;">Client Cases</div>
                                    <div class="upd-row-sub" id="upd-sub-notes" style="color:#0891b2;"></div>
                                </div>
                                <div class="upd-row-badge" id="upd-badge-notes" style="background:#0891b2;display:none;">0</div>
                            </button>

                            <!-- TASKS row -->
                            <button class="upd-row" id="upd-row-tasks" onclick="goToPage('tasks')" style="display:none;">
                                <div class="upd-row-icon" style="background:#fffbeb;">‚úÖ</div>
                                <div style="flex:1;min-width:0;">
                                    <div class="upd-row-title" style="color:#92400e;">Tasks</div>
                                    <div class="upd-row-sub" id="upd-sub-tasks" style="color:#d97706;"></div>
                                </div>
                                <div class="upd-row-badge" id="upd-badge-tasks" style="background:#f59e0b;display:none;">0</div>
                            </button>

                            <!-- REMINDERS row -->
                            <button class="upd-row" id="upd-row-reminders" onclick="goToPage('reminders')" style="display:none;">
                                <div class="upd-row-icon" style="background:#fff1f2;">‚è∞</div>
                                <div style="flex:1;min-width:0;">
                                    <div class="upd-row-title" style="color:#9f1239;">Reminders</div>
                                    <div class="upd-row-sub" id="upd-sub-reminders" style="color:#ef4444;"></div>
                                </div>
                                <div class="upd-row-badge" id="upd-badge-reminders" style="background:#ef4444;display:none;">0</div>
                            </button>

                            <!-- Empty state -->
                            <div id="upd-empty-state" style="padding:22px 14px;text-align:center;color:#cbd5e1;">
                                <div style="font-size:28px;margin-bottom:8px;">‚ö°</div>
                                <div style="font-size:11px;font-weight:700;color:#94a3b8;">Koi update nahi abhi</div>
                                <div style="font-size:10px;color:#cbd5e1;margin-top:3px;">AI kuch save karega tab yahan count dikhega</div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div id="upd-footer" style="display:none;padding:6px 14px;background:#f8faff;border-top:1px solid #e2e8f0;flex-shrink:0;">
                            <span style="font-size:9px;font-weight:600;color:#94a3b8;">Last update: </span>
                            <span id="upd-last-time" style="font-size:9px;font-weight:700;color:#6366f1;"></span>
                        </div>
                    </div>
                </div>

                <!-- Pull tab (always on right edge) -->
                <div id="upd-pull-tab" onclick="toggleUpdPanel()" title="Live Updates">
                    <span id="upd-tab-count">0</span>
                    <svg id="upd-tab-icon" width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span id="upd-tab-text">Updates</span>
                    <svg id="upd-tab-chevron" width="11" height="11" fill="none" viewBox="0 0 24 24" stroke="rgba(255,255,255,0.6)" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                </div>

            </div>

            <!-- DRAGGABLE FAB -->
            <div id="chat-fab" style="position:fixed;bottom:28px;right:24px;z-index:200;cursor:grab;user-select:none;">
                <button id="open-chat-fab" style="width:62px;height:62px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#2563eb);box-shadow:0 8px 32px rgba(79,70,229,0.45);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;position:relative;" title="CaseDesk AI">
                    <!-- CaseDesk AI doc icon -->
                    <svg width="28" height="28" viewBox="0 0 40 40" fill="none">
                        <rect x="8" y="5" width="24" height="30" rx="5" fill="white"/>
                        <path d="M14 14h12M14 20h12M14 26h8" stroke="#4f46e5" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                    <!-- Notification badge -->
                    <span id="fab-badge" style="display:none;position:absolute;top:-3px;right:-3px;min-width:18px;height:18px;background:#ef4444;border-radius:9px;border:2px solid #fff;font-size:10px;font-weight:900;color:white;align-items:center;justify-content:center;padding:0 3px;">0</span>
                    <!-- Pulse ring -->
                    <span style="position:absolute;inset:-4px;border-radius:50%;border:2px solid rgba(79,70,229,0.4);animation:fabPulse 2.5s infinite;pointer-events:none;"></span>
                </button>
            </div>
        </main>

        <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex items-center justify-around h-[65px] pb-1 shadow-[0_-10px_20px_rgba(0,0,0,0.03)] z-[30]">
            <button id="tab-notebook-mob" class="tab-btn-mob active flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">üìì</span> Notebook
            </button>
            <button id="tab-notes-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">üìÇ</span> Cases
            </button>
            <button id="tab-tasks-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">‚úÖ</span> Tasks
            </button>
            <button id="tab-reminders-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1.5 text-slate-400 text-[10px] transition-colors">
                <span class="text-lg">‚è∞</span> Reminds
            </button>
        </nav>
    </div>

    <!-- FLOATING CHAT PANEL ‚Äî Draggable, Right-side, Modern -->
    <div id="chat-panel" style="
        display:none;
        position:fixed;
        bottom:100px;
        right:20px;
        width:min(390px, calc(100vw - 32px));
        height:min(580px, calc(100vh - 120px));
        z-index:500;
        border-radius:20px;
        box-shadow:0 24px 60px rgba(0,0,0,0.18),0 4px 16px rgba(79,70,229,0.12);
        overflow:hidden;
        border:1px solid rgba(255,255,255,0.8);
        background:#f8faff;
        flex-direction:column;
        transition:opacity 0.2s,transform 0.2s;
        min-width:300px;min-height:380px;
        max-width:calc(100vw - 32px);
        max-height:calc(100vh - 80px);
    ">
        <!-- RESIZE HANDLE -->
        <div id="chat-resize" style="position:absolute;bottom:0;left:0;right:0;height:6px;cursor:ns-resize;z-index:10;background:transparent;"></div>

        <!-- HEADER ‚Äî Draggable -->
        <div id="chat-panel-header" style="
            background:linear-gradient(135deg,#1e1b4b 0%,#312e81 50%,#1d4ed8 100%);
            padding:14px 16px 12px;
            display:flex;align-items:center;gap:12px;
            cursor:move;flex-shrink:0;
            position:relative;overflow:hidden;
        ">
            <!-- Decorative glow -->
            <div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:rgba(139,92,246,0.2);border-radius:50%;pointer-events:none;"></div>
            <!-- AI Avatar -->
            <div style="width:40px;height:40px;border-radius:12px;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="40" height="40" rx="11" fill="url(#g40)"/>
<defs><linearGradient id="g40" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#3b82f6"/></linearGradient></defs>
<rect x="12" y="10" width="16" height="20" rx="3" fill="white" fill-opacity="0.2" stroke="white" stroke-width="1.5"/>
<path d="M16 16h8M16 20h8M16 24h5" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
</svg>
            </div>
            <!-- Title -->
            <div style="flex:1;min-width:0;">
                <div style="font-weight:800;font-size:14px;color:white;letter-spacing:-0.3px;line-height:1.2;">CaseDesk AI</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.6);margin-top:1px;display:flex;align-items:center;gap:4px;">
                    <span style="width:6px;height:6px;background:#4ade80;border-radius:50%;display:inline-block;animation:pulse 2s infinite;"></span>
                    Online ¬∑ GPT-4.1
                </div>
            </div>
            <!-- Header buttons -->
            <div style="display:flex;gap:6px;align-items:center;">
                <!-- Activity toggle -->
                <button id="toggle-activity-btn" title="Live Activity" style="width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.2)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </button>
                <!-- Minimize -->
                <button id="minimise-chat-btn" title="Minimize" style="width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.2)'" onmouseleave="this.style.background='rgba(255,255,255,0.1)'">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <!-- Close -->
                <button id="close-chat-btn" title="Close" style="width:30px;height:30px;border-radius:8px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseenter="this.style.background='rgba(239,68,68,0.4)'" onmouseleave="this.style.background='rgba(239,68,68,0.2)'">
                    <svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </div>

        <!-- LIVE ACTIVITY BAR (collapsible) -->
        <div id="activity-bar" style="background:#fff;border-bottom:1px solid #e2e8f0;padding:8px 14px;display:none;flex-shrink:0;">
            <div style="font-size:10px;font-weight:800;color:#6366f1;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">‚ö° Live Activity</div>
            <div id="activity-feed" style="display:flex;flex-direction:column;gap:4px;max-height:90px;overflow-y:auto;">
                <div style="font-size:11px;color:#94a3b8;font-style:italic;">Koi activity nahi abhi...</div>
            </div>
        </div>

        <!-- CHAT MESSAGES -->
        <div id="chat-box" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:#f8faff;">
            <div style="display:flex;justify-content:flex-start;">
                <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;border-top-left-radius:4px;padding:12px 14px;max-width:85%;font-size:13px;line-height:1.6;color:#334155;box-shadow:0 1px 4px rgba(0,0,0,0.05);">
                    Namaste üôè ‚Äî <strong>CaseDesk AI</strong> at your service.<br/>Boliye, kya kaam hai?
                </div>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div style="padding:12px;background:white;border-top:1px solid #e2e8f0;flex-shrink:0;">
            <div style="display:flex;gap:8px;align-items:center;background:#f1f5f9;border-radius:14px;padding:6px 8px;border:1.5px solid transparent;transition:border-color 0.2s;" id="input-wrapper">
                <!-- Mic -->
                <button id="mic-btn" title="Voice Input" style="width:36px;height:36px;border-radius:10px;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s;" onmouseenter="this.style.background='#e2e8f0'" onmouseleave="this.style.background='transparent'">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#64748b" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                </button>
                <!-- Input -->
                <input type="text" id="user-input" placeholder="Kuch bhi boliye..." style="flex:1;background:transparent;border:none;outline:none;font-size:13px;color:#1e293b;font-family:inherit;font-weight:500;" />
                <!-- Send -->
                <button id="send-btn" style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#4f46e5,#2563eb);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 2px 8px rgba(79,70,229,0.35);" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                    <svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                </button>
            </div>
            <div style="text-align:center;margin-top:6px;font-size:9px;color:#cbd5e1;font-weight:600;letter-spacing:0.5px;">CASDESK AI ¬∑ GPT-4.1</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithRedirect, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733",
            storageBucket: "ai-assistant-app-8e733.firebasestorage.app",
            messagingSenderId: "318215944760",
            appId: "1:318215944760:web:2a387b7bcd068da4ff44cd"
        };
        const SECRET_PIN = "5786"; 
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let chatHistory = [];
        let allSavedNotes = []; 
        let allTasks = [];
        let allReminders = [];
        let allNotebooks = [];

        let isPinVerified = false;
        let DYNAMIC_OPENAI_KEY = "";
        let OPENAI_MODEL = "gpt-4.1"; // Firebase se override ho sakta hai
        let sessionStartTime;

        const ui = {
            login: document.getElementById('login-screen'),
            pin: document.getElementById('pin-screen'),
            appLayout: document.getElementById('app-layout'),
            viewNotes: document.getElementById('view-notes'),
            viewTasks: document.getElementById('view-tasks'),
            viewReminders: document.getElementById('view-reminders'),
            viewNotebook: document.getElementById('view-notebook'),
            chatBox: document.getElementById('chat-box'),
            notesGrid: document.getElementById('notes-grid'),
            tasksList: document.getElementById('tasks-list'),
            remindersList: document.getElementById('reminders-list'),
            notebookGrid: document.getElementById('notebook-grid'),
            userInput: document.getElementById('user-input'),
            micBtn: document.getElementById('mic-btn'),
            chatModal: document.getElementById('chat-modal'),
            chatModalContent: document.getElementById('chat-modal-content')
        };

        const views = ['notes', 'tasks', 'reminders', 'notebook'];

        // ERROR FIXED HERE: Removing flex class so it hides properly
        function hideAllStates() {
            ui.login.classList.add('hidden'); ui.login.classList.remove('flex');
            ui.pin.classList.add('hidden'); ui.pin.classList.remove('flex');
            ui.appLayout.classList.add('hidden'); ui.appLayout.classList.remove('flex');
        }

        function switchView(targetView) {
            views.forEach(v => {
                const deskBtn = document.getElementById(`tab-${v}-desk`);
                const mobBtn = document.getElementById(`tab-${v}-mob`);
                const viewEl = document.getElementById(`view-${v}`);
                if(v === targetView) {
                    viewEl.classList.remove('hidden'); viewEl.classList.add('flex');
                    if(deskBtn) deskBtn.classList.add('active');
                    if(mobBtn) mobBtn.classList.add('active');
                } else {
                    viewEl.classList.add('hidden'); viewEl.classList.remove('flex');
                    if(deskBtn) deskBtn.classList.remove('active');
                    if(mobBtn) mobBtn.classList.remove('active');
                }
            });
        }

        // Store reference to original switchView before notification engine overrides
        const _baseSwitchView = switchView;
        views.forEach(v => {
            document.getElementById(`tab-${v}-desk`)?.addEventListener('click', () => switchView(v));
            document.getElementById(`tab-${v}-mob`)?.addEventListener('click', () => switchView(v));
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  FLOATING CHAT PANEL ‚Äî Drag, Resize, Badge, Activity
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const chatPanel  = document.getElementById('chat-panel');
        const chatFab    = document.getElementById('chat-fab');
        const fabBtn     = document.getElementById('open-chat-fab');
        const fabBadge   = document.getElementById('fab-badge');
        let unreadCount  = 0;
        let panelVisible = false;

        function showPanel() {
            chatPanel.style.display = 'flex';
            chatPanel.style.opacity = '0';
            chatPanel.style.transform = 'translateY(16px) scale(0.97)';
            // Ensure panel stays within viewport bounds
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const pw = Math.min(390, vw - 24);
            const ph = Math.min(580, vh - 120);
            chatPanel.style.width  = pw + 'px';
            chatPanel.style.height = ph + 'px';
            // Reset to bottom-right if dragged off-screen
            const rect = chatPanel.getBoundingClientRect();
            if(rect.right > vw || rect.left < 0 || rect.bottom > vh || rect.top < 0 || !chatPanel.style.left) {
                chatPanel.style.left   = 'auto';
                chatPanel.style.top    = 'auto';
                chatPanel.style.right  = '20px';
                chatPanel.style.bottom = '100px';
            }
            requestAnimationFrame(() => {
                chatPanel.style.transition = 'opacity 0.22s ease, transform 0.22s ease';
                chatPanel.style.opacity = '1';
                chatPanel.style.transform = 'translateY(0) scale(1)';
            });
            panelVisible = true;
            unreadCount = 0;
            fabBadge.style.display = 'none';
            setTimeout(() => { ui.userInput.focus(); ui.chatBox.scrollTop = ui.chatBox.scrollHeight; }, 100);
        }

        function hidePanel() {
            chatPanel.style.transition = 'opacity 0.18s ease, transform 0.18s ease';
            chatPanel.style.opacity = '0';
            chatPanel.style.transform = 'translateY(14px) scale(0.97)';
            setTimeout(() => { chatPanel.style.display = 'none'; chatPanel.style.display = ''; chatPanel.style.display = 'none'; }, 180);
            panelVisible = false;
        }

        fabBtn.addEventListener('click', (e) => {
            if(panelVisible) hidePanel(); else showPanel();
        });
        document.getElementById('minimise-chat-btn').addEventListener('click', hidePanel);
        document.getElementById('close-chat-btn').addEventListener('click', hidePanel);

        // Activity bar toggle
        document.getElementById('toggle-activity-btn').addEventListener('click', () => {
            const bar = document.getElementById('activity-bar');
            bar.style.display = (bar.style.display === 'none' || bar.style.display === '') ? 'block' : 'none';
        });

        // Add activity entry function
        window.addActivity = function(icon, text, color) {
            const feed = document.getElementById('activity-feed');
            const now = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            const placeholder = feed.querySelector('[style*="italic"]');
            if(placeholder) placeholder.remove();
            const item = document.createElement('div');
            item.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;padding:3px 0;border-bottom:1px solid #f1f5f9;';
            item.innerHTML = '<span style="font-size:12px;flex-shrink:0;">' + icon + '</span>' +
                '<span style="color:' + (color||'#475569') + ';flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + text + '</span>' +
                '<span style="color:#94a3b8;font-size:9px;flex-shrink:0;">' + now + '</span>';
            feed.insertBefore(item, feed.firstChild);
            while(feed.children.length > 8) feed.removeChild(feed.lastChild);
            if(!panelVisible) {
                unreadCount++;
                fabBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                fabBadge.style.display = 'flex';
            }
        };

        // ‚îÄ‚îÄ DRAG PANEL (header drag) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const dragHandle = document.getElementById('chat-panel-header');
        let dragging = false, dragOffX = 0, dragOffY = 0;
        dragHandle.addEventListener('mousedown', e => {
            if(e.target.closest('button')) return;
            dragging = true;
            const r = chatPanel.getBoundingClientRect();
            dragOffX = e.clientX - r.left; dragOffY = e.clientY - r.top;
            chatPanel.style.transition = 'none';
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', e => {
            if(!dragging) return;
            let nx = e.clientX - dragOffX, ny = e.clientY - dragOffY;
            const pw = chatPanel.offsetWidth, ph = chatPanel.offsetHeight;
            // Clamp so panel stays fully on screen with 8px margin
            nx = Math.max(8, Math.min(window.innerWidth - pw - 8, nx));
            ny = Math.max(8, Math.min(window.innerHeight - ph - 8, ny));
            chatPanel.style.left = nx + 'px'; chatPanel.style.top = ny + 'px';
            chatPanel.style.right = 'auto';   chatPanel.style.bottom = 'auto';
        });
        document.addEventListener('mouseup', () => { dragging = false; document.body.style.userSelect = ''; });

        // ‚îÄ‚îÄ DRAG FAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let fabDragging = false, fabOX = 0, fabOY = 0, fabMoved = false;
        chatFab.addEventListener('mousedown', e => {
            fabDragging = true; fabMoved = false;
            const r = chatFab.getBoundingClientRect();
            fabOX = e.clientX - r.left; fabOY = e.clientY - r.top;
            chatFab.style.transition = 'none';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });
        document.addEventListener('mousemove', e => {
            if(!fabDragging) return;
            fabMoved = true;
            let nx = e.clientX - fabOX, ny = e.clientY - fabOY;
            nx = Math.max(8, Math.min(window.innerWidth - chatFab.offsetWidth - 8, nx));
            ny = Math.max(8, Math.min(window.innerHeight - chatFab.offsetHeight - 8, ny));
            chatFab.style.left = nx + 'px'; chatFab.style.top = ny + 'px';
            chatFab.style.right = 'auto';   chatFab.style.bottom = 'auto';
        });
        document.addEventListener('mouseup', () => { fabDragging = false; document.body.style.userSelect = ''; });

        // ‚îÄ‚îÄ RESIZE PANEL (bottom drag) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let resizing = false, rsY = 0, rsH = 0;
        document.getElementById('chat-resize').addEventListener('mousedown', e => {
            resizing = true; rsY = e.clientY; rsH = chatPanel.offsetHeight;
            document.body.style.userSelect = 'none'; e.stopPropagation();
        });
        document.addEventListener('mousemove', e => {
            if(!resizing) return;
            const newH = Math.max(380, Math.min(window.innerHeight - 60, rsH - (e.clientY - rsY)));
            chatPanel.style.height = newH + 'px';
        });
        document.addEventListener('mouseup', () => { resizing = false; document.body.style.userSelect = ''; });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = document.getElementById('login-btn');
            const originalHTML = btn.innerHTML;
            btn.innerText = "Signing in...";
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                if(error.code === 'auth/popup-blocked') {
                    await signInWithRedirect(auth, provider);
                } else {
                    btn.innerHTML = originalHTML;
                }
            }
        });

        onAuthStateChanged(auth, (user) => {
            hideAllStates();
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    if (!isPinVerified) { 
                        ui.pin.classList.remove('hidden'); 
                        ui.pin.style.display = 'flex';
                        window._pinScreenActive = true;
                        pinCurrentVal = '';
                        if(typeof updatePinDots === 'function') updatePinDots();
                        if(typeof updatePinMiniPanel === 'function') setTimeout(updatePinMiniPanel, 100);
                    } else { 
                        checkAndLoadApp(); 
                    }
                } else { 
                    alert("Unauthorized Email!"); 
                    signOut(auth); 
                }
            } else { 
                ui.login.classList.remove('hidden'); 
                ui.login.classList.add('flex'); 
            }
        });

        // doLogout defined in PIN section above

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  PIN NUMPAD + SECURITY SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // PIN history (last 2) ‚Äî stored in sessionStorage
        const PIN_HISTORY_KEY = 'cd_pin_history';
        const PIN_WEEKLY_KEY  = 'cd_pin_week';

        function getPinHistory() {
            try { return JSON.parse(sessionStorage.getItem(PIN_HISTORY_KEY) || '[]'); } catch { return []; }
        }
        function savePinHistory(pin) {
            let hist = getPinHistory();
            hist.push(pin);
            if(hist.length > 2) hist = hist.slice(-2);
            sessionStorage.setItem(PIN_HISTORY_KEY, JSON.stringify(hist));
        }

        // Weekly PIN reset check
        function checkWeeklyPinReset() {
            const now = Date.now();
            const lastReset = parseInt(localStorage.getItem(PIN_WEEKLY_KEY) || '0');
            const oneWeek = 7 * 24 * 3600 * 1000;
            if(now - lastReset > oneWeek) {
                // Reset PIN history
                sessionStorage.removeItem(PIN_HISTORY_KEY);
                localStorage.setItem(PIN_WEEKLY_KEY, now.toString());
                const info = document.getElementById('pin-weekly-info');
                if(info) { info.style.display = 'block'; info.textContent = 'üîÑ PIN history reset (weekly)'; }
                console.log('[CaseDesk] Weekly PIN reset done');
            }
        }
        checkWeeklyPinReset();

        // numpad current value
        let pinCurrentVal = '';

        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((d, i) => {
                if(i < pinCurrentVal.length) d.classList.add('filled');
                else d.classList.remove('filled');
            });
        }

        function shakePinDots() {
            document.querySelectorAll('.pin-dot').forEach(d => {
                d.classList.add('shake');
                setTimeout(() => d.classList.remove('shake'), 400);
            });
        }

        function doVerifyPin() {
            const msgEl = document.getElementById('pin-msg');
            const currentPin = pinCurrentVal.trim();
            console.log('[CaseDesk PIN] Verifying', currentPin.length, 'digits');
            if(currentPin === SECRET_PIN) {
                isPinVerified = true;
                window._pinScreenActive = false;
                savePinHistory(currentPin);
                pinCurrentVal = '';
                updatePinDots();
                // Green success flash on dots
                document.querySelectorAll('.pin-dot').forEach(d => {
                    d.style.background = '#22c55e';
                    d.style.borderColor = '#22c55e';
                    d.style.boxShadow = '0 0 10px rgba(34,197,94,0.6)';
                });
                setTimeout(() => checkAndLoadApp(), 300);
            } else {
                shakePinDots();
                if(msgEl) { msgEl.textContent = '‚ùå Galat PIN, dobara try karein'; msgEl.style.color = '#f87171'; }
                setTimeout(() => {
                    pinCurrentVal = '';
                    updatePinDots();
                    if(msgEl) { msgEl.textContent = 'Your dashboard is protected'; msgEl.style.color = 'rgba(255,255,255,0.5)'; }
                }, 900);
            }
        }

        // Numpad click listeners ‚Äî use event delegation for reliability
        document.getElementById('pin-numpad').addEventListener('click', (e) => {
            const btn = e.target.closest('.pin-key');
            if(!btn) return;
            const v = btn.dataset.v;

            // Button press animation
            btn.style.transform = 'scale(0.92)';
            setTimeout(() => btn.style.transform = '', 120);

            if(v === 'C') {
                // Backspace
                pinCurrentVal = pinCurrentVal.slice(0, -1);
                updatePinDots();
            } else if(v === 'OK') {
                // Verify button
                if(pinCurrentVal.length === 4) {
                    doVerifyPin();
                } else {
                    // Shake to indicate incomplete
                    shakePinDots();
                }
            } else if(v !== undefined) {
                // Digit button
                if(pinCurrentVal.length < 4) {
                    pinCurrentVal += v;
                    updatePinDots();
                    // Auto-verify when 4 digits entered
                    if(pinCurrentVal.length === 4) {
                        setTimeout(() => doVerifyPin(), 200);
                    }
                }
            }
        });

        // Keyboard input on PIN screen ‚Äî use flag for reliable detection
        document.addEventListener('keydown', (e) => {
            // Check if PIN screen is actually visible using flag + class check
            const pinScreen = document.getElementById('pin-screen');
            const isVisible = window._pinScreenActive === true || 
                              (!pinScreen.classList.contains('hidden') && 
                               pinScreen.style.display !== 'none' &&
                               pinScreen.style.display !== '');
            if(!isVisible) return;

            // Prevent default to avoid browser shortcuts interfering
            if((e.key >= '0' && e.key <= '9') || e.key === 'Backspace' || e.key === 'Enter') {
                e.preventDefault();
            }

            if(e.key >= '0' && e.key <= '9' && pinCurrentVal.length < 4) {
                pinCurrentVal += e.key;
                updatePinDots();
                // Visual feedback - briefly highlight matching numpad key
                const matchBtn = document.querySelector(`.pin-key[data-v="${e.key}"]`);
                if(matchBtn) {
                    matchBtn.style.background = 'rgba(99,102,241,0.5)';
                    setTimeout(() => matchBtn.style.background = '', 150);
                }
                if(pinCurrentVal.length === 4) setTimeout(doVerifyPin, 150);
            } else if(e.key === 'Backspace') {
                pinCurrentVal = pinCurrentVal.slice(0, -1);
                updatePinDots();
            } else if(e.key === 'Enter' && pinCurrentVal.length === 4) {
                doVerifyPin();
            }
        });

        // Old verify-pin-btn fallback (now pin-key-go handles it)
        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if(pinCurrentVal.length === 4) doVerifyPin();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  5-MINUTE INACTIVE ‚Üí LOCK BACK TO PIN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let inactiveTimer = null;
        const INACTIVE_MS = 5 * 60 * 1000; // 5 minutes

        function resetInactiveTimer() {
            if(!isPinVerified) return;
            clearTimeout(inactiveTimer);
            inactiveTimer = setTimeout(() => {
                // Lock to PIN screen
                isPinVerified = false;
                pinCurrentVal = '';
                updatePinDots();
                const msgEl = document.getElementById('pin-msg');
                if(msgEl) { msgEl.textContent = '‚è∞ Session locked after 5 min inactivity'; msgEl.style.color = '#fbbf24'; }
                hideAllStates();
                ui.pin.classList.remove('hidden'); 
                ui.pin.style.display = 'flex';
                window._pinScreenActive = true;
                updatePinMiniPanel();
            }, INACTIVE_MS);
        }

        // Listen for user activity
        ['mousemove','keydown','click','touchstart','scroll'].forEach(evt => {
            document.addEventListener(evt, resetInactiveTimer, { passive: true });
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  CLEAR PIN ON SIGNOUT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const doLogout = () => {
            isPinVerified = false;
            DYNAMIC_OPENAI_KEY = "";
            pinCurrentVal = '';
            updatePinDots();
            clearTimeout(inactiveTimer);
            UP.counts = { notebook:0, notes:0, tasks:0, reminders:0 };
            const msgEl = document.getElementById('pin-msg');
            if(msgEl) { msgEl.textContent = 'Sign in again to access your dashboard'; msgEl.style.color = 'rgba(255,255,255,0.5)'; }
            signOut(auth);
        };
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  PIN MINI-PANEL ‚Äî shows counts on lock screen
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function updatePinMiniPanel() {
            const panel = document.getElementById('pin-update-mini');
            const rowsEl = document.getElementById('pin-upd-rows');
            if(!panel || !rowsEl) return;

            const totalCount = Object.values(UP.counts).reduce((a,b) => a+b, 0);
            const nsCount = NS.items.filter(i=>!i.read).length;
            const totalAll = totalCount + nsCount;

            if(totalAll === 0) { panel.style.display = 'none'; return; }
            panel.style.display = 'block';

            const items = [
                { label:'üìì Notebook', count: UP.counts.notebook, color:'#818cf8' },
                { label:'üìÇ Cases', count: UP.counts.notes, color:'#22d3ee' },
                { label:'‚úÖ Tasks', count: UP.counts.tasks + NS.items.filter(i=>i.type==='task'&&!i.read).length, color:'#fbbf24' },
                { label:'‚è∞ Reminders', count: UP.counts.reminders + NS.items.filter(i=>i.type==='reminder'&&!i.read).length, color:'#f87171' },
            ].filter(i => i.count > 0);

            rowsEl.innerHTML = items.map(item => `
                <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                    <span style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.7);">${item.label}</span>
                    <span style="background:${item.color};color:#fff;font-size:10px;font-weight:900;padding:2px 8px;border-radius:10px;min-width:24px;text-align:center;">${item.count > 99 ? '99+' : item.count}</span>
                </div>
            `).join('');
        }

        async function checkAndLoadApp() {
            hideAllStates();
            try {
                const keyDoc = await getDoc(doc(db, "system_settings", "api_config"));
                if (keyDoc.exists() && keyDoc.data().openai_key) {
                    DYNAMIC_OPENAI_KEY = keyDoc.data().openai_key;
                    if (keyDoc.data().openai_model) OPENAI_MODEL = keyDoc.data().openai_model;
                    sessionStartTime = new Date().toISOString(); 
                    
                    ui.appLayout.classList.remove('hidden'); 
                    ui.appLayout.classList.add('flex');
                    // Start inactive timer
                    if(typeof resetInactiveTimer === 'function') resetInactiveTimer();
                    
                    switchView('notebook');
                    loadAppListeners();
                } else { 
                    alert("API Key missing in Database!");
                    ui.login.classList.remove('hidden'); ui.login.classList.add('flex');
                    signOut(auth);
                }
            } catch (error) { 
                alert("Database connection failed."); 
                console.error(error);
            }
        }

        function loadAppListeners() {
            const chatQuery = query(collection(db, "chats"), where("timestamp", ">=", sessionStartTime), orderBy("timestamp", "asc"));
            onSnapshot(chatQuery, (snapshot) => {
                const welcomeMsg = ui.chatBox.firstElementChild;
                ui.chatBox.innerHTML = ""; 
                if(welcomeMsg) ui.chatBox.appendChild(welcomeMsg);
                
                chatHistory = []; 
                snapshot.forEach((docData) => {
                    const msg = docData.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            });

            onSnapshot(query(collection(db, "notes"), orderBy("timestamp", "asc")), (snapshot) => {
                ui.notesGrid.innerHTML = ""; allSavedNotes = []; let groupedNotes = {};
                snapshot.forEach((docData) => {
                    const note = docData.data(); allSavedNotes.push(note);
                    const normalizedTitle = (note.client || note.title || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø").toUpperCase();
                    if(!groupedNotes[normalizedTitle]) groupedNotes[normalizedTitle] = {
                        displayTitle: note.client || note.title || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        mobile: note.mobile || null,
                        updates: []
                    };
                    if(!groupedNotes[normalizedTitle].mobile) {
                        const mobMatch = (note.content || "").match(/\b[6-9]\d{9}\b/);
                        if(mobMatch) groupedNotes[normalizedTitle].mobile = mobMatch[0];
                    }
                    groupedNotes[normalizedTitle].updates.push(note);
                });

                for (const key in groupedNotes) {
                    const group = groupedNotes[key];
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-2xl shadow-md hover:shadow-xl border border-slate-100 relative overflow-hidden transition-all duration-300 group";

                    const latestUpdate = group.updates[group.updates.length - 1];
                    const latestContent = (latestUpdate?.content || "").toLowerCase();
                    let statusBadge = "üîµ Active";
                    let statusColor = "bg-blue-50 text-blue-700 border-blue-200";
                    // STRICT matching ‚Äî avoid false positives like "disbursement suunishchit"
                    if(/disburse ho gaya|disbursed|‡§µ‡§ø‡§§‡§∞‡§£ ‡§π‡•ã ‡§ó‡§Ø‡§æ|‡§µ‡§ø‡§§‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£/.test(latestContent))
                        { statusBadge = "‚úÖ Disbursed";  statusColor = "bg-green-50 text-green-700 border-green-200"; }
                    else if(/rejected|‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§/.test(latestContent))
                        { statusBadge = "‚ùå Rejected";   statusColor = "bg-red-50 text-red-700 border-red-200"; }
                    else if(/sanctioned|sanction ho gaya|‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ|‡§ã‡§£ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§/.test(latestContent))
                        { statusBadge = "‚úîÔ∏è Sanctioned"; statusColor = "bg-emerald-50 text-emerald-700 border-emerald-200"; }
                    else if(/mortgage|‡§Æ‡•â‡§∞‡•ç‡§ó‡•á‡§ú/.test(latestContent))
                        { statusBadge = "üìë Mortgage";   statusColor = "bg-purple-50 text-purple-700 border-purple-200"; }
                    else if(/processing start|processing ho|‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó/.test(latestContent))
                        { statusBadge = "üîÑ Processing"; statusColor = "bg-indigo-50 text-indigo-700 border-indigo-200"; }
                    else if(/pending|‡§≤‡§Ç‡§¨‡§ø‡§§/.test(latestContent))
                        { statusBadge = "‚è≥ Pending";    statusColor = "bg-yellow-50 text-yellow-700 border-yellow-200"; }

                    function fmtDate(ts) {
                        const d = new Date(ts);
                        return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                    }
                    function fmtTime(ts) {
                        return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                    }
                    function fmtDateTime(ts) { return fmtDate(ts) + ' ‚Äî ' + fmtTime(ts); }

                    // Dynamic gradient per status
                    let headerGrad = "from-blue-600 to-indigo-700";
                    if(statusBadge.includes("Disbursed"))    headerGrad = "from-emerald-600 to-green-700";
                    else if(statusBadge.includes("Sanctioned")) headerGrad = "from-teal-600 to-emerald-700";
                    else if(statusBadge.includes("Rejected"))   headerGrad = "from-red-600 to-rose-700";
                    else if(statusBadge.includes("Mortgage"))   headerGrad = "from-purple-600 to-violet-700";
                    else if(statusBadge.includes("Processing")) headerGrad = "from-indigo-500 to-blue-700";
                    else if(statusBadge.includes("Pending"))    headerGrad = "from-amber-500 to-orange-600";

                    const mobNo = group.mobile ? '<span class="flex items-center gap-1 bg-white/10 px-2.5 py-1 rounded-full border border-white/10 text-white/70">üì± ' + group.mobile + '</span>' : '';
                    const updCnt = group.updates.length;
                    const lastTime = fmtDateTime(latestUpdate.timestamp);

                    const headerHTML = `
                        <div class="bg-gradient-to-br ${headerGrad} p-5 relative overflow-hidden">
                            <div class="absolute -right-6 -top-6 w-28 h-28 bg-white/5 rounded-full pointer-events-none"></div>
                            <div class="absolute right-2 -bottom-5 w-16 h-16 bg-white/5 rounded-full pointer-events-none"></div>
                            <div class="flex items-start justify-between gap-2 mb-3 relative">
                                <div>
                                    <p class="text-white/50 text-[9px] font-black uppercase tracking-widest mb-1">üìÅ Client Case</p>
                                    <h3 class="font-black text-white text-xl leading-tight tracking-tight">${group.displayTitle}</h3>
                                </div>
                                <span class="text-[10px] font-black px-3 py-1.5 rounded-full shrink-0 bg-white/20 text-white border border-white/20">${statusBadge}</span>
                            </div>
                            <div class="flex flex-wrap gap-1.5 text-[10px] font-bold relative">
                                ${mobNo}
                                <span class="flex items-center gap-1 bg-white/10 px-2.5 py-1 rounded-full border border-white/10 text-white/70">üìã ${updCnt} Update${updCnt>1?'s':''}</span>
                                <span class="flex items-center gap-1 bg-white/10 px-2.5 py-1 rounded-full border border-white/10 text-white/70">üïê ${lastTime}</span>
                            </div>
                        </div>`;


                    const sortedUpdates = [...group.updates].reverse();
                    const updatesHTML = sortedUpdates.map((u, idx) => {
                        const isLatest = idx === 0;
                        return `
                        <div class="relative pl-9 pr-4 py-3 ${isLatest ? 'bg-blue-50/30' : ''} border-b border-slate-50 last:border-b-0">
                            <div class="absolute left-3.5 top-4 w-2.5 h-2.5 rounded-full border-2 border-white shadow-sm ${isLatest ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                            ${idx < sortedUpdates.length - 1 ? '<div class="absolute left-[17px] top-7 bottom-0 w-px bg-slate-100"></div>' : ''}
                            <div class="flex items-center gap-2 mb-1.5 flex-wrap">
                                <span class="text-[10px] font-black px-2 py-0.5 rounded-full ${isLatest ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">üìÖ ${fmtDate(u.timestamp)}</span>
                                <span class="text-[10px] font-bold text-slate-400">‚è∞ ${fmtTime(u.timestamp)}</span>
                                ${isLatest ? '<span class="text-[9px] font-black text-white bg-blue-500 px-2 py-0.5 rounded-full">LATEST</span>' : ''}
                            </div>
                            <p class="text-slate-700 text-sm leading-relaxed font-medium whitespace-pre-wrap devanagari">${u.content}</p>
                        </div>`;
                    }).join("");

                    card.innerHTML = headerHTML + `<div class="overflow-y-auto client-updates-scroll max-h-[350px]">${updatesHTML}</div>`;
                    ui.notesGrid.appendChild(card);
                }
            });

            // TASKS ‚Äî with search, filter, status toggle, priority, due date
            let taskCurrentFilter = 'all';
            let taskSearchQuery = '';

            function renderTasks() {
                const list = document.getElementById('tasks-list');
                const empty = document.getElementById('task-empty');
                const pendingCount = document.getElementById('task-pending-count');
                const doneCount = document.getElementById('task-done-count');
                list.innerHTML = '';

                let filtered = allTasks.filter(t => {
                    const matchFilter = taskCurrentFilter === 'all' || t.status === taskCurrentFilter ||
                        (taskCurrentFilter === 'Urgent' && t.priority === 'Urgent');
                    const matchSearch = !taskSearchQuery || (t.title||'').toLowerCase().includes(taskSearchQuery) ||
                        (t.client||'').toLowerCase().includes(taskSearchQuery);
                    return matchFilter && matchSearch;
                });

                const pending = allTasks.filter(t => t.status !== 'Done').length;
                const done    = allTasks.filter(t => t.status === 'Done').length;
                if(pendingCount) pendingCount.textContent = pending + ' Pending';
                if(doneCount) doneCount.textContent = done + ' Done';

                if(filtered.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                filtered.forEach((task, idx) => {
                    const isDone = task.status === 'Done';
                    const isUrgent = task.priority === 'Urgent';
                    const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !isDone;
                    const d = new Date(task.timestamp);
                    const dateStr = d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                    const timeStr = d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

                    let priorityBadge = '';
                    if(isUrgent) priorityBadge = '<span class="text-[10px] font-black text-red-600 bg-red-50 border border-red-200 px-2 py-0.5 rounded-full">üö® URGENT</span>';

                    let dueBadge = '';
                    if(task.dueDate) {
                        const due = new Date(task.dueDate).toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
                        dueBadge = `<span class="text-[10px] font-bold ${isOverdue ? 'text-red-600 bg-red-50' : 'text-slate-500 bg-slate-100'} px-2 py-0.5 rounded-full">üìÖ ${due}</span>`;
                    }

                    let statusBadge = '';
                    if(isDone)
                        statusBadge = '<span class="text-[10px] font-black text-green-700 bg-green-50 border border-green-200 px-2.5 py-1 rounded-full">‚úÖ Done</span>';
                    else if(isOverdue)
                        statusBadge = '<span class="text-[10px] font-black text-red-700 bg-red-50 border border-red-200 px-2.5 py-1 rounded-full animate-pulse">üî¥ Overdue</span>';
                    else
                        statusBadge = '<span class="text-[10px] font-black text-orange-700 bg-orange-50 border border-orange-200 px-2.5 py-1 rounded-full">‚è≥ Pending</span>';

                    const div = document.createElement('div');
                    div.className = `bg-white rounded-2xl border shadow-sm hover:shadow-md transition-all group ${isDone ? 'opacity-60 border-slate-100' : isOverdue ? 'border-red-200' : 'border-slate-100 hover:border-blue-200'}`;
                    div.innerHTML = `
                        <div class="p-4 flex items-start gap-4">
                            <!-- Checkbox -->
                            <button class="task-check-btn mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 ${isDone ? 'bg-green-500 border-green-500' : 'border-slate-300 hover:border-blue-400'} flex items-center justify-center transition-all" data-idx="${idx}">
                                ${isDone ? '<svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                            </button>
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-slate-800 text-base leading-snug devanagari ${isDone ? 'line-through text-slate-400' : ''}">${task.title}</p>
                                <div class="flex flex-wrap gap-2 mt-2 items-center">
                                    ${task.client ? `<span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">üë§ ${task.client}</span>` : ''}
                                    ${dueBadge}
                                    ${priorityBadge}
                                    <span class="text-[10px] text-slate-400 font-semibold ml-auto">üïê ${dateStr} ${timeStr}</span>
                                </div>
                            </div>
                            <!-- Status badge -->
                            <div class="flex-shrink-0">${statusBadge}</div>
                        </div>`;
                    list.appendChild(div);
                });

                // Checkbox toggle
                list.querySelectorAll('.task-check-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        const task = filtered[idx];
                        task.status = task.status === 'Done' ? 'Pending' : 'Done';
                        renderTasks();
                    });
                });
            }

            onSnapshot(query(collection(db, "tasks"), orderBy("timestamp", "desc")), (snapshot) => {
                allTasks = [];
                snapshot.forEach(d => allTasks.push(d.data()));
                renderTasks();
                // Update task sidebar badge with pending count
                const pending = allTasks.filter(t => (t.status||'').toLowerCase() !== 'done').length;
                const tb = document.getElementById('task-badge');
                if(tb) { if(pending>0){tb.textContent=pending>9?'9+':pending;tb.style.display='flex';}else tb.style.display='none'; }
                // Update notif panel task counter
                const tn = document.getElementById('np-task-num');
                if(tn) tn.textContent = pending;
            });

            // Task search
            document.getElementById('task-search')?.addEventListener('input', e => {
                taskSearchQuery = e.target.value.toLowerCase();
                renderTasks();
            });

            // Task filter buttons
            document.getElementById('task-filter-btns')?.addEventListener('click', e => {
                const btn = e.target.closest('[data-filter]');
                if(!btn) return;
                taskCurrentFilter = btn.dataset.filter;
                document.querySelectorAll('.task-filter-btn').forEach(b => {
                    b.className = b === btn
                        ? 'task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600'
                        : 'task-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50';
                });
                renderTasks();
            });

            // REMINDERS ‚Äî with search, filter, overdue detection, countdown
            let remCurrentFilter = 'all';
            let remSearchQuery = '';

            function parseRemDate(timeStr) {
                if(!timeStr || timeStr === 'Manual' || timeStr === '‡§ú‡§≤‡•ç‡§¶') return null;
                const d = new Date(timeStr);
                return isNaN(d) ? null : d;
            }

            function renderReminders() {
                const list = document.getElementById('reminders-list');
                const empty = document.getElementById('rem-empty');
                const upcomingEl = document.getElementById('rem-upcoming-count');
                const overdueEl = document.getElementById('rem-overdue-count');
                list.innerHTML = '';
                const now = new Date();

                let filtered = allReminders.filter(r => {
                    const d = parseRemDate(r.time);
                    const isOverdue = d && d < now;
                    const isToday = d && d.toDateString() === now.toDateString();
                    const matchFilter = remCurrentFilter === 'all' ||
                        (remCurrentFilter === 'today' && isToday) ||
                        (remCurrentFilter === 'overdue' && isOverdue) ||
                        (remCurrentFilter === 'upcoming' && d && d >= now);
                    const matchSearch = !remSearchQuery || (r.title||'').toLowerCase().includes(remSearchQuery) ||
                        (r.client||'').toLowerCase().includes(remSearchQuery);
                    return matchFilter && matchSearch;
                });

                const upcoming = allReminders.filter(r => { const d=parseRemDate(r.time); return d && d >= now; }).length;
                const overdue  = allReminders.filter(r => { const d=parseRemDate(r.time); return d && d < now; }).length;
                if(upcomingEl) upcomingEl.textContent = upcoming + ' Upcoming';
                if(overdueEl)  overdueEl.textContent  = overdue  + ' Overdue';

                if(filtered.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                filtered.forEach(rem => {
                    const remDate = parseRemDate(rem.time);
                    const isOverdue = remDate && remDate < now;
                    const isToday   = remDate && remDate.toDateString() === now.toDateString();
                    const isManual  = !remDate;

                    let cardColor, dotColor, timeLabel;
                    if(isOverdue)       { cardColor = 'from-red-50 to-red-100 border-red-200'; dotColor = 'bg-red-500'; timeLabel = 'üî¥ Overdue'; }
                    else if(isToday)    { cardColor = 'from-orange-50 to-amber-50 border-amber-200'; dotColor = 'bg-amber-500'; timeLabel = 'üü† Today'; }
                    else if(isManual)   { cardColor = 'from-slate-50 to-slate-100 border-slate-200'; dotColor = 'bg-slate-400'; timeLabel = 'üìå Manual'; }
                    else                { cardColor = 'from-blue-50 to-indigo-50 border-blue-200'; dotColor = 'bg-blue-500'; timeLabel = 'üü¢ Upcoming'; }

                    let formattedTime = rem.time;
                    if(remDate) {
                        formattedTime = remDate.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                        if(remDate.getHours() || remDate.getMinutes())
                            formattedTime += ' ‚Äî ' + remDate.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                    }

                    // Days countdown
                    let countdownBadge = '';
                    if(remDate && !isOverdue) {
                        const diff = Math.ceil((remDate - now) / (1000*60*60*24));
                        countdownBadge = diff === 0
                            ? '<span class="text-[10px] font-black text-amber-700 bg-amber-100 px-2 py-0.5 rounded-full animate-pulse">Today!</span>'
                            : `<span class="text-[10px] font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">in ${diff}d</span>`;
                    } else if(isOverdue) {
                        const diff = Math.ceil((now - remDate) / (1000*60*60*24));
                        countdownBadge = `<span class="text-[10px] font-black text-red-700 bg-red-100 px-2 py-0.5 rounded-full">${diff}d ago</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = `bg-gradient-to-br ${cardColor} border p-5 rounded-2xl shadow-sm flex flex-col gap-3 relative overflow-hidden hover:shadow-md transition-all`;
                    div.innerHTML = `
                        <div class="absolute -right-3 -top-3 text-5xl opacity-[0.07] select-none">‚è∞</div>
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${dotColor} ${isOverdue||isToday ? 'animate-pulse' : ''}"></span>
                                <span class="text-xs font-black text-slate-600 uppercase tracking-wide">${timeLabel}</span>
                            </div>
                            ${countdownBadge}
                        </div>
                        <p class="font-bold text-slate-800 text-base leading-snug devanagari">${rem.title}</p>
                        <div class="flex flex-wrap gap-2 items-center mt-1">
                            <span class="text-[11px] font-bold text-slate-500 bg-white/60 px-2 py-0.5 rounded-lg">üìÖ ${formattedTime}</span>
                            ${rem.client ? `<span class="text-[10px] font-bold text-blue-600 bg-white/60 px-2 py-0.5 rounded-lg">üë§ ${rem.client}</span>` : ''}
                        </div>`;
                    list.appendChild(div);
                });
            }

            onSnapshot(query(collection(db, "reminders"), orderBy("timestamp", "desc")), (snapshot) => {
                allReminders = [];
                snapshot.forEach(d => allReminders.push(d.data()));
                renderReminders();
                // Schedule browser push for all upcoming reminders on load
                allReminders.forEach(rem => { if(window.scheduleReminder) scheduleReminder(rem); });
                // Update reminder count in notif panel
                const upcomingCount = allReminders.filter(r => {
                    const d = new Date(r.time); return !isNaN(d) && d >= new Date();
                }).length;
                const rn = document.getElementById('np-rem-num');
                if(rn) rn.textContent = upcomingCount;
                // Update sidebar badge with upcoming count
                const rb = document.getElementById('rem-badge');
                if(rb) { if(upcomingCount>0){rb.textContent=upcomingCount>9?'9+':upcomingCount;rb.style.display='flex';}else rb.style.display='none'; }
            });

            // Reminders search
            document.getElementById('rem-search')?.addEventListener('input', e => {
                remSearchQuery = e.target.value.toLowerCase();
                renderReminders();
            });

            // Reminders filter buttons
            document.querySelectorAll('.rem-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    remCurrentFilter = btn.dataset.remfilter;
                    document.querySelectorAll('.rem-filter-btn').forEach(b => {
                        b.className = b === btn
                            ? 'rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border bg-blue-600 text-white border-blue-600'
                            : 'rem-filter-btn text-[11px] font-bold px-3 py-2 rounded-xl border border-slate-200 text-slate-600 bg-slate-50';
                    });
                    renderReminders();
                });
            });

            // NOTEBOOK ‚Äî grouped by client, search, sort, filter, grid/list toggle
            let nbSearchQuery = '';
            let nbSort = 'new';
            let nbFilterClient = 'all';
            let nbViewGrid = true;

            function renderNotebook() {
                const grid = document.getElementById('notebook-grid');
                const empty = document.getElementById('nb-empty');
                const countEl = document.getElementById('nb-count');
                grid.innerHTML = '';

                // Group by client
                let grouped = {};
                let allClientNames = new Set();
                allNotebooks.forEach(page => {
                    const key = (page.client || page.title || '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø').toUpperCase();
                    const name = page.client || page.title || '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø';
                    allClientNames.add(name);
                    if(!grouped[key]) grouped[key] = { displayName: name, updates: [] };
                    grouped[key].updates.push(page);
                });

                // Populate client filter dropdown
                const filterEl = document.getElementById('nb-filter');
                if(filterEl && filterEl.options.length <= 1) {
                    allClientNames.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name; opt.textContent = 'üë§ ' + name;
                        filterEl.appendChild(opt);
                    });
                }

                // Filter by client
                let entries = Object.values(grouped).filter(g => {
                    if(nbFilterClient !== 'all' && g.displayName !== nbFilterClient) return false;
                    if(!nbSearchQuery) return true;
                    return g.displayName.toLowerCase().includes(nbSearchQuery) ||
                        g.updates.some(u => (u.content||'').toLowerCase().includes(nbSearchQuery));
                });

                // Sort
                entries.sort((a, b) => {
                    const aLatest = Math.max(...a.updates.map(u => new Date(u.timestamp)));
                    const bLatest = Math.max(...b.updates.map(u => new Date(u.timestamp)));
                    if(nbSort === 'new') return bLatest - aLatest;
                    if(nbSort === 'old') return aLatest - bLatest;
                    if(nbSort === 'az')  return a.displayName.localeCompare(b.displayName);
                    return 0;
                });

                if(countEl) countEl.textContent = allNotebooks.length + ' notes';
                grid.className = nbViewGrid
                    ? 'grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 items-start'
                    : 'flex flex-col gap-4 pb-20';

                if(entries.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                entries.forEach(group => {
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-[1.5rem] shadow-sm hover:shadow-xl border border-l-[8px] border-yellow-400 border-slate-200 relative transition-all duration-300 overflow-hidden group";

                    const sortedUpdates = [...group.updates].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latest = sortedUpdates[0];

                    function fmtDate(ts) { return new Date(ts).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }
                    function fmtTime(ts) { return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}); }

                    const headerHTML = `
                        <div class="bg-slate-900 text-white px-6 py-4 flex items-center justify-between">
                            <div>
                                <div class="text-[10px] text-yellow-400 font-black uppercase tracking-widest mb-0.5">üìã ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§®‡•ã‡§ü</div>
                                <h3 class="font-black text-xl tracking-tight">${group.displayName}</h3>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-slate-400 mb-0.5">‡§ï‡•Å‡§≤ ‡§Ö‡§™‡§°‡•á‡§ü</div>
                                <div class="text-yellow-400 text-2xl font-black">${group.updates.length}</div>
                            </div>
                        </div>`;

                    const updatesHTML = sortedUpdates.map((page, idx) => {
                        let displayContent = page.content || '';
                        if(nbSearchQuery) {
                            const regex = new RegExp('(' + nbSearchQuery + ')', 'gi');
                            displayContent = displayContent.replace(regex, '<mark class="bg-yellow-200 rounded px-0.5">$1</mark>');
                        }
                        const isLatest = idx === 0;
                        const dDate = new Date(page.timestamp).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                        const dTime = new Date(page.timestamp).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                        const updateNum = group.updates.length - idx;
                        const badgeClass = isLatest ? 'bg-yellow-400 text-slate-900 font-black' : 'bg-slate-100 text-slate-400';
                        return '<div class="px-6 py-4 border-b border-slate-50 last:border-b-0 ' + (isLatest ? 'bg-yellow-50/30' : '') + '">' +
                            '<div class="flex items-center gap-2 mb-2 flex-wrap">' +
                            '<span class="text-[10px] font-black px-2 py-0.5 rounded-full ' + (isLatest ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-500') + '">üìÖ ' + dDate + '</span>' +
                            '<span class="text-[10px] font-bold text-slate-400">‚è∞ ' + dTime + '</span>' +
                            '<span class="text-[9px] font-bold px-2 py-0.5 rounded-full ml-auto ' + badgeClass + '">#' + updateNum + '</span>' +
                            '</div>' +
                            '<div class="text-slate-700 text-sm leading-relaxed devanagari font-medium whitespace-pre-wrap">' + displayContent + '</div>' +
                            '</div>';
                    }).join('');

                    card.innerHTML = headerHTML + `<div class="divide-y divide-slate-50 max-h-[300px] overflow-y-auto client-updates-scroll">${updatesHTML}</div>`;
                    grid.appendChild(card);
                });
            }

            onSnapshot(query(collection(db, "notebooks"), orderBy("timestamp", "desc")), (snapshot) => {
                allNotebooks = [];
                snapshot.forEach(d => allNotebooks.push(d.data()));
                renderNotebook();
            });

            // Notebook search
            document.getElementById('nb-search')?.addEventListener('input', e => {
                nbSearchQuery = e.target.value.toLowerCase();
                renderNotebook();
            });

            // Notebook sort
            document.getElementById('nb-sort')?.addEventListener('change', e => {
                nbSort = e.target.value;
                renderNotebook();
            });

            // Notebook filter
            document.getElementById('nb-filter')?.addEventListener('change', e => {
                nbFilterClient = e.target.value;
                renderNotebook();
            });

            // Notebook grid/list toggle
            document.getElementById('nb-view-toggle')?.addEventListener('click', () => {
                nbViewGrid = !nbViewGrid;
                document.getElementById('nb-view-toggle').textContent = nbViewGrid ? '‚äû Grid' : '‚ò∞ List';
                renderNotebook();
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            if(role === 'user') {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-md rounded-tr-sm";
            } else {
                bubble.className = "p-4 md:p-5 rounded-2xl max-w-[85%] text-sm md:text-base leading-relaxed bg-white border border-slate-200 text-slate-700 shadow-sm rounded-tl-sm";
            }
            bubble.textContent = content;
            div.appendChild(bubble);
            ui.chatBox.appendChild(div);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';

            recognition.onstart = () => { isRecording = true; ui.micBtn.classList.add('recording'); ui.userInput.placeholder = "Listening..."; };
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) ui.userInput.value += event.results[i][0].transcript + ' ';
                    else interimTranscript += event.results[i][0].transcript;
                }
            };
            recognition.onend = () => { isRecording = false; ui.micBtn.classList.remove('recording'); ui.userInput.placeholder = "Type a command or tap mic..."; };
            ui.micBtn.addEventListener('click', () => { if (isRecording) recognition.stop(); else recognition.start(); });
        } else { ui.micBtn.style.display = 'none'; }

        let isProcessing = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  REAL AI ENGINE ‚Äî OpenAI GPT-4o powered sendMessage
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function sendMessage() {
            if (isProcessing) return;
            const text = ui.userInput.value.trim();
            if (!text) return;

            isProcessing = true;
            ui.userInput.disabled = true;
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');
            ui.userInput.value = "";

            chatHistory.push({ role: 'user', content: text });

            await addDoc(collection(db, "chats"), {
                role: "user", content: text, timestamp: new Date().toISOString()
            });

            // Loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex justify-start w-full";
            loadingDiv.innerHTML = `<div class="p-4 rounded-2xl bg-white border border-slate-200 text-blue-500 text-sm font-bold animate-pulse shadow-sm flex items-center gap-2"><span class="text-xl">ü§ñ</span> AI ‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•à...</div>`;
            ui.chatBox.appendChild(loadingDiv);
            ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            try {
                // ‚îÄ‚îÄ 1. FETCH ALL SAVED DATA FROM FIREBASE FOR CONTEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const [notebooksSnap, notesSnap, tasksSnap, remindersSnap] = await Promise.all([
                    getDocs(collection(db, "notebooks")),
                    getDocs(collection(db, "notes")),
                    getDocs(collection(db, "tasks")),
                    getDocs(collection(db, "reminders"))
                ]);

                const notebookData = notebooksSnap.docs.map(d => d.data());
                const casesData    = notesSnap.docs.map(d => d.data());
                const tasksData    = tasksSnap.docs.map(d => d.data());
                const remindersData= remindersSnap.docs.map(d => d.data());

                // Summarise saved data for AI context
                function summarize(arr, fields) {
                    return arr.slice(-30).map(item =>
                        fields.map(f => `${f}: ${item[f] || ''}`).join(' | ')
                    ).join('\n');
                }

                const savedContext = `
=== SAVED NOTEBOOKS (last 30) ===
${summarize(notebookData, ['client','content','timestamp'])}

=== CLIENT CASES (last 30) ===
${summarize(casesData, ['client','content','timestamp'])}

=== TASKS (last 30) ===
${summarize(tasksData, ['title','status','client','timestamp'])}

=== REMINDERS (last 30) ===
${summarize(remindersData, ['title','time','client','timestamp'])}
                `.trim();

                // ‚îÄ‚îÄ 2. SYSTEM PROMPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const today = new Date().toLocaleDateString('en-IN', {
                    day: '2-digit', month: 'long', year: 'numeric'
                });

                const systemPrompt = `
Aap "Smart Steno Pro" ke AI Assistant hain ‚Äî ek intelligent banking case manager jo Nilesh ji ke liye kaam karta hai.
Aaj ki tarikh: ${today}

AAPKE PAAS YEH SAVED DATA HAI (Firebase se fetch kiya):
${savedContext}

AAPKA KAAM:
1. Agar user koi CLIENT INFORMATION deta hai (koi bhi banking case ‚Äî loan, mortgage, sanction, visit, CMA, processing, etc.):
   - Ek professional, official Devanagari Hindi mein notebook draft banao
   - Har point naye line mein, appropriate emoji ke saath
   - Sahi tense use karo: "ho gaya" = ‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£, "ho raha hai" = üîÑ ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§Æ‡•á‡§Ç, "karna hai" = ‚è≥ ‡§≤‡§Ç‡§¨‡§ø‡§§
   - Client ka naam detect karo
   - JSON format mein respond karo (niche format diya hai)

2. Agar user KUCH PUCHH raha hai (jaise "Paawan Bio Energy ka status kya hai?", "kaunse cases pending hain?", "aaj ke tasks batao"):
   - Saved data mein se dhundh ke jawab do
   - Hindi mein, clearly, bullet points mein
   - JSON format mein respond karo

3. Agar user REMINDER ya TASK manually maangta hai:
   - Create karo

RESPONSE FORMAT (HAMESHA valid JSON do, kuch bhi extra mat likho):
{
  "reply": "...(user ko dikhane wala message Hindi mein)...",
  "notebook": {
    "save": true/false,
    "client": "Client Name",
    "content": "...Official Devanagari Hindi draft, line by line points..."
  },
  "case": {
    "save": true/false,
    "client": "Client Name",
    "mobile": "10-digit mobile number agar diya ho, warna null",
    "content": "...case summary Hindi mein..."
  },
  "task": {
    "save": true/false,
    "client": "Client Name",
    "title": "...task title Hindi mein..."
  },
  "reminder": {
    "save": true/false,
    "client": "Client Name",
    "title": "...reminder title...",
    "time": "...time/date..."
  }
}

RULES:
- notebook.save = true: HAMESHA jab user koi client info/update deta hai
- case.save = true: Jab nayi case kholni ho ya major update ho
- task.save = true: Jab koi kaam karna baaki ho (pending action)
- reminder.save = true: Jab koi date/follow-up mention ho
- Sirf JSON do ‚Äî koi explanation, code block, backtick nahi
- Hindi mein likho, professional banking language use karo
                `.trim();

                // ‚îÄ‚îÄ 3. CALL OPENAI GPT-4o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const messages = [
                    { role: "system", content: systemPrompt },
                    ...chatHistory.slice(-10) // last 10 messages for context
                ];

                const openaiRes = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${DYNAMIC_OPENAI_KEY}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: messages,
                        temperature: 0.3,
                        max_tokens: 1200
                    })
                });

                if (!openaiRes.ok) {
                    const errData = await openaiRes.json();
                    throw new Error(errData.error?.message || "OpenAI API Error");
                }

                const openaiData = await openaiRes.json();
                const rawContent = openaiData.choices[0].message.content.trim();

                // ‚îÄ‚îÄ 4. PARSE AI RESPONSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                let aiResponse;
                try {
                    // Strip code fences if any
                    const clean = rawContent.replace(/```json|```/g, '').trim();
                    aiResponse = JSON.parse(clean);
                } catch(e) {
                    // If AI returned plain text (not JSON), show it directly
                    aiResponse = { reply: rawContent, notebook: { save: false }, case: { save: false }, task: { save: false }, reminder: { save: false } };
                }

                const replyText = aiResponse.reply || "‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡§Æ‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•Å‡§Ü‡•§";
                chatHistory.push({ role: 'assistant', content: replyText });

                // ‚îÄ‚îÄ 5. SAVE TO FIREBASE BASED ON AI DECISION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const now = new Date().toISOString();
                const savePromises = [];

                if (aiResponse.notebook?.save && aiResponse.notebook?.content) {
                    savePromises.push(addDoc(collection(db, "notebooks"), {
                        title: aiResponse.notebook.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        content: aiResponse.notebook.content,
                        client: aiResponse.notebook.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('üìì', 'Notebook updated: ' + (aiResponse.notebook.client || 'General'), '#4f46e5');
                    addNotif('notebook', 'üìì Notebook saved ‚Äî ' + (aiResponse.notebook.client || 'General'), 'AI ne automatically save kiya');
                    if(window.registerUpdate) registerUpdate('notebook', aiResponse.notebook.client || '');
                }

                if (aiResponse.case?.save && aiResponse.case?.content) {
                    savePromises.push(addDoc(collection(db, "notes"), {
                        title: aiResponse.case.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        content: aiResponse.case.content,
                        client: aiResponse.case.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        mobile: aiResponse.case.mobile || null,
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('üìÇ', 'Client case saved: ' + (aiResponse.case.client || 'General'), '#0891b2');
                    addNotif('case', 'üìÇ Client Case updated ‚Äî ' + (aiResponse.case.client || 'General'), aiResponse.case.mobile ? 'üì± ' + aiResponse.case.mobile : 'Case record saved');
                    if(window.registerUpdate) registerUpdate('case', aiResponse.case.client || '');
                }

                if (aiResponse.task?.save && aiResponse.task?.title) {
                    savePromises.push(addDoc(collection(db, "tasks"), {
                        title: aiResponse.task.title,
                        status: "Pending",
                        client: aiResponse.task.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø",
                        timestamp: now
                    }));
                    if(window.addActivity) addActivity('‚úÖ', 'Task created: ' + aiResponse.task.title.substring(0,30), '#d97706');
                    addNotif('task', '‚úÖ New Task ‚Äî ' + aiResponse.task.title.substring(0,45), 'Client: ' + (aiResponse.task.client || 'General'));
                    if(window.registerUpdate) registerUpdate('task', aiResponse.task.client || '');
                }

                if (aiResponse.reminder?.save && aiResponse.reminder?.title) {
                    const remObj = { title: aiResponse.reminder.title, time: aiResponse.reminder.time || "‡§ú‡§≤‡•ç‡§¶", client: aiResponse.reminder.client || "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø", timestamp: now };
                    savePromises.push(addDoc(collection(db, "reminders"), remObj));
                    if(window.addActivity) addActivity('‚è∞', 'Reminder set: ' + aiResponse.reminder.title.substring(0,30), '#dc2626');
                    addNotif('reminder', '‚è∞ Reminder set ‚Äî ' + aiResponse.reminder.title.substring(0,40), 'üìÖ ' + (aiResponse.reminder.time || '‡§ú‡§≤‡•ç‡§¶'));
                    scheduleReminder(remObj);
                    if(window.registerUpdate) registerUpdate('reminder', aiResponse.reminder.client || '');
                }

                // Save AI reply to chat
                savePromises.push(addDoc(collection(db, "chats"), {
                    role: "assistant", content: replyText, timestamp: now
                }));

                await Promise.all(savePromises);

                // ‚îÄ‚îÄ 6. RENDER AI REPLY ‚Äî onSnapshot se automatically render hoga
                loadingDiv.remove();
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            } catch (err) {
                loadingDiv.remove();
                const errMsg = `‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${err.message}`;
                await addDoc(collection(db, "chats"), {
                    role: "assistant", content: errMsg, timestamp: new Date().toISOString()
                });
            } finally {
                isProcessing = false;
                ui.userInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
                ui.userInput.focus();
            }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });


        
        // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        // ‚ïë        RIGHT SIDE LIVE UPDATE PANEL ‚Äî COMPLETE ENGINE       ‚ïë
        // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

        const UP = {
            open: false,
            currentPage: 'notebook',
            // Per-page unread counts (only count when user NOT on that page)
            counts: { notebook: 0, notes: 0, tasks: 0, reminders: 0 },
            // Last client name per page
            clients: { notebook: '', notes: '', tasks: '', reminders: '' },
            // Last save time
            lastTime: null,
            autoCloseTimer: null
        };

        // ‚îÄ‚îÄ Mapping: AI type ‚Üí page key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const PAGE_MAP = {
            notebook: 'notebook',
            case:     'notes',
            task:     'tasks',
            reminder: 'reminders'
        };

        // ‚îÄ‚îÄ Page metadata ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const PAGE_META = {
            notebook:  { label: 'Notebook',      badgeColor: '#6366f1', sub: (n,c) => n + ' note' + (n>1?'s':'') + (c ? ' ¬∑ ' + c : '') },
            notes:     { label: 'Client Cases',  badgeColor: '#0891b2', sub: (n,c) => n + ' case update' + (n>1?'s':'') + (c ? ' ¬∑ ' + c : '') },
            tasks:     { label: 'Tasks',         badgeColor: '#f59e0b', sub: (n,c) => n + ' task' + (n>1?'s':'') + ' added' + (c ? ' ¬∑ ' + c : '') },
            reminders: { label: 'Reminders',     badgeColor: '#ef4444', sub: (n,c) => n + ' reminder' + (n>1?'s':'') + ' set' + (c ? ' ¬∑ ' + c : '') }
        };

        // ‚îÄ‚îÄ Toggle panel open/close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.toggleUpdPanel = function() {
            UP.open = !UP.open;
            const body    = document.getElementById('upd-panel-body');
            const chevron = document.getElementById('upd-tab-chevron');
            if(UP.open) {
                body.classList.add('open');
                if(chevron) chevron.style.transform = 'rotate(180deg)';
                // Cancel any auto-close
                clearTimeout(UP.autoCloseTimer);
            } else {
                body.classList.remove('open');
                if(chevron) chevron.style.transform = '';
            }
        };

        // ‚îÄ‚îÄ Auto-open for 5s then auto-close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function autoOpenPanel() {
            if(!UP.open) {
                UP.open = true;
                const body    = document.getElementById('upd-panel-body');
                const chevron = document.getElementById('upd-tab-chevron');
                if(body) body.classList.add('open');
                if(chevron) chevron.style.transform = 'rotate(180deg)';
            }
            clearTimeout(UP.autoCloseTimer);
            UP.autoCloseTimer = setTimeout(() => {
                // Only close if no interaction
                UP.open = false;
                const body    = document.getElementById('upd-panel-body');
                const chevron = document.getElementById('upd-tab-chevron');
                if(body) body.classList.remove('open');
                if(chevron) chevron.style.transform = '';
            }, 5000);
        }

        // ‚îÄ‚îÄ Navigate to page + clear that page's badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.goToPage = function(page) {
            // Flash the row
            const row = document.getElementById('upd-row-' + page);
            if(row) { row.classList.add('visited'); setTimeout(() => row.classList.remove('visited'), 500); }
            // Clear count for this page
            UP.counts[page] = 0;
            UP.currentPage = page;
            refreshUpdPanel();
            // Navigate ‚Äî use any available version
            const navFn = window.__finalSwitchView || window._baseSwitchViewUP || window.switchView;
            if(navFn) navFn(page);
            // Close panel on mobile
            if(window.innerWidth < 768) {
                UP.open = false;
                const body = document.getElementById('upd-panel-body');
                if(body) body.classList.remove('open');
            }
        };

        // ‚îÄ‚îÄ Clear all badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.clearAllUpdates = function() {
            Object.keys(UP.counts).forEach(k => UP.counts[k] = 0);
            refreshUpdPanel();
        };

        // ‚îÄ‚îÄ Register a new update from AI save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.registerUpdate = function(type, clientName) {
            const page = PAGE_MAP[type] || type;
            // Only add count if user is NOT currently viewing this page
            if(UP.currentPage !== page) {
                UP.counts[page] = (UP.counts[page] || 0) + 1;
            }
            if(clientName) UP.clients[page] = clientName;
            UP.lastTime = new Date();
            refreshUpdPanel();
            // Update pin screen mini panel
            if(typeof updatePinMiniPanel === 'function') updatePinMiniPanel();
            // Auto-open to show the update
            autoOpenPanel();
        };

        // ‚îÄ‚îÄ Refresh all UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function refreshUpdPanel() {
            const pages = Object.keys(UP.counts);
            let total = 0;
            let anyVisible = false;

            pages.forEach(page => {
                const count  = UP.counts[page] || 0;
                const meta   = PAGE_META[page];
                const client = UP.clients[page] || '';
                const row    = document.getElementById('upd-row-'   + page);
                const badge  = document.getElementById('upd-badge-' + page);
                const sub    = document.getElementById('upd-sub-'   + page);

                total += count;

                if(!row) return;

                if(count > 0 || UP.clients[page]) {
                    // Show row
                    row.style.display = 'flex';
                    anyVisible = true;
                    // Badge
                    if(badge) {
                        badge.textContent = count > 99 ? '99+' : count;
                        if(count > 0) {
                            badge.style.display = 'flex';
                            // Shake animation for increment
                            badge.classList.remove('shake');
                            void badge.offsetWidth; // reflow
                            badge.classList.add('shake');
                            setTimeout(() => badge.classList.remove('shake'), 400);
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                    // Sub-label
                    if(sub && meta) {
                        sub.textContent = count > 0
                            ? meta.sub(count, client)
                            : (client ? 'Last: ' + client : '');
                    }
                } else {
                    row.style.display = 'none';
                }
            });

            // Empty state
            const emptyEl = document.getElementById('upd-empty-state');
            if(emptyEl) emptyEl.style.display = anyVisible ? 'none' : 'block';

            // Total tab badge
            const tabCount = document.getElementById('upd-tab-count');
            if(tabCount) {
                if(total > 0) {
                    tabCount.textContent = total > 99 ? '99+' : total;
                    tabCount.style.display = 'flex';
                } else {
                    tabCount.style.display = 'none';
                }
            }

            // Footer timestamp
            const footer = document.getElementById('upd-footer');
            const timeEl = document.getElementById('upd-last-time');
            if(footer && UP.lastTime) {
                footer.style.display = 'block';
                if(timeEl) timeEl.textContent = UP.lastTime.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            } else if(footer && !anyVisible) {
                footer.style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ Track page visits via switchView hook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Store the original switchView BEFORE the notification engine possibly wraps it
        const _baseSwitchViewUP = switchView;

        // Wrap switchView to track current page + clear badge on visit
        const _switchViewAfterNotif = window.switchView;
        window.switchView = function(targetView) {
            // Call whichever is the latest version
            (_switchViewAfterNotif || _baseSwitchViewUP)(targetView);
            UP.currentPage = targetView;
            // Clear the count for this page
            if(UP.counts[targetView] !== undefined) {
                UP.counts[targetView] = 0;
                refreshUpdPanel();
            }
        };

        // Hook manual nav clicks ‚Äî clear badge when page visited
        ['notebook','notes','tasks','reminders'].forEach(v => {
            ['desk','mob'].forEach(suffix => {
                const btn = document.getElementById('tab-' + v + '-' + suffix);
                if(btn) btn.addEventListener('click', () => {
                    UP.currentPage = v;
                    UP.counts[v] = 0;
                    // Also clear corresponding NS badge (task/reminder sidebar badges)
                    refreshUpdPanel();
                });
            });
        });

        // Also reset UP counts when switchView called (catches all navigation including goToPage)
        const __finalSwitchView = window.switchView;
        window.switchView = function(targetView) {
            __finalSwitchView(targetView);
            UP.currentPage = targetView;
            if(UP.counts[targetView] !== undefined) {
                UP.counts[targetView] = 0;
                refreshUpdPanel();
            }
            // Also clear NS badges for this page
            if(typeof markPageVisited === 'function') markPageVisited(targetView);
        };

        // ‚îÄ‚îÄ Initial render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        refreshUpdPanel();

        // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        // ‚ïë          CASEDESK AI ‚Äî NOTIFICATION ENGINE                  ‚ïë
        // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

        const NS = {
            items: [],          // { id, type, title, sub, time, read, ts }
            unread: 0,
            filter: 'all',
            pushOK: false,
            scheduledKeys: new Set(),   // reminder keys already scheduled
            savedToday: 0
        };

        // ‚îÄ‚îÄ‚îÄ Panel open / close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openNotifPanel() {
            document.getElementById('notif-panel').classList.add('open');
            document.getElementById('notif-overlay').classList.add('open');
            NS.unread = 0;
            refreshBadges();
            renderNotifList();
        }
        function closeNotifPanel() {
            document.getElementById('notif-panel').classList.remove('open');
            document.getElementById('notif-overlay').classList.remove('open');
        }
        function markAllRead() {
            NS.items.forEach(i => i.read = true);
            NS.unread = 0;
            refreshBadges();
            renderNotifList();
        }

        document.getElementById('notif-bell-btn').addEventListener('click', openNotifPanel);
        document.getElementById('notif-bell-mob')?.addEventListener('click', openNotifPanel);

        // ‚îÄ‚îÄ‚îÄ Filter tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.querySelectorAll('.nf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                NS.filter = btn.dataset.nf;
                document.querySelectorAll('.nf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderNotifList();
            });
        });

        // Track which pages have been visited to clear their NS badge on visit
        const visitedPages = new Set();

        // ‚îÄ‚îÄ‚îÄ Refresh all badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function refreshBadges() {
            const total = NS.unread;

            // Bell badge (sidebar + mobile)
            ['bell-badge','bell-badge-mob'].forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                if(total > 0) { el.textContent = total > 9 ? '9+' : total; el.style.display = 'flex'; }
                else el.style.display = 'none';
            });
            // Bell dot SVG
            const dot = document.getElementById('bell-dot');
            if(dot) dot.style.display = total > 0 ? '' : 'none';

            // Task badge ‚Äî only show UNREAD task notifs (clears when tasks page visited)
            const tb = document.getElementById('task-badge');
            if(tb) {
                const unreadTasks = visitedPages.has('tasks') ? 0 : NS.items.filter(i=>i.type==='task'&&!i.read).length;
                if(unreadTasks > 0) { tb.textContent = unreadTasks>9?'9+':unreadTasks; tb.style.display='flex'; }
                else tb.style.display='none';
            }
            // Reminder badge ‚Äî only show UNREAD reminder notifs
            const rb = document.getElementById('rem-badge');
            if(rb) {
                const unreadRems = visitedPages.has('reminders') ? 0 : NS.items.filter(i=>i.type==='reminder'&&!i.read).length;
                if(unreadRems > 0) { rb.textContent = unreadRems>9?'9+':unreadRems; rb.style.display='flex'; }
                else rb.style.display='none';
            }
            // Panel header unread badge
            const ub = document.getElementById('np-unread-badge');
            if(ub) { if(total>0){ub.textContent=total;ub.style.display='';} else ub.style.display='none'; }
        }

        // Clear visited-page badges when user visits that page
        function markPageVisited(page) {
            visitedPages.add(page);
            // Mark all notifications of this type as read
            const typeMap = { tasks:'task', reminders:'reminder', notebook:'notebook', notes:'case' };
            const nsType = typeMap[page];
            if(nsType) {
                NS.items.filter(i=>i.type===nsType).forEach(i=>{ i.read=true; });
                NS.unread = NS.items.filter(i=>!i.read).length;
            }
            refreshBadges();
        }

        // ‚îÄ‚îÄ‚îÄ Refresh summary counters in panel header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function refreshCounters() {
            const now = new Date();
            // Count pending tasks in NS
            const taskCount = NS.items.filter(i=>i.type==='task').length;
            // Count upcoming reminders from NS
            const remCount  = NS.items.filter(i=>i.type==='reminder').length;

            const tn = document.getElementById('np-task-num');
            const rn = document.getElementById('np-rem-num');
            const sn = document.getElementById('np-saved-num');
            if(tn) tn.textContent = taskCount;
            if(rn) rn.textContent = remCount;
            if(sn) sn.textContent = NS.savedToday;
        }

        // ‚îÄ‚îÄ‚îÄ Render notification list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderNotifList() {
            const list  = document.getElementById('notif-list');
            const empty = document.getElementById('notif-empty');
            refreshCounters();

            const show = NS.filter === 'all'
                ? NS.items
                : NS.items.filter(i => i.type === NS.filter);

            if(show.length === 0) {
                list.innerHTML = '';
                list.appendChild(empty);
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            list.innerHTML = '';

            const cfg = {
                task:     { bg:'#fbbf24', label:'‚úÖ Task' },
                reminder: { bg:'#ef4444', label:'‚è∞ Reminder' },
                notebook: { bg:'#6366f1', label:'üìì Notebook' },
                case:     { bg:'#0891b2', label:'üìÇ Case' },
            };

            [...show].reverse().forEach(item => {
                const c = cfg[item.type] || cfg.notebook;
                const d = document.createElement('div');
                d.className = 'nitem ' + (item.read ? 'read' : 'unread');
                d.innerHTML =
                    '<div class="nicon" style="background:' + c.bg + '20;color:' + c.bg + ';font-size:16px;">' +
                        (item.type==='task'?'‚úÖ':item.type==='reminder'?'‚è∞':item.type==='notebook'?'üìì':'üìÇ') +
                    '</div>' +
                    '<div style="flex:1;min-width:0;">' +
                        '<div class="ntitle">' + item.title + '</div>' +
                        (item.sub ? '<div class="nsub">' + item.sub + '</div>' : '') +
                        '<div class="ntime">' + item.time + '</div>' +
                    '</div>' +
                    (!item.read ? '<div class="ndot"></div>' : '');
                d.onclick = () => { item.read = true; NS.unread = Math.max(0, NS.unread-1); refreshBadges(); renderNotifList(); };
                list.appendChild(d);
            });
        }

        // ‚îÄ‚îÄ‚îÄ Add notification (called everywhere) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addNotif = function(type, title, sub) {
            const now = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            NS.items.push({ id: Date.now(), type, title, sub: sub||'', time: now, read: false });
            if(type==='notebook'||type==='case') NS.savedToday++;
            NS.unread++;
            refreshBadges();
            refreshCounters();
            renderNotifList();
            // In-app toast
            showToast(type, title, sub);
            // Browser push (if tab in background)
            if(NS.pushOK && document.hidden) browserPush(type, title, sub);
        };

        // ‚îÄ‚îÄ‚îÄ In-app toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showToast(type, title, sub) {
            const wrap = document.getElementById('toast-wrap');
            const t = document.createElement('div');
            t.className = 'toast t-' + type;
            const icons = {task:'‚úÖ',reminder:'‚è∞',notebook:'üìì',case:'üìÇ'};
            const colors = {task:'#f59e0b',reminder:'#ef4444',notebook:'#6366f1',case:'#0891b2'};
            t.innerHTML =
                '<div style="width:28px;height:28px;border-radius:8px;background:' + (colors[type]||'#6366f1') + ';display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">' + (icons[type]||'üîî') + '</div>' +
                '<div style="flex:1;min-width:0;">' +
                    '<div style="font-size:12px;font-weight:700;color:#fff;line-height:1.3;">' + title + '</div>' +
                    (sub ? '<div style="font-size:10px;color:rgba(255,255,255,.6);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + sub + '</div>' : '') +
                '</div>' +
                '<button onclick="this.closest(\'.toast\').remove()" style="background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;font-size:13px;padding:0;flex-shrink:0;">‚úï</button>';
            wrap.appendChild(t);
            setTimeout(() => {
                t.style.animation = 'toastOut .3s ease forwards';
                setTimeout(() => t.remove(), 300);
            }, 5000);
        }

        // ‚îÄ‚îÄ‚îÄ Browser push notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function browserPush(type, title, body) {
            try {
                const labels = {task:'Task',reminder:'Reminder',notebook:'Notebook',case:'Case'};
                new Notification('CaseDesk AI ‚Äî ' + (labels[type]||'Update'), {
                    body: title + (body ? '\n' + body : ''),
                    icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect width='40' height='40' rx='11' fill='%236366f1'/><rect x='10' y='8' width='20' height='26' rx='4' fill='white' fill-opacity='0.25' stroke='white' stroke-width='1.5'/><path d='M14 16h12M14 21h12M14 26h8' stroke='white' stroke-width='2' stroke-linecap='round'/></svg>",
                    tag: 'casedesk-' + type,
                    requireInteraction: type === 'reminder'
                });
            } catch(e) {}
        }

        // ‚îÄ‚îÄ‚îÄ Enable push permission ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function enablePush() {
            if(!('Notification' in window)) {
                document.getElementById('push-bar-text').textContent = 'Ye browser notifications support nahi karta.';
                document.getElementById('enable-push-btn').style.display = 'none';
                return;
            }
            const p = await Notification.requestPermission();
            const bar = document.getElementById('push-bar');
            if(p === 'granted') {
                NS.pushOK = true;
                bar.style.background = '#f0fdf4'; bar.style.borderColor = '#bbf7d0';
                bar.innerHTML = '<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="#16a34a" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg><span style="flex:1;font-size:11px;font-weight:700;color:#15803d;">‚ú® PC/Mobile notifications enabled! Ab app band ho tab bhi alert milega.</span>';
                // Test notification
                setTimeout(() => browserPush('notebook', 'CaseDesk AI connected!', 'Ab har task/reminder ka alert milega.'), 500);
            } else {
                document.getElementById('push-bar-text').textContent = 'Permission denied. Browser settings se allow karein.';
                document.getElementById('push-bar-text').style.color = '#ef4444';
                document.getElementById('enable-push-btn').style.display = 'none';
            }
        }
        document.getElementById('enable-push-btn').addEventListener('click', enablePush);

        // Auto-check permission on load
        if('Notification' in window) {
            if(Notification.permission === 'granted') {
                NS.pushOK = true;
                document.getElementById('push-bar').style.display = 'none';
            } else if(Notification.permission === 'denied') {
                document.getElementById('push-bar-text').textContent = 'Notifications blocked. Browser settings > Allow karein.';
                document.getElementById('push-bar-text').style.color = '#ef4444';
                document.getElementById('enable-push-btn').style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ‚îÄ REMINDER SCHEDULER ‚Äî fires browser push at exact set time ‚îÄ‚îÄ‚îÄ
        window.scheduleReminder = function(rem) {
            if(!rem.time || rem.time === 'Manual' || rem.time === '‡§ú‡§≤‡•ç‡§¶') return;
            const fireAt = new Date(rem.time);
            if(isNaN(fireAt)) return;
            const key = rem.title + '|' + rem.time;
            if(NS.scheduledKeys.has(key)) return;
            NS.scheduledKeys.add(key);

            const msLeft = fireAt - Date.now();
            if(msLeft > 0 && msLeft < 7 * 24 * 3600 * 1000) {
                // In-app notification at exact time
                setTimeout(() => {
                    addNotif('reminder', '‚è∞ ' + rem.title, rem.client ? 'Client: ' + rem.client : 'Reminder time!');
                    // Force browser push even if tab open
                    if(NS.pushOK) browserPush('reminder', rem.title, rem.client || 'Reminder!');
                }, msLeft);
                console.log('[CaseDesk] Reminder scheduled:', rem.title, 'in', Math.round(msLeft/60000), 'min');
            } else if(msLeft <= 0 && msLeft > -3600000) {
                // Just missed (within last hour) ‚Äî show overdue once
                addNotif('reminder', 'üî¥ Overdue: ' + rem.title, rem.client || '');
            }
        };


    </script>

    <!-- ‚ïê‚ïê‚ïê TOAST CONTAINER ‚ïê‚ïê‚ïê -->
    <div id="toast-wrap"></div>

    <!-- ‚ïê‚ïê‚ïê NOTIF OVERLAY ‚ïê‚ïê‚ïê -->
    <div id="notif-overlay" onclick="closeNotifPanel()"></div>

    <!-- ‚ïê‚ïê‚ïê NOTIFICATION SIDE PANEL ‚ïê‚ïê‚ïê -->
    <div id="notif-panel">

        <!-- Header -->
        <div style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);padding:16px;flex-shrink:0;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="width:30px;height:30px;background:rgba(255,255,255,.15);border-radius:9px;display:flex;align-items:center;justify-content:center;">
                        <svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    </div>
                    <span style="font-weight:800;font-size:15px;color:#fff;">Notifications</span>
                    <span id="np-unread-badge" style="display:none;background:#ef4444;color:#fff;font-size:10px;font-weight:900;padding:1px 7px;border-radius:8px;">0</span>
                </div>
                <div style="display:flex;gap:6px;">
                    <button onclick="markAllRead()" style="font-size:10px;font-weight:700;color:rgba(255,255,255,.6);background:rgba(255,255,255,.1);border:none;border-radius:7px;padding:4px 8px;cursor:pointer;">Mark all read</button>
                    <button onclick="closeNotifPanel()" style="width:26px;height:26px;background:rgba(255,255,255,.1);border:none;border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                        <svg width="11" height="11" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- Summary counters -->
            <div style="display:flex;gap:6px;">
                <div style="flex:1;background:rgba(245,158,11,.2);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:8px;text-align:center;">
                    <div id="np-task-num" style="font-size:22px;font-weight:900;color:#fbbf24;line-height:1;">0</div>
                    <div style="font-size:9px;font-weight:700;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;">Pending Tasks</div>
                </div>
                <div style="flex:1;background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:8px;text-align:center;">
                    <div id="np-rem-num" style="font-size:22px;font-weight:900;color:#f87171;line-height:1;">0</div>
                    <div style="font-size:9px;font-weight:700;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;">Upcoming Rem.</div>
                </div>
                <div style="flex:1;background:rgba(99,102,241,.2);border:1px solid rgba(99,102,241,.3);border-radius:10px;padding:8px;text-align:center;">
                    <div id="np-saved-num" style="font-size:22px;font-weight:900;color:#818cf8;line-height:1;">0</div>
                    <div style="font-size:9px;font-weight:700;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;">Saved Today</div>
                </div>
            </div>
        </div>

        <!-- Filter tabs -->
        <div style="display:flex;gap:4px;padding:8px 10px;border-bottom:1px solid #f1f5f9;flex-shrink:0;background:#fafafa;">
            <button class="nf-btn active" data-nf="all">All</button>
            <button class="nf-btn" data-nf="task">‚úÖ Tasks</button>
            <button class="nf-btn" data-nf="reminder">‚è∞ Reminder</button>
            <button class="nf-btn" data-nf="notebook">üìì Notes</button>
            <button class="nf-btn" data-nf="case">üìÇ Cases</button>
        </div>

        <!-- List -->
        <div id="notif-list" style="flex:1;overflow-y:auto;padding:8px;">
            <div id="notif-empty" style="text-align:center;padding:50px 20px;color:#94a3b8;">
                <div style="font-size:38px;margin-bottom:8px;">üîî</div>
                <div style="font-weight:700;font-size:13px;">Abhi koi notification nahi</div>
                <div style="font-size:11px;margin-top:4px;color:#cbd5e1;">Task ya reminder add hone pe yahan dikhega</div>
            </div>
        </div>

        <!-- Browser push permission bar -->
        <div id="push-bar">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="#d97706" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            <span id="push-bar-text" style="flex:1;font-size:11px;font-weight:600;color:#92400e;">PC/Mobile par auto-notifications enable karein</span>
            <button id="enable-push-btn" style="font-size:10px;font-weight:800;background:#f59e0b;color:#fff;border:none;border-radius:8px;padding:5px 10px;cursor:pointer;">Enable</button>
        </div>
    </div>

</body>
</html>
