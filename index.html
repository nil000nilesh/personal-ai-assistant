<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-btn.active { background-color: #1e293b; color: white; border-left: 4px solid #3b82f6; }
        .tab-btn-mob.active { color: #3b82f6; font-weight: bold; border-bottom: 3px solid #3b82f6; }
        
        /* Mic Recording Animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-[100dvh] overflow-hidden flex flex-col">

    <div id="login-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="p-8 bg-white rounded-2xl shadow-2xl text-center max-w-sm w-full border border-gray-100">
            <h1 class="text-3xl font-extrabold mb-2 text-slate-800">My AI</h1>
            <p class="text-gray-500 mb-8 text-sm">Your Personal Assistant</p>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="pin-screen" class="hidden absolute inset-0 z-50 flex-col items-center justify-center bg-slate-900 text-white">
        <h2 class="text-2xl mb-6 font-semibold">Enter Security PIN</h2>
        <input type="password" id="pin-input" maxlength="4" class="bg-slate-800 border-2 border-slate-700 p-4 text-center text-4xl tracking-[0.5em] text-white rounded-xl mb-6 w-56 outline-none focus:border-blue-500 transition-colors" />
        <button id="verify-pin-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-3 rounded-xl shadow-lg font-medium transition-all">Unlock</button>
    </div>

    <div id="api-key-screen" class="hidden absolute inset-0 z-50 flex-col items-center justify-center bg-white px-4">
        <h2 class="text-2xl mb-2 font-bold text-slate-800">API Key Setup</h2>
        <p class="text-gray-500 mb-6 text-center max-w-sm text-sm">Please provide your OpenAI API Key once to securely save it in the database.</p>
        <input type="password" id="api-key-input" class="border-2 border-gray-300 p-3 rounded-xl mb-4 w-full max-w-md outline-none focus:border-blue-500" placeholder="sk-proj-..." />
        <button id="save-key-btn" class="bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-xl font-medium w-full max-w-md transition-all">Save Securely</button>
    </div>

    <div id="app-layout" class="hidden flex-1 flex-col md:flex-row w-full h-full bg-white relative">
        
        <nav class="hidden md:flex flex-col w-64 bg-slate-900 text-slate-300 shadow-2xl z-20">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-2xl font-bold text-white tracking-wide">My AI</h1>
            </div>
            <div class="flex-1 py-4 flex flex-col gap-1 px-3">
                <button id="tab-chat-desk" class="tab-btn active px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    Assistant
                </button>
                <button id="tab-notes-desk" class="tab-btn px-4 py-3 rounded-lg text-left font-medium transition-all flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    Notebook
                </button>
            </div>
            <div class="p-4 border-t border-slate-800">
                <button id="logout-btn-desk" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-500 px-4 py-2 rounded-lg font-medium transition-colors text-sm">Log Out</button>
            </div>
        </nav>

        <main class="flex-1 relative bg-gray-50 flex flex-col h-full overflow-hidden">
            
            <header class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-10">
                <h1 class="text-lg font-bold">My AI</h1>
                <button id="logout-btn-mob" class="text-xs bg-slate-800 px-3 py-1.5 rounded text-slate-300">Logout</button>
            </header>

            <div id="view-chat" class="absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 flex flex-col scroll-smooth">
                    </div>
                <div class="p-3 md:p-4 bg-white border-t border-gray-200 shadow-[0_-4px_15px_rgba(0,0,0,0.02)] z-10">
                    <div class="max-w-4xl mx-auto flex gap-2 items-center">
                        <button id="mic-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-3 md:p-4 rounded-xl transition-all outline-none" title="Click to Speak">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                        <input type="text" id="user-input" class="flex-1 bg-gray-100 border-transparent focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-3 md:p-4 rounded-xl text-black outline-none transition-all" placeholder="Type or speak your message..." />
                        <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-medium shadow-md transition-transform active:scale-95">Send</button>
                    </div>
                </div>
            </div>

            <div id="view-notes" class="hidden absolute inset-0 md:top-0 top-[60px] md:bottom-0 bottom-[60px] flex-col bg-gray-50 p-4 md:p-8 overflow-y-auto">
                <div class="max-w-6xl mx-auto w-full">
                    <h2 class="text-3xl font-bold mb-2 text-slate-800">Notebook</h2>
                    <p class="text-gray-500 mb-8 text-sm">AI automatically extracts and saves important points from your conversations here.</p>
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>
        </main>

        <nav class="md:hidden absolute bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center h-[60px] shadow-[0_-5px_10px_rgba(0,0,0,0.02)] z-20">
            <button id="tab-chat-mob" class="tab-btn-mob active flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-xs">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg> Chat
            </button>
            <button id="tab-notes-mob" class="tab-btn-mob flex-1 h-full flex flex-col items-center justify-center gap-1 text-gray-500 text-xs">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg> Notes
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // âœ… AAPKI FIREBASE KEYS AUR PIN DETAILS
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAeu14r8EACZ7U3eRszsNQmTYTFt5FndcU",
            authDomain: "ai-assistant-app-8e733.firebaseapp.com",
            projectId: "ai-assistant-app-8e733",
            storageBucket: "ai-assistant-app-8e733.firebasestorage.app",
            messagingSenderId: "318215944760",
            appId: "1:318215944760:web:2a387b7bcd068da4ff44cd",
            measurementId: "G-Z2P76L8MHF"
        };
        const SECRET_PIN = "5786"; 
        const ALLOWED_EMAIL = "nil000nilesh@gmail.com";
        // ==========================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        let chatHistory = [];
        let isPinVerified = false;
        let DYNAMIC_OPENAI_KEY = "";

        const ui = {
            login: document.getElementById('login-screen'),
            pin: document.getElementById('pin-screen'),
            apiKey: document.getElementById('api-key-screen'),
            appLayout: document.getElementById('app-layout'),
            viewChat: document.getElementById('view-chat'),
            viewNotes: document.getElementById('view-notes'),
            chatBox: document.getElementById('chat-box'),
            notesGrid: document.getElementById('notes-grid'),
            userInput: document.getElementById('user-input'),
            micBtn: document.getElementById('mic-btn')
        };

        function hideAllStates() {
            ui.login.classList.add('hidden');
            ui.pin.classList.add('hidden');
            ui.apiKey.classList.add('hidden');
            ui.appLayout.classList.add('hidden');
        }

        function switchView(view) {
            if (view === 'chat') {
                ui.viewChat.classList.remove('hidden'); ui.viewChat.classList.add('flex');
                ui.viewNotes.classList.add('hidden'); ui.viewNotes.classList.remove('flex');
                document.getElementById('tab-chat-desk').classList.add('active'); document.getElementById('tab-notes-desk').classList.remove('active');
                document.getElementById('tab-chat-mob').classList.add('active'); document.getElementById('tab-notes-mob').classList.remove('active');
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            } else {
                ui.viewNotes.classList.remove('hidden'); ui.viewNotes.classList.add('flex');
                ui.viewChat.classList.add('hidden'); ui.viewChat.classList.remove('flex');
                document.getElementById('tab-notes-desk').classList.add('active'); document.getElementById('tab-chat-desk').classList.remove('active');
                document.getElementById('tab-notes-mob').classList.add('active'); document.getElementById('tab-chat-mob').classList.remove('active');
            }
        }

        document.getElementById('tab-chat-desk').addEventListener('click', () => switchView('chat'));
        document.getElementById('tab-notes-desk').addEventListener('click', () => switchView('notes'));
        document.getElementById('tab-chat-mob').addEventListener('click', () => switchView('chat'));
        document.getElementById('tab-notes-mob').addEventListener('click', () => switchView('notes'));

        onAuthStateChanged(auth, (user) => {
            hideAllStates();
            if (user && user.email === ALLOWED_EMAIL) {
                if (!isPinVerified) { ui.pin.classList.remove('hidden'); ui.pin.classList.add('flex'); } 
                else { checkAndLoadApp(); }
            } else if (user) {
                alert("Unauthorized access! Logging out."); signOut(auth);
            } else { ui.login.classList.remove('hidden'); }
        });

        const doLogout = () => { isPinVerified = false; DYNAMIC_OPENAI_KEY = ""; signOut(auth); };
        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('logout-btn-desk').addEventListener('click', doLogout);
        document.getElementById('logout-btn-mob').addEventListener('click', doLogout);

        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            if (document.getElementById('pin-input').value === SECRET_PIN) {
                isPinVerified = true; checkAndLoadApp();
            } else { alert("Incorrect PIN"); document.getElementById('pin-input').value = ""; }
        });

        async function checkAndLoadApp() {
            hideAllStates();
            try {
                const keyDoc = await getDoc(doc(db, "system_settings", "api_config"));
                if (keyDoc.exists() && keyDoc.data().openai_key) {
                    DYNAMIC_OPENAI_KEY = keyDoc.data().openai_key;
                    ui.appLayout.classList.remove('hidden'); ui.appLayout.classList.add('flex');
                    loadChatAndNotes();
                } else {
                    ui.apiKey.classList.remove('hidden'); ui.apiKey.classList.add('flex');
                }
            } catch (error) { alert("Database connection failed. Check permissions."); }
        }

        document.getElementById('save-key-btn').addEventListener('click', async () => {
            const newKey = document.getElementById('api-key-input').value.trim();
            if (!newKey.startsWith("sk-")) return alert("Invalid API key format.");
            try {
                await setDoc(doc(db, "system_settings", "api_config"), { openai_key: newKey });
                DYNAMIC_OPENAI_KEY = newKey;
                ui.appLayout.classList.remove('hidden'); ui.appLayout.classList.add('flex');
                ui.apiKey.classList.add('hidden');
                loadChatAndNotes();
            } catch (error) { alert("Failed to save key. Check Firestore rules."); }
        });

        function loadChatAndNotes() {
            onSnapshot(query(collection(db, "chats"), orderBy("timestamp", "asc")), (snapshot) => {
                chatHistory = []; ui.chatBox.innerHTML = ""; 
                snapshot.forEach((docData) => {
                    const msg = docData.data();
                    chatHistory.push({ role: msg.role, content: msg.content });
                    renderMessage(msg.role, msg.content);
                });
                ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
            });

            onSnapshot(query(collection(db, "notes"), orderBy("timestamp", "desc")), (snapshot) => {
                ui.notesGrid.innerHTML = "";
                snapshot.forEach((docData) => {
                    const note = docData.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3 hover:shadow-md transition-shadow relative overflow-hidden group";
                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <h3 class="font-bold text-slate-800 text-lg border-b border-gray-100 pb-2">${note.title}</h3>
                        <p class="text-gray-600 text-sm flex-1 whitespace-pre-wrap leading-relaxed">${note.content}</p>
                        <span class="text-xs text-gray-400 mt-2 font-medium">${new Date(note.timestamp).toLocaleDateString()}</span>
                    `;
                    ui.notesGrid.appendChild(card);
                });
            });
        }

        function renderMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-2xl max-w-[85%] md:max-w-[75%] text-sm md:text-base leading-relaxed ${
                role === 'user' ? 'bg-blue-600 text-white rounded-br-sm shadow-md' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-sm shadow-sm'
            }`;
            bubble.textContent = content;
            div.appendChild(bubble);
            ui.chatBox.appendChild(div);
        }

        // ==========================================
        // ðŸŽ¤ VOICE RECOGNITION (Speech-to-Text)
        // ==========================================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';

            recognition.onstart = () => {
                isRecording = true;
                ui.micBtn.classList.add('recording');
                ui.userInput.placeholder = "Listening...";
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        ui.userInput.value += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };

            recognition.onend = () => {
                isRecording = false;
                ui.micBtn.classList.remove('recording');
                ui.userInput.placeholder = "Type or speak your message...";
            };

            ui.micBtn.addEventListener('click', () => {
                if (isRecording) { recognition.stop(); } 
                else { recognition.start(); }
            });
        } else {
            ui.micBtn.style.display = 'none';
            console.log("Speech Recognition API not supported in this browser.");
        }

        // ==========================================
        // ðŸ§  AI COMMUNICATION & SMART NOTES LOGIC
        // ==========================================
        async function sendMessage() {
            const text = ui.userInput.value.trim();
            if (!text || !DYNAMIC_OPENAI_KEY) return;

            ui.userInput.value = "";
            const userMsg = { role: "user", content: text, timestamp: new Date().toISOString() };
            await addDoc(collection(db, "chats"), userMsg);

            const loadingId = "loading-" + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = "text-blue-500 text-sm ml-2 font-medium animate-pulse";
            loadingDiv.textContent = "Assistant is typing...";
            ui.chatBox.appendChild(loadingDiv);
            ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

            try {
                const systemPrompt = {
                    role: "system",
                    content: `You are an intelligent personal AI assistant for Nilesh, a Credit Manager at Bank of Baroda. Help him with daily planning, tasks, and bank proposals (like checking Udyam/Shop act for Vinod Mali). 
                    IMPORTANT RULE FOR AUTO-NOTES: You must independently analyze if Nilesh's message contains important information worth remembering (like loan proposal details, meeting schedules, or project ideas). 
                    If it is important, silently save it to the notebook by appending this exact format at the very end of your response: [NOTE: Title || Content].
                    For example, if he says 'I have a meeting tomorrow regarding the new branch', you reply normally, and at the end append '[NOTE: New Branch Meeting || Scheduled for tomorrow]'. Do not ask for permission to save it.`
                };

                const apiMessages = [systemPrompt, ...chatHistory, { role: "user", content: text }];

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${DYNAMIC_OPENAI_KEY}` },
                    body: JSON.stringify({ model: "gpt-3.5-turbo", messages: apiMessages })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let aiReply = data.choices[0].message.content;

                const noteRegex = /\[NOTE:\s*(.*?)\s*\|\|\s*(.*?)\]/g;
                let match;
                while ((match = noteRegex.exec(aiReply)) !== null) {
                    await addDoc(collection(db, "notes"), { title: match[1].trim(), content: match[2].trim(), timestamp: new Date().toISOString() });
                }

                const cleanReply = aiReply.replace(noteRegex, '').trim();
                await addDoc(collection(db, "chats"), { role: "assistant", content: cleanReply, timestamp: new Date().toISOString() });

            } catch (error) { alert("Error: " + error.message); } 
            finally { document.getElementById(loadingId)?.remove(); }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
